<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>第 3 章 阿里云</title><link rel="stylesheet" type="text/css" href="../docbook.css" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><link rel="home" href="../index.html" title="Netkiller Architect 手札" /><link rel="up" href="index.html" title="部分 I. 云计算" /><link rel="prev" href="index.html" title="部分 I. 云计算" /><link rel="next" href="RDS.html" title="3.2. RDS MySQL" /></head><body><a xmlns="" href="//www.netkiller.cn/">Home</a> |
		<a xmlns="" href="//netkiller.github.io/">简体中文</a> |
	    <a xmlns="" href="http://netkiller.sourceforge.net/">繁体中文</a> |
	    <a xmlns="" href="/journal/index.html">杂文</a> |
	    <a xmlns="" href="https://zhuanlan.zhihu.com/netkiller">知乎专栏</a> |
   	    <a xmlns="" href="https://edu.51cto.com/lecturer/1703915.html">51CTO学院</a> |
	    <a xmlns="" href="https://edu.csdn.net/lecturer/6423">CSDN程序员研修院</a> |
	    <a xmlns="" href="https://github.com/netkiller">Github</a> |
	    <a xmlns="" href="http://my.oschina.net/neochen/">OSChina 博客</a> |
	    <a xmlns="" href="https://cloud.tencent.com/developer/column/2078">腾讯云社区</a> |
	    <a xmlns="" href="https://yq.aliyun.com/u/netkiller/">阿里云栖社区</a> |
	    <a xmlns="" href="https://www.facebook.com/bg7nyt">Facebook</a> |
	    <a xmlns="" href="http://cn.linkedin.com/in/netkiller/">Linkedin</a> |
	    <a xmlns="" href="https://www.youtube.com/user/bg7nyt/videos">Youtube</a> |
	    <a xmlns="" href="//www.netkiller.cn/home/donations.html">打赏(Donations)</a> |
	    <a xmlns="" href="//www.netkiller.cn/home/about.html">About</a><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">第 3 章 阿里云</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="index.html">上一页</a> </td><th width="60%" align="center">部分 I. 云计算</th><td width="20%" align="right"> <a accesskey="n" href="RDS.html">下一页</a></td></tr></table><hr /></div><table xmlns=""><tr><td><iframe src="//ghbtns.com/github-btn.html?user=netkiller&amp;repo=netkiller.github.io&amp;type=watch&amp;count=true&amp;size=large" height="30" width="170" frameborder="0" scrolling="0" style="width:170px; height: 30px;" allowTransparency="true"></iframe></td><td><iframe src="//ghbtns.com/github-btn.html?user=netkiller&amp;repo=netkiller.github.io&amp;type=fork&amp;count=true&amp;size=large" height="30" width="170" frameborder="0" scrolling="0" style="width:170px; height: 30px;" allowTransparency="true"></iframe></td><td><iframe src="//ghbtns.com/github-btn.html?user=netkiller&amp;type=follow&amp;count=true&amp;size=large" height="30" width="240" frameborder="0" scrolling="0" style="width:240px; height: 30px;" allowTransparency="true"></iframe></td><td></td><td><a href="https://zhuanlan.zhihu.com/netkiller"><img src="/images/logo/zhihu-card-default.svg" height="25" /></a></td><td valign="middle"><a href="https://zhuanlan.zhihu.com/netkiller">知乎专栏</a> ｜ <a href="https://www.zhihu.com/club/1241768772601950208">多维度架构</a></td><td></td><td></td><td></td><td></td></tr></table><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="idm517390628272"></a>第 3 章 阿里云</h2></div></div></div><div class="toc"><p><strong>目录</strong></p><dl class="toc"><dt><span class="section"><a href="ch03.html#ECS">3.1. ECS</a></span></dt><dd><dl><dt><span class="section"><a href="ch03.html#idm517390625760">3.1.1. Rocky Linux 镜像</a></span></dt><dd><dl><dt><span class="section"><a href="ch03.html#idm517390625088">3.1.1.1. 阿里云 Rocky Linux 镜像初始化</a></span></dt><dt><span class="section"><a href="ch03.html#idm517451692144">3.1.1.2. Python 环境</a></span></dt><dt><span class="section"><a href="ch03.html#idm517451690928">3.1.1.3. 阿里云平台 Rocky Linux 系统 BUG</a></span></dt><dt><span class="section"><a href="ch03.html#idm517451690800">3.1.1.4. 开启交换分区</a></span></dt><dt><span class="section"><a href="ch03.html#idm517451684608">3.1.1.5. 启用 rc.local</a></span></dt></dl></dd><dt><span class="section"><a href="ch03.html#idm517451671872">3.1.2. 阿里云 AlmaLinux 9.0 镜像初始化</a></span></dt><dt><span class="section"><a href="ch03.html#idm517451671616">3.1.3. CentOS 8.4 初始化</a></span></dt><dt><span class="section"><a href="ch03.html#idm517451663264">3.1.4. 阿里云 Ubuntu 16.04.7 LTS 镜像 cron.daily 不执行 BUG 排除过程</a></span></dt></dl></dd><dt><span class="section"><a href="RDS.html">3.2. RDS MySQL</a></span></dt><dd><dl><dt><span class="section"><a href="RDS.html#idm517451651184">3.2.1. RDS MySQL =&gt; 本地 MySQL 数据库</a></span></dt><dd><dl><dt><span class="section"><a href="RDS.html#idm517451649488">3.2.1.1. MySQL 5.7</a></span></dt><dt><span class="section"><a href="RDS.html#idm517451649360">3.2.1.2. MySQL 8.0</a></span></dt></dl></dd><dt><span class="section"><a href="RDS.html#idm517451639056">3.2.2. 换表升级</a></span></dt></dl></dd><dt><span class="section"><a href="日志服务.html">3.3. 日志服务</a></span></dt><dd><dl><dt><span class="section"><a href="日志服务.html#idm517451635344">3.3.1. SLB 日志</a></span></dt><dd><dl><dt><span class="section"><a href="日志服务.html#idm517451634544">3.3.1.1. IP 地址查看</a></span></dt><dt><span class="section"><a href="日志服务.html#idm517451633056">3.3.1.2. Top 100 IP 地址</a></span></dt><dt><span class="section"><a href="日志服务.html#idm517451631712">3.3.1.3. 统计 GET/POST/PUT/DELETE/HEAD/OPTIONS</a></span></dt><dt><span class="section"><a href="日志服务.html#idm517451630240">3.3.1.4. 分析接口请求时间</a></span></dt><dt><span class="section"><a href="日志服务.html#idm517451628816">3.3.1.5. TOP 20 URL</a></span></dt><dt><span class="section"><a href="日志服务.html#idm517451626816">3.3.1.6. QPS</a></span></dt></dl></dd><dt><span class="section"><a href="日志服务.html#idm517451625392">3.3.2. Kubernetes 日志</a></span></dt><dt><span class="section"><a href="日志服务.html#idm517451624592">3.3.3. Aliyun LOG Java Producer</a></span></dt></dl></dd></dl></div>
	
	<p>时代变了！！！今局面是云计算全面替代自建IDC的时代，所以必须将云计算单列一个章节，严肃对待。</p>
	
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ECS"></a>3.1. ECS</h2></div></div></div>
	
	<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="idm517390625760"></a>3.1.1. Rocky Linux 镜像</h3></div></div></div>
		
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm517390625088"></a>3.1.1.1. 阿里云 Rocky Linux 镜像初始化</h4></div></div></div>
			
			<p>首次安装后初始化系统</p>
			<pre class="screen">
		 
cp /etc/dnf/dnf.conf{,.original} 
echo "fastestmirror=true" &gt;&gt; /etc/dnf/dnf.conf
dnf makecache 
		
			</pre>
			<p>Extra Packages for Enterprise Linux repository configuration
			</p>
			<pre class="screen">
			
dnf -y upgrade
dnf -y install epel-release
			
			</pre>
			<p>管理员常用工具</p>
			<pre class="screen">
			
dnf install -y bzip2 tree psmisc \
telnet wget rsync vim-enhanced \
net-tools bind-utils			
			
			</pre>
			<p>设置终端字符集（这样对 macOS 更友好），还可以解决 Failed to set locale, defaulting
				to C.UTF-8 问题
			</p>
			<pre class="screen">
			
dnf install -y langpacks-en glibc-langpack-en
localectl set-locale LANG=en_US.UTF-8

cat &gt;&gt; /etc/environment &lt;&lt;EOF
LC_ALL=en_US.UTF-8
LANG=en_US.UTF-8
LC_CTYPE=UTF-8
EOF
			
			</pre>
			
			<p>设置历史记录格式，可以看到命令的执行时间</p>
			<pre class="screen">
						
cat &gt;&gt; /etc/profile.d/history.sh &lt;&lt;EOF
# Administrator specific aliases and functions for system security
export HISTSIZE=10000
export HISTFILESIZE=10000
export HISTTIMEFORMAT="%Y-%m-%d %H:%M:%S "
export TIME_STYLE=long-iso
EOF

source /etc/profile.d/history.sh
			
			</pre>
			<p>sysctl 优化</p>
			<pre class="screen">
			
cat &gt;&gt; /etc/sysctl.conf &lt;&lt;EOF

# add by netkiller
net.ipv4.ip_local_port_range = 10000 65500
net.core.somaxconn = 1024

# TCP BBR
net.core.default_qdisc=fq
net.ipv4.tcp_congestion_control=bbr
EOF

sysctl -p			
			
			</pre>
			<p>确认 ulimit 已经优化</p>
			<pre class="screen">
			
# grep "^*" /etc/security/limits.conf
* soft nofile 65535
* hard nofile 65535	
			
			</pre>
			<p>设置时区</p>
			<pre class="screen">
			
timedatectl set-timezone Asia/Shanghai			
			
			</pre>
			<p>确认时间同步服务器 chronyd 工作正常</p>
			<pre class="screen">
			
systemctl status chronyd
			
			</pre>
			<p>zmodem 用来上传和下载文件（注意 macOS 的 Terminal.app 不支持）</p>
			<pre class="screen">
			
dnf install -y lrzsz			
			
			</pre>
			<p>优化 SSH</p>
			<pre class="screen">
			
cp /etc/ssh/sshd_config{,.original}

vim /etc/ssh/sshd_config &lt;&lt;EOF &gt; /dev/null 2&gt;&amp;1
:43,43s/PermitRootLogin yes/PermitRootLogin no/
:84,84s/GSSAPIAuthentication yes/GSSAPIAuthentication no/
:99,99s/#AllowTcpForwarding yes/AllowTcpForwarding no/
:106,106/X11Forwarding yes/X11Forwarding no/
:116,116s/#TCPKeepAlive yes/TCPKeepAlive yes/
:121,121s/#UseDNS no/UseDNS no/
:wq
EOF
			
			</pre>
			<p>禁止 root 登陆，开启 sudo</p>
			<p>禁用普通用户，我们需要一个普通用户登陆，然后使用 sudo 暂时获得 root 权限，我不打算新建一个用户，发现系统里面内置了
				operator 这个操作员用户符合我的需求。
			</p>
			<pre class="screen">
			
usermod -s /bin/bash -aG wheel operator

PASSWORD=$(cat /dev/urandom | tr -dc [:alnum:] | head -c 32)

echo operator:${PASSWORD} | chpasswd
echo "operator password: ${PASSWORD}"			
			
			</pre>
			<p>将 /usr/local/sbin:/usr/local/bin 路径加入到 Defaults secure_path =
				/sbin:/bin:/usr/sbin:/usr/bin，否则sudo找不到
				/usr/local/sbin:/usr/local/bin 中的可执行文件。
			</p>
			<pre class="screen">
			
sed -i "s/#PermitRootLogin yes/PermitRootLogin no/" /etc/ssh/sshd_config
systemctl restart sshd
			
cp /etc/sudoers{,.original}

sed -i '88s#$#:/usr/local/sbin:/usr/local/bin#' /etc/sudoers

visudo -c
			
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm517451692144"></a>3.1.1.2. Python 环境</h4></div></div></div>
			
			<pre class="screen">
		
dnf remove -y python36
dnf install -y python39		
		
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm517451690928"></a>3.1.1.3. 阿里云平台 Rocky Linux 系统 BUG</h4></div></div></div>
			
			<p>系统更新链接不上</p>
			<pre class="screen">
		
[root@cloud ~]# dnf upgrade -y
Last metadata expiration check: 0:15:31 ago on Mon 28 Mar 2022 03:49:10 PM CST.
Dependencies resolved.
====================================================================================================
 Package                         Architecture Version                  Repository              Size
====================================================================================================
Upgrading:
 containerd.io                   x86_64       1.5.11-3.1.el8           docker-ce-stable        29 M
 docker-ce                       x86_64       3:20.10.14-3.el8         docker-ce-stable        22 M
 docker-ce-cli                   x86_64       1:20.10.14-3.el8         docker-ce-stable        30 M
 docker-ce-rootless-extras       x86_64       20.10.14-3.el8           docker-ce-stable       4.6 M
 epel-release                    noarch       8-15.el8                 epel                    23 k
 tzdata                          noarch       2022a-1.el8              baseos                 473 k
 tzdata-java                     noarch       2022a-1.el8              appstream              190 k

Transaction Summary
====================================================================================================
Upgrade  7 Packages

Total download size: 86 M
Downloading Packages:
[MIRROR] tzdata-2022a-1.el8.noarch.rpm: Status code: 404 for https://www.netkiller.cn/rockylinux/8/BaseOS/x86_64/os/Packages/t/tzdata-2022a-1.el8.noarch.rpm (IP: 139.196.170.132)
[MIRROR] tzdata-java-2022a-1.el8.noarch.rpm: Status code: 404 for https://www.netkiller.cn/rockylinux/8/AppStream/x86_64/os/Packages/t/tzdata-java-2022a-1.el8.noarch.rpm (IP: 139.196.170.132)
[MIRROR] tzdata-2022a-1.el8.noarch.rpm: Status code: 404 for https://www.netkiller.cn/rockylinux/8/BaseOS/x86_64/os/Packages/t/tzdata-2022a-1.el8.noarch.rpm (IP: 139.196.170.132)
[MIRROR] tzdata-java-2022a-1.el8.noarch.rpm: Status code: 404 for https://www.netkiller.cn/rockylinux/8/AppStream/x86_64/os/Packages/t/tzdata-java-2022a-1.el8.noarch.rpm (IP: 139.196.170.132)
[MIRROR] tzdata-2022a-1.el8.noarch.rpm: Status code: 404 for https://www.netkiller.cn/rockylinux/8/BaseOS/x86_64/os/Packages/t/tzdata-2022a-1.el8.noarch.rpm (IP: 139.196.170.132)
[MIRROR] tzdata-java-2022a-1.el8.noarch.rpm: Status code: 404 for https://www.netkiller.cn/rockylinux/8/AppStream/x86_64/os/Packages/t/tzdata-java-2022a-1.el8.noarch.rpm (IP: 139.196.170.132)
[MIRROR] tzdata-2022a-1.el8.noarch.rpm: Status code: 404 for https://www.netkiller.cn/rockylinux/8/BaseOS/x86_64/os/Packages/t/tzdata-2022a-1.el8.noarch.rpm (IP: 139.196.170.132)
[FAILED] tzdata-2022a-1.el8.noarch.rpm: No more mirrors to try - All mirrors were already tried without success
(2-3/7): tzdata-java-2022a-1.e  0% [                              ] 943 kB/s | 792 kB     01:32 ETA
The downloaded packages were saved in cache until the next successful transaction.
You can remove cached packages by executing 'dnf clean packages'.
Error: Error downloading packages:
  Cannot download Packages/t/tzdata-2022a-1.el8.noarch.rpm: All mirrors were tried		
		
			</pre>
			<p>查找原因后发现, mirrorlist 被禁用了。</p>
			<pre class="screen">
		
[root@cloud ~]# cat /etc/yum.repos.d/Rocky-BaseOS.repo 
# Rocky-BaseOS.repo
#
# The mirrorlist system uses the connecting IP address of the client and the
# update status of each mirror to pick current mirrors that are geographically
# close to the client.  You should use this for Rocky updates unless you are
# manually picking other mirrors.
#
# If the mirrorlist does not work for you, you can try the commented out
# baseurl line instead.

[baseos]
name=Rocky Linux $releasever - BaseOS
#mirrorlist=https://mirrors.rockylinux.org/mirrorlist?arch=$basearch&amp;repo=BaseOS-$releasever
baseurl=http://mirrors.cloud.aliyuncs.com/rockylinux/$releasever/BaseOS/$basearch/os/
gpgcheck=1
enabled=1
countme=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-rockyofficial		
		
			</pre>
			<p>将 /etc/yum.repos.d/Rocky-BaseOS.repo 和
				/etc/yum.repos.d/Rocky-AppStream.repo 中的 mirrorlist 注释去掉，配置如下。
			</p>
			<pre class="screen">
		
[root@cloud ~]# cat /etc/yum.repos.d/Rocky-AppStream.repo 
# Rocky-AppStream.repo
#
# The mirrorlist system uses the connecting IP address of the client and the
# update status of each mirror to pick current mirrors that are geographically
# close to the client.  You should use this for Rocky updates unless you are
# manually picking other mirrors.
#
# If the mirrorlist does not work for you, you can try the commented out
# baseurl line instead.

[appstream]
name=Rocky Linux $releasever - AppStream
mirrorlist=https://mirrors.rockylinux.org/mirrorlist?arch=$basearch&amp;repo=AppStream-$releasever
baseurl=http://mirrors.cloud.aliyuncs.com/rockylinux/$releasever/AppStream/$basearch/os/
gpgcheck=1
enabled=1
countme=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-rockyofficial		
		
			</pre>
			<p>再次运行 dnf upgrade -y 顺利通过</p>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm517451690800"></a>3.1.1.4. 开启交换分区</h4></div></div></div>
			
			<p>开启交换分区</p>
			<pre class="screen">
			
dd if=/dev/zero of=/opt/memory.swap bs=1024M count=8
mkswap /opt/memory.swap
swapon /opt/memory.swap			
			
			</pre>
			<p>挂载交换分区</p>
			<pre class="screen">
			
挂在 swap 打开 /etc/fstab 文件编辑追加以下内容

/opt/memory.swap		swap		swap		default 0 0

编辑 /etc/sysctl.conf 修改 swap 利用率

vm.swappiness=80		
			
			</pre>
			<p>查看交换分区</p>
			<pre class="screen">
			
# 查看交换分区文件
[root@cloud ~]# swapon -s
Filename				Type		Size	Used	Priority
/opt/memory.swap  

# 查看使用率			
[root@cloud ~]# cat /proc/sys/vm/swappiness
0			
			
			</pre>
			<p>设置使用率</p>
			<pre class="screen">
			
[root@cloud ~]# sysctl vm.swappiness=80
vm.swappiness = 80
[root@cloud ~]# cat /proc/sys/vm/swappiness
80			
			
			</pre>
			<div class="example"><a id="idm517451680432"></a><p class="title"><strong>例 3.1. 开启交换分区</strong></p><div class="example-contents">
				
				<pre class="screen">
				
[root@cloud ~]# dd if=/dev/zero of=/opt/memory.swap bs=1024M count=8
8+0 records in
8+0 records out
8589934592 bytes (8.6 GB, 8.0 GiB) copied, 56.7535 s, 151 MB/s

[root@cloud ~]# chmod 600 /opt/memory.swap 

[root@cloud ~]# mkswap /opt/memory.swap
mkswap: /opt/memory.swap: warning: wiping old swap signature.
Setting up swapspace version 1, size = 8 GiB (8589930496 bytes)
no label, UUID=07fda341-e558-4a99-9f63-394ca2b34d5a

[root@cloud ~]# swapon /opt/memory.swap

[root@cloud ~]# swapon -s
Filename				Type		Size	Used	Priority
/opt/memory.swap                       	file    	8388604	12	-2

[root@cloud ~]# free -g
              total        used        free      shared  buff/cache   available
Mem:             30          21           1           0           7           8
Swap:             7           0           7				

[root@cloud ~]# cat /proc/sys/vm/swappiness
0
				
				</pre>
			</div></div><br class="example-break" />
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm517451684608"></a>3.1.1.5. 启用 rc.local</h4></div></div></div>
			
			<p>/etc/rc.local 是一个开机启动脚本</p>
			<pre class="screen">
		
[root@testing ~]# cat /etc/rc.local
#!/bin/bash
# THIS FILE IS ADDED FOR COMPATIBILITY PURPOSES
#
# It is highly advisable to create own systemd services or udev rules
# to run scripts during boot instead of using this file.
#
# In contrast to previous versions due to parallel execution during boot
# this script will NOT be run after all other services.
#
# Please note that you must run 'chmod +x /etc/rc.d/rc.local' to ensure
# that this script will be executed during boot.

touch /var/lock/subsys/local		
		
			</pre>
			<p>如果你想使用 rc.local 需要做如下配置</p>
			<p>rc-local.service 需要做如下配置</p>
			<pre class="screen">
			
cat &gt;&gt; /lib/systemd/system/rc-local.service &lt;&lt;EOF

[Install]
WantedBy=multi-user.target
EOF
			
			</pre>
			<p>配置执行权限</p>
			<pre class="screen">
		
[root@cloud ~]# ll /etc/rc.d/rc.local
-rw-r--r--. 1 root root 474 2022-03-15 23:59 /etc/rc.d/rc.local

[root@cloud ~]# chmod +x /etc/rc.d/rc.local 

[root@cloud ~]# ll /etc/rc.d/rc.local
-rwxr-xr-x. 1 root root 474 2022-03-15 23:59 /etc/rc.d/rc.local		
		
			</pre>
			<p>启动 rc-local</p>
			<pre class="screen">
		
[root@testing ~]# systemctl enable rc-local
Created symlink /etc/systemd/system/multi-user.target.wants/rc-local.service → /usr/lib/systemd/system/rc-local.service.

[root@testing ~]# systemctl start rc-local	

[root@testing ~]# systemctl status rc-local
● rc-local.service - /etc/rc.d/rc.local Compatibility
   Loaded: loaded (/usr/lib/systemd/system/rc-local.service; enabled; vendor preset: disabled)
   Active: active (exited) since Mon 2021-08-16 12:57:16 CST; 2s ago
     Docs: man:systemd-rc-local-generator(8)
  Process: 532000 ExecStart=/etc/rc.d/rc.local start (code=exited, status=0/SUCCESS)

Aug 16 12:57:16 testing systemd[1]: Starting /etc/rc.d/rc.local Compatibility...
Aug 16 12:57:16 testing systemd[1]: Started /etc/rc.d/rc.local Compatibility.	
		
			</pre>
		</div>
	</div>
	<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="idm517451671872"></a>3.1.2. 阿里云 AlmaLinux 9.0 镜像初始化</h3></div></div></div>
		
		<p>阿里云ECS购买之后建议对 AlmaLinux 做标准初始化配置</p>
		<pre class="screen">
		
dnf -y upgrade
dnf -y install epel-release
		
		</pre>
		<p>系统默认语言是中文</p>
		<pre class="screen">
		
[root@almilinux ~]# echo $LANG
zh_CN.UTF-8		
		
		</pre>
		<p>将其改为英文</p>
		<pre class="screen">
		
cat &gt;&gt; /etc/environment &lt;&lt;EOF
LC_ALL=en_US.UTF-8
LANG=en_US.UTF-8
LC_CTYPE=UTF-8
EOF		
		
		</pre>
		<p>设置历史记录格式，可以看到命令的执行时间</p>
		<pre class="screen">
						
cat &gt;&gt; /etc/profile.d/history.sh &lt;&lt;EOF
# Administrator specific aliases and functions for system security
export HISTSIZE=10000
export HISTFILESIZE=10000
export HISTTIMEFORMAT="%Y-%m-%d %H:%M:%S "
export TIME_STYLE=long-iso
EOF

source /etc/profile.d/history.sh
			
		</pre>
		<p>sysctl 优化</p>
		<pre class="screen">
			
cat &gt;&gt; /etc/sysctl.conf &lt;&lt;EOF

# add by netkiller
net.ipv4.ip_local_port_range = 1025 65500
net.core.somaxconn = 1024

# TCP BBR
net.core.default_qdisc=fq
net.ipv4.tcp_congestion_control=bbr
EOF

sysctl -p			
			
		</pre>
	</div>
	<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="idm517451671616"></a>3.1.3. CentOS 8.4 初始化</h3></div></div></div>
		
		<p>阿里云启动之后</p>
		<pre class="screen">
		
dnf -y upgrade
reboot
		
		</pre>
		<p></p>	
		<pre class="screen">
		
dnf install -y bzip2 tree psmisc \
telnet wget rsync vim-enhanced \
net-tools bind-utils

dnf install -y langpacks-en glibc-langpack-en
localectl set-locale LANG=en_US.UTF-8
cat &gt;&gt; /etc/environment &lt;&lt;EOF
LC_ALL=en_US.UTF-8
LANG=en_US.UTF-8
LC_CTYPE=UTF-8
EOF

cat &gt;&gt; /etc/profile.d/history.sh &lt;&lt;EOF
# Administrator specific aliases and functions for system security
export HISTSIZE=10000
export HISTFILESIZE=10000
export HISTTIMEFORMAT="%Y-%m-%d %H:%M:%S "
export TIME_STYLE=long-iso
EOF
source /etc/profile.d/history.sh


		
		</pre>
	</div>
	
	<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="idm517451663264"></a>3.1.4. 阿里云 Ubuntu 16.04.7 LTS 镜像 cron.daily 不执行 BUG 排除过程</h3></div></div></div>
		
		<p>/etc/cron.daily 下面任务不执行</p>
		<p>检查日志并无异常</p>
		<pre class="screen">
		
root@production:~# cat /var/log/syslog.1 | grep daily
Aug 24 11:59:01 production CRON[31423]: (root) CMD (   test -x /etc/cron.daily/popularity-contest &amp;&amp; /etc/cron.daily/popularity-contest --crond)
Aug 25 06:25:01 production CRON[23913]: (root) CMD (test -x /usr/sbin/anacron || ( cd / &amp;&amp; run-parts --report /etc/cron.daily ))		
		
		</pre>
		<p>/etc/crontab 配置无误</p>
		<pre class="screen">
		
root@production:~# cat /etc/crontab 
# /etc/crontab: system-wide crontab
# Unlike any other crontab you don't have to run the `crontab'
# command to install the new version when you edit this file
# and files in /etc/cron.d. These files also have username fields,
# that none of the other crontabs do.

SHELL=/bin/sh
PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin

# m h dom mon dow user	command
17 *	* * *	root    cd / &amp;&amp; run-parts --report /etc/cron.hourly
25 6	* * *	root	test -x /usr/sbin/anacron || ( cd / &amp;&amp; run-parts --report /etc/cron.daily )
47 6	* * 7	root	test -x /usr/sbin/anacron || ( cd / &amp;&amp; run-parts --report /etc/cron.weekly )
52 6	1 * *	root	test -x /usr/sbin/anacron || ( cd / &amp;&amp; run-parts --report /etc/cron.monthly )
#		
		
		</pre>
		<p>检查 /usr/sbin/anacron</p>
		<pre class="screen">
		
root@production:~# /usr/sbin/anacron
-bash: /usr/sbin/anacron: No such file or directory		
		
		</pre>
		<p>终于定位到问题了，很多云主机的镜像是经过裁剪的，这样是为了降低镜像的尺寸，但是裁剪过程中难免考虑不周。</p>
		<p>此故障出现在阿里云 Ubuntu 16.04.7 LTS 镜像中。</p>
		<pre class="screen">
		
root@production:~# cat /etc/issue
Ubuntu 16.04.7 LTS \n \l		
		
		</pre>
		<p>anacron 是用于协调 cron 的，cron 的设计是7*24小时工作的，对于很多非服务器晚上会关机，那么有些 cron 就会错过执行时间，anacron 就可以协调 cron 当开机后 anacron 会判断哪些计划任务被错过，并补救执行。显然对于7*24小时运行的服务器来说 anacron 并没有卵用，所以阿里云把它卸载掉，但并未考虑到会影响 cron 执行。</p>
		<p>解决方案，有两种：一、创建一个空文件，骗过 test -x /usr/sbin/anacron 命令。 二、修改 /etc/crontab 配置文件，去掉 test -x /usr/sbin/anacron ||。</p>
		<pre class="screen">
		
root@production:~# vim /etc/crontab 
root@production:~# cat /etc/crontab 
# /etc/crontab: system-wide crontab
# Unlike any other crontab you don't have to run the `crontab'
# command to install the new version when you edit this file
# and files in /etc/cron.d. These files also have username fields,
# that none of the other crontabs do.

SHELL=/bin/sh
PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin

# m h dom mon dow user	command
17 *	* * *	root    cd / &amp;&amp; run-parts --report /etc/cron.hourly
25 6	* * *	root	cd / &amp;&amp; run-parts --report /etc/cron.daily
47 6	* * 7	root	cd / &amp;&amp; run-parts --report /etc/cron.weekly
52 6	1 * *	root	cd / &amp;&amp; run-parts --report /etc/cron.monthly
#	
		
		</pre>
		<p>这是我最终修改后的版本，记得重启 cron 服务</p>
		<pre class="screen">
		
root@production:~# systemctl restart cron

root@production:~# systemctl status cron
● cron.service - Regular background program processing daemon
   Loaded: loaded (/lib/systemd/system/cron.service; enabled; vendor preset: enabled)
   Active: active (running) since Wed 2021-08-25 10:20:27 CST; 4s ago
     Docs: man:cron(8)
 Main PID: 29414 (cron)
    Tasks: 1
   Memory: 384.0K
      CPU: 1ms
   CGroup: /system.slice/cron.service
           └─29414 /usr/sbin/cron -f

Aug 25 10:20:27 production systemd[1]: Started Regular background program processing daemon.
Aug 25 10:20:27 production cron[29414]: (CRON) INFO (pidfile fd = 3)
Aug 25 10:20:27 production cron[29414]: (CRON) INFO (Skipping @reboot jobs -- not system startup)			
		
		</pre>
	</div>
</div>
	

	

</div><div xmlns="" id="SOHUCS"></div><script xmlns="" charset="utf-8" type="text/javascript" src="https://cy-cdn.kuaizhan.com/upload/changyan.js"></script><script xmlns="" type="text/javascript">
window.changyan.api.config({
appid: 'cyvwjQUG3',
conf: 'prod_ef966242df3d8b5acb1e0ee9fc01cafe'
});
</script><script xmlns="" type="text/javascript" id="clustrmaps" src="//cdn.clustrmaps.com/map_v2.js?u=r5HG&amp;d=9mi5r_kkDC8uxG8HuY3p4-2qgeeVypAK9vMD-2P6BYM"></script><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="index.html">上一页</a> </td><td width="20%" align="center"><a accesskey="u" href="index.html">上一级</a></td><td width="40%" align="right"> <a accesskey="n" href="RDS.html">下一页</a></td></tr><tr><td width="40%" align="left" valign="top">部分 I. 云计算 </td><td width="20%" align="center"><a accesskey="h" href="../index.html">起始页</a></td><td width="40%" align="right" valign="top"> 3.2. RDS MySQL</td></tr></table></div><script xmlns="">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-11694057-1', 'auto');
  ga('send', 'pageview');

</script><script xmlns="" async="async">
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?93967759a51cda79e49bf4e34d0b0f2c";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script xmlns="" async="async">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script></body></html>