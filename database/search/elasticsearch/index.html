<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>第 8 章 Elasticsearch</title><link rel="stylesheet" type="text/css" href="../../docbook.css" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><meta name="keywords" content="MySQL, PostgreSQL, Oracle, NoSQL, ER, TokyoCabinet/Tyrant, Memcache, Membase, Redis, Flare, Voldemort, LevelDB, MongoDB, GreenSQL, RDBMS, ORDBMS" /><link rel="home" href="../../index.html" title="Netkiller Database 手札" /><link rel="up" href="../index.html" title="部分 II. Search Engine" /><link rel="prev" href="../index.html" title="部分 II. Search Engine" /><link rel="next" href="document.html" title="8.2. 文档API" /></head><body><a xmlns="" href="//www.netkiller.cn/">Home</a> |
		<a xmlns="" href="//netkiller.github.io/">简体中文</a> |
	    <a xmlns="" href="http://netkiller.sourceforge.net/">繁体中文</a> |
	    <a xmlns="" href="/journal/index.html">杂文</a> |
	    <a xmlns="" href="https://zhuanlan.zhihu.com/netkiller">知乎专栏</a> |
   	    <a xmlns="" href="https://edu.51cto.com/lecturer/1703915.html">51CTO学院</a> |
	    <a xmlns="" href="https://edu.csdn.net/lecturer/6423">CSDN程序员研修院</a> |
	    <a xmlns="" href="https://github.com/netkiller">Github</a> |
	    <a xmlns="" href="http://my.oschina.net/neochen/">OSChina 博客</a> |
	    <a xmlns="" href="https://cloud.tencent.com/developer/column/2078">腾讯云社区</a> |
	    <a xmlns="" href="https://yq.aliyun.com/u/netkiller/">阿里云栖社区</a> |
	    <a xmlns="" href="https://www.facebook.com/bg7nyt">Facebook</a> |
	    <a xmlns="" href="http://cn.linkedin.com/in/netkiller/">Linkedin</a> |
	    <a xmlns="" href="https://www.youtube.com/user/bg7nyt/videos">Youtube</a> |
	    <a xmlns="" href="//www.netkiller.cn/home/donations.html">打赏(Donations)</a> |
	    <a xmlns="" href="//www.netkiller.cn/home/about.html">About</a><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">第 8 章 Elasticsearch</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="../index.html">上一页</a> </td><th width="60%" align="center">部分 II. Search Engine</th><td width="20%" align="right"> <a accesskey="n" href="document.html">下一页</a></td></tr></table><hr /></div><table xmlns=""><tr><td><iframe src="//ghbtns.com/github-btn.html?user=netkiller&amp;repo=netkiller.github.io&amp;type=watch&amp;count=true&amp;size=large" height="30" width="170" frameborder="0" scrolling="0" style="width:170px; height: 30px;" allowTransparency="true"></iframe></td><td><iframe src="//ghbtns.com/github-btn.html?user=netkiller&amp;repo=netkiller.github.io&amp;type=fork&amp;count=true&amp;size=large" height="30" width="170" frameborder="0" scrolling="0" style="width:170px; height: 30px;" allowTransparency="true"></iframe></td><td><iframe src="//ghbtns.com/github-btn.html?user=netkiller&amp;type=follow&amp;count=true&amp;size=large" height="30" width="240" frameborder="0" scrolling="0" style="width:240px; height: 30px;" allowTransparency="true"></iframe></td><td></td><td><a href="https://zhuanlan.zhihu.com/netkiller"><img src="/images/logo/zhihu-card-default.svg" height="25" /></a></td><td valign="middle"><a href="https://zhuanlan.zhihu.com/netkiller">知乎专栏</a> ｜ <a href="https://www.zhihu.com/club/1241768772601950208">多维度架构</a></td><td></td><td></td><td></td><td></td></tr></table><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="index"></a>第 8 章 Elasticsearch</h2></div></div></div><div class="toc"><p><strong>目录</strong></p><dl class="toc"><dt><span class="section"><a href="index.html#install">8.1. 安装 Elasticsearch</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#idm102627022816">8.1.1. 6.x 安装</a></span></dt><dt><span class="section"><a href="index.html#single">8.1.2. 单机模式 (适用于开发环境) 5.x </a></span></dt><dt><span class="section"><a href="index.html#cluster">8.1.3. Elasticsearch Cluster 5.x</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#loadbalance">8.1.3.1. 负载均衡配置</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#idm102627017168">8.1.4. docker-compose 安装</a></span></dt><dt><span class="section"><a href="index.html#idm102602867952">8.1.5. Kubernetes</a></span></dt><dt><span class="section"><a href="index.html#idm102602867312">8.1.6. netkiller-devops 编排 elasticsearch</a></span></dt><dt><span class="section"><a href="index.html#version">8.1.7. 安装指定版本的 Elasticsearch</a></span></dt><dt><span class="section"><a href="index.html#plugin">8.1.8. Plugin</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#elasticsearch-analysis-ik">8.1.8.1. elasticsearch-analysis-ik</a></span></dt><dt><span class="section"><a href="index.html#elasticsearch-analysis-pinyin">8.1.8.2. elasticsearch-analysis-pinyin</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#idm102602853216">8.1.9. Elastic Cloud on Kubernetes</a></span></dt><dt><span class="section"><a href="index.html#idm102602852832">8.1.10. 发现配置</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#idm102602850944">8.1.10.1. 即将废弃</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="document.html">8.2. 文档API</a></span></dt><dd><dl><dt><span class="section"><a href="document.html#quickstart">8.2.1. 快速上手</a></span></dt><dt><span class="section"><a href="document.html#put">8.2.2. 写入 PUT/POST</a></span></dt><dt><span class="section"><a href="document.html#get">8.2.3. 获取 GET</a></span></dt><dd><dl><dt><span class="section"><a href="document.html#idm102602841264">8.2.3.1. _source</a></span></dt></dl></dd><dt><span class="section"><a href="document.html#head">8.2.4. 检查记录是否存在</a></span></dt><dt><span class="section"><a href="document.html#delete">8.2.5. 删除 Delete</a></span></dt><dt><span class="section"><a href="document.html#param">8.2.6. 参数</a></span></dt><dd><dl><dt><span class="section"><a href="document.html#idm102602833952">8.2.6.1. pretty 格式化 json</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="search.html">8.3. 搜索</a></span></dt><dd><dl><dt><span class="section"><a href="search.html#query">8.3.1. URL 搜索</a></span></dt><dt><span class="section"><a href="search.html#search.page">8.3.2. 分页</a></span></dt></dl></dd><dt><span class="section"><a href="dsl.html">8.4. Query DSL</a></span></dt><dd><dl><dt><span class="section"><a href="dsl.html#match">8.4.1. match 匹配</a></span></dt><dt><span class="section"><a href="dsl.html#multi_match">8.4.2. multi_match 多字段匹配</a></span></dt><dt><span class="section"><a href="dsl.html#bool">8.4.3. Query bool 布尔条件</a></span></dt><dd><dl><dt><span class="section"><a href="dsl.html#idm102610690272">8.4.3.1. must</a></span></dt><dt><span class="section"><a href="dsl.html#idm102610688832">8.4.3.2. should</a></span></dt><dt><span class="section"><a href="dsl.html#idm102610686864">8.4.3.3. must_not</a></span></dt></dl></dd><dt><span class="section"><a href="dsl.html#filter">8.4.4. filter 过滤</a></span></dt><dt><span class="section"><a href="dsl.html#sort">8.4.5. sort 排序</a></span></dt><dt><span class="section"><a href="dsl.html#_source">8.4.6. _source</a></span></dt><dt><span class="section"><a href="dsl.html#highlight">8.4.7. highlight 高亮处理</a></span></dt></dl></dd><dt><span class="section"><a href="manager.html">8.5. 集群管理</a></span></dt><dd><dl><dt><span class="section"><a href="manager.html#health">8.5.1. 节点健康状态</a></span></dt><dt><span class="section"><a href="manager.html#nodes">8.5.2. 节点http状态</a></span></dt><dt><span class="section"><a href="manager.html#master">8.5.3. 查看master节点</a></span></dt><dt><span class="section"><a href="manager.html#shards">8.5.4. 查看索引的节点分布</a></span></dt><dt><span class="section"><a href="manager.html#idm102610673936">8.5.5. 索引的开启与关闭</a></span></dt><dd><dl><dt><span class="section"><a href="manager.html#idm102610673056">8.5.5.1. _open</a></span></dt><dt><span class="section"><a href="manager.html#idm102610670656">8.5.5.2. _close</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="elasticsearch-analysis-ik.html">8.6. 中文分词插件管理</a></span></dt><dd><dl><dt><span class="section"><a href="elasticsearch-analysis-ik.html#idm102610669264">8.6.1. 通过 elasticsearch-plugin 命令安装分词插件</a></span></dt><dt><span class="section"><a href="elasticsearch-analysis-ik.html#plugin.install">8.6.2. 手工安装插件</a></span></dt><dt><span class="section"><a href="elasticsearch-analysis-ik.html#plugin.index">8.6.3. 创建索引</a></span></dt><dt><span class="section"><a href="elasticsearch-analysis-ik.html#plugin.delete">8.6.4. 删除索引</a></span></dt><dt><span class="section"><a href="elasticsearch-analysis-ik.html#plugin.config">8.6.5. 配置索引分词插件</a></span></dt><dd><dl><dt><span class="section"><a href="elasticsearch-analysis-ik.html#idm102610661984">8.6.5.1. 测试分词效果</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="index.html">8.7. 索引管理</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#index.indices">8.7.1. 查看索引</a></span></dt><dt><span class="section"><a href="index.html#index.delete">8.7.2. 删除索引</a></span></dt></dl></dd><dt><span class="section"><a href="mapping.html">8.8. 映射</a></span></dt><dd><dl><dt><span class="section"><a href="mapping.html#mapping.get">8.8.1. 查看 _mapping</a></span></dt><dt><span class="section"><a href="mapping.html#mapping.delete">8.8.2. 删除 _mapping </a></span></dt><dt><span class="section"><a href="mapping.html#mapping.post">8.8.3. 创建 _mapping</a></span></dt><dt><span class="section"><a href="mapping.html#mapping.update">8.8.4. 更新 mapping</a></span></dt><dt><span class="section"><a href="mapping.html#mapping.change">8.8.5. 修改 _mapping</a></span></dt><dt><span class="section"><a href="mapping.html#type">8.8.6. 数据类型</a></span></dt><dd><dl><dt><span class="section"><a href="mapping.html#idm102610643680">8.8.6.1. date</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="alias.html">8.9. Alias management 别名管理</a></span></dt><dd><dl><dt><span class="section"><a href="alias.html#idm102610641504">8.9.1. 查看索引别名</a></span></dt><dt><span class="section"><a href="alias.html#idm102606327024">8.9.2. 创建索引别名</a></span></dt><dt><span class="section"><a href="alias.html#idm102606309408">8.9.3. 修改别名</a></span></dt><dt><span class="section"><a href="alias.html#idm102606308464">8.9.4. 删除别名</a></span></dt></dl></dd><dt><span class="section"><a href="example.html">8.10. Example</a></span></dt><dd><dl><dt><span class="section"><a href="example.html#idm102606307024">8.10.1. 新闻资讯应用案例</a></span></dt><dt><span class="section"><a href="example.html#idm102606306384">8.10.2. 文章搜索案例</a></span></dt></dl></dd><dt><span class="section"><a href="jdbc-input-plugin.html">8.11. Migrating MySQL Data into Elasticsearch using logstash</a></span></dt><dd><dl><dt><span class="section"><a href="jdbc-input-plugin.html#logstash.install">8.11.1. 安装 logstash</a></span></dt><dt><span class="section"><a href="jdbc-input-plugin.html#logstash.config">8.11.2. 配置 logstash</a></span></dt><dt><span class="section"><a href="jdbc-input-plugin.html#logstash.start">8.11.3. 启动 Logstash</a></span></dt><dt><span class="section"><a href="jdbc-input-plugin.html#logstash.test">8.11.4. 验证</a></span></dt><dt><span class="section"><a href="jdbc-input-plugin.html#logstash.template">8.11.5. 配置模板</a></span></dt><dd><dl><dt><span class="section"><a href="jdbc-input-plugin.html#idm102621015168">8.11.5.1. 全量导入</a></span></dt><dt><span class="section"><a href="jdbc-input-plugin.html#idm102621018592">8.11.5.2. 多表导入</a></span></dt><dt><span class="section"><a href="jdbc-input-plugin.html#idm102621029072">8.11.5.3. 通过 ID 主键字段增量复制数据</a></span></dt><dt><span class="section"><a href="jdbc-input-plugin.html#idm102621023184">8.11.5.4. 通过日期字段增量复制数据</a></span></dt><dt><span class="section"><a href="jdbc-input-plugin.html#idm102621037328">8.11.5.5. 指定SQL文件</a></span></dt><dt><span class="section"><a href="jdbc-input-plugin.html#idm102621040176">8.11.5.6. 参数传递</a></span></dt><dt><span class="section"><a href="jdbc-input-plugin.html#idm102621041536">8.11.5.7. 控制返回JDBC数据量</a></span></dt><dt><span class="section"><a href="jdbc-input-plugin.html#idm102621044256">8.11.5.8. 输出到不同的 Elasticsearch 中</a></span></dt><dt><span class="section"><a href="jdbc-input-plugin.html#idm102621047488">8.11.5.9. 日期格式转换</a></span></dt><dt><span class="section"><a href="jdbc-input-plugin.html#logstash.example">8.11.5.10. example</a></span></dt></dl></dd><dt><span class="section"><a href="jdbc-input-plugin.html#logstash.sync">8.11.6. 解决数据不对称问题</a></span></dt><dt><span class="section"><a href="jdbc-input-plugin.html#logstash.mapping">8.11.7. 修改 Mapping</a></span></dt></dl></dd><dt><span class="section"><a href="ch08s12.html">8.12. ElasticHD</a></span></dt><dt><span class="section"><a href="install.html">8.13. 安装 Elasticsearch 2.3</a></span></dt><dd><dl><dt><span class="section"><a href="install.html#idm102621146304">8.13.1. RPM 安装</a></span></dt><dt><span class="section"><a href="install.html#idm102621130064">8.13.2. YUM 安装</a></span></dt><dt><span class="section"><a href="install.html#idm102621103456">8.13.3. 测试安装是否正常</a></span></dt><dt><span class="section"><a href="install.html#plugin">8.13.4. Plugin 插件管理</a></span></dt><dd><dl><dt><span class="section"><a href="install.html#idm102621150336">8.13.4.1. 手工安装插件</a></span></dt><dt><span class="section"><a href="install.html#idm102621177968">8.13.4.2. plugin 命令</a></span></dt><dt><span class="section"><a href="install.html#idm102621113296">8.13.4.3. 插件测试</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="faq.html">8.14. FAQ</a></span></dt><dd><dl><dt><span class="section"><a href="faq.html#idm102612496544">8.14.1. Plugin [analysis-ik] is incompatible with Elasticsearch [2.3.5]. Was designed for version [2.3.4]</a></span></dt><dt><span class="section"><a href="faq.html#idm102612503136">8.14.2. plugin [analysis-ik] is incompatible with version [5.6.1]; was designed for version [5.5.2]</a></span></dt><dt><span class="section"><a href="faq.html#idm102612510256">8.14.3. mapper_parsing_exception: failed to parse [ctime]</a></span></dt><dt><span class="section"><a href="faq.html#idm102612514848">8.14.4. 配置 JAVA_HOME</a></span></dt><dt><span class="section"><a href="faq.html#idm102612522464">8.14.5. memory locking requested for elasticsearch process but memory is not locked</a></span></dt></dl></dd></dl></div><p>http://www.elasticsearch.org/</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="install"></a>8.1. 安装 Elasticsearch</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="idm102627022816"></a>8.1.1. 6.x 安装</h3></div></div></div><p>安装 6.x 仓库</p><pre class="screen">
			
curl -s https://raw.githubusercontent.com/oscm/shell/master/search/elastic/elastic-6.x.sh | bash			
			
			</pre><p>安装 6.x 包</p><pre class="screen">
			
yum install elasticsearch			
			
			</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="single"></a>8.1.2. 单机模式 (适用于开发环境) 5.x </h3></div></div></div><p>使用 Netkiller OSCM 一键安装 Elasticsearch 5.6.0</p><pre class="screen">
# Java
curl -s https://raw.githubusercontent.com/oscm/shell/master/lang/java/openjdk/java-1.8.0-openjdk.sh | bash

# Install
curl -s https://raw.githubusercontent.com/oscm/shell/master/search/elasticsearch/elasticsearch-5.x.sh | bash

# Bind 0.0.0.0
curl -s https://raw.githubusercontent.com/oscm/shell/master/search/elasticsearch/network.bind_host.sh | bash

# Auto create index
curl -s https://raw.githubusercontent.com/oscm/shell/master/search/elasticsearch/action.auto_create_index.sh | bash

# elasticsearch-analysis-ik

curl -s https://raw.githubusercontent.com/oscm/shell/master/search/elasticsearch/5.5/elasticsearch-analysis-ik-5.6.0.sh | bash
			</pre><p>通常 elasticsearch-analysis-ik 的版本会比 elasticsearch 慢一个版本，所以请使用下面命令查看版本是否一致，如果不一致可以修改 plugin-descriptor.properties 配置文件，使其一致。</p><pre class="screen">
root@netkiller /usr/share/elasticsearch/plugins/ik % grep ^version plugin-descriptor.properties
version=5.5.1
			</pre><p>启动后使用 jps 命令检查进城是否工作正常</p><pre class="screen">
root@netkiller /var/log/elasticsearch % jps | grep Elasticsearch
9706 Elasticsearch

root@netkiller /var/log/elasticsearch % ss -lnt | grep 9200
LISTEN     0      128    127.0.0.1:9200                     *:*
			</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="cluster"></a>8.1.3. Elasticsearch Cluster 5.x</h3></div></div></div><p>集群模式需要两个以上的节点，通常是一个 master 节点，多个 data 节点</p><p>首先在所有节点上安装 elasticsearch，然后配置各节点的配置文件，对于 5.5.1 不需要配置决定哪些节点属于 master 节点 或者 data 节点。</p><pre class="screen">
curl -s https://raw.githubusercontent.com/oscm/shell/master/search/elasticsearch/elasticsearch-5.x.sh | bash			
			</pre><p>配置文件</p><pre class="screen">
cluster.name: elasticsearch-cluster # 配置集群名称,所有服务器服务器保持一致

node.name: node-1 # 每个节点唯一标识，每个节点只需改动这里，一次递增 node-1, node-2, node-3 ...

network.host: 0.0.0.0

discovery.zen.ping.unicast.hosts: ["172.16.0.20", "172.16.0.21","172.16.0.22"]  # 所有节点的IP 地址写在这里

discovery.zen.minimum_master_nodes: 3 # 可以作为master的节点总数，有多少个节点就写多少

http.cors.enabled: true
http.cors.allow-origin: "*"
			</pre><p>查看节点状态，使用curl工具: curl 'http://localhost:9200/_nodes/process?pretty'</p><pre class="screen">
root@netkiller /var/log/elasticsearch % curl 'http://localhost:9200/_nodes/process?pretty'
{
  "_nodes" : {
    "total" : 2,
    "successful" : 2,
    "failed" : 0
  },
  "cluster_name" : "my-application",
  "nodes" : {
    "-lnKCmBXRpiwExLns0jc9g" : {
      "name" : "node-1",
      "transport_address" : "10.104.3.2:9300",
      "host" : "10.104.3.2",
      "ip" : "10.104.3.2",
      "version" : "5.5.1",
      "build_hash" : "19c13d0",
      "roles" : [
        "master",
        "data",
        "ingest"
      ],
      "process" : {
        "refresh_interval_in_millis" : 1000,
        "id" : 23669,
        "mlockall" : false
      }
    },
    "WVsgYi2HT8GWnZU1kUwFwA" : {
      "name" : "node-2",
      "transport_address" : "10.186.7.221:9300",
      "host" : "10.186.7.221",
      "ip" : "10.186.7.221",
      "version" : "5.5.1",
      "build_hash" : "19c13d0",
      "roles" : [
        "master",
        "data",
        "ingest"
      ],
      "process" : {
        "refresh_interval_in_millis" : 1000,
        "id" : 12641,
        "mlockall" : false
      }
    }
  }
}
			</pre><p>启动节点后回生成 cluster.name 为文件名的日志文件。</p><p>谁先启动谁讲成为master</p><pre class="screen">
[2017-08-11T17:42:46,018][INFO ][o.e.c.s.ClusterService   ] [node-1] new_master {node-1}{-lnKCmBXRpiwExLns0jc9g}{rZcJDIynSzq2Td3yP2kN5A}{10.104.3.2}{10.104.3.2:9300}, added {{node-2}{WVsgYi2HT8GWnZU1kUwFwA}{X13ShUpAQa2zA1Mgcsm3bQ}{10.186.7.221}{10.186.7.221:9300},}, reason: zen-disco-elected-as-master ([1] nodes joined)[{node-2}{WVsgYi2HT8GWnZU1kUwFwA}{X13ShUpAQa2zA1Mgcsm3bQ}{10.186.7.221}{10.186.7.221:9300}]			
			</pre><p>如果master出现故障，其他节点会接管</p><pre class="screen">
[2017-08-11T17:44:52,797][INFO ][o.e.c.s.ClusterService   ] [node-2] master {new {node-2}{WVsgYi2HT8GWnZU1kUwFwA}{vl8kQx8sQdGVVohrNQnZOQ}{10.186.7.221}{10.186.7.221:9300}}, removed {{node-1}{-lnKCmBXRpiwExLns0jc9g}{rZcJDIynSzq2Td3yP2kN5A}{10.104.3.2}{10.104.3.2:9300},}, added {{node-1}{-lnKCmBXRpiwExLns0jc9g}{odnoG9kpQpeX1ltx5KYTSw}{10.104.3.2}{10.104.3.2:9300},}, reason: zen-disco-elected-as-master ([1] nodes joined)[{node-1}{-lnKCmBXRpiwExLns0jc9g}{odnoG9kpQpeX1ltx5KYTSw}{10.104.3.2}{10.104.3.2:9300}]
[2017-08-11T17:44:53,184][INFO ][o.e.c.r.DelayedAllocationService] [node-2] scheduling reroute for delayed shards in [59.5s] (11 delayed shards)
[2017-08-11T17:44:53,929][INFO ][o.e.c.r.a.AllocationService] [node-2] Cluster health status changed from [RED] to [YELLOW] (reason: [shards started [[information][0]] ...]).		
			</pre><p>master 节点恢复上线会提示</p><pre class="screen">
[2017-08-11T17:44:52,855][INFO ][o.e.c.s.ClusterService   ] [node-1] detected_master {node-2}{WVsgYi2HT8GWnZU1kUwFwA}{vl8kQx8sQdGVVohrNQnZOQ}{10.186.7.221}{10.186.7.221:9300}, added {{node-2}{WVsgYi2HT8GWnZU1kUwFwA}{vl8kQx8sQdGVVohrNQnZOQ}{10.186.7.221}{10.186.7.221:9300},}, reason: zen-disco-receive(from master [master {node-2}{WVsgYi2HT8GWnZU1kUwFwA}{vl8kQx8sQdGVVohrNQnZOQ}{10.186.7.221}{10.186.7.221:9300} committed version [44]])
			</pre><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="loadbalance"></a>8.1.3.1. 负载均衡配置</h4></div></div></div><p>首先安装 nginx, 这里使用 Netkiller OSCM 一键安装脚本完成。</p><pre class="screen">
# curl -s https://raw.githubusercontent.com/oscm/shell/master/web/nginx/stable/nginx.sh | bash
			</pre><p>因为 elasticsearch 没有用户认证机制我们通常在内网访问他。如果对外提供服务需要增加用户认证。</p><p></p><pre class="screen">
			
# printf "neo:$(openssl passwd -crypt s3cr3t)n" &gt; /etc/nginx/passwords 			
			
				</pre><p>创建 nginx 配置文件 /etc/nginx/conf.d/elasticsearch.conf</p><pre class="screen">
upstream elasticsearch {
	server 172.16.0.10:9200;
	server 172.16.0.20:9200;
	server 172.16.0.30:9200;

	keepalive 15;
}

server {
	listen 9200;
	server_name so.netkiller.cn;
	
	charset utf-8;
    access_log /var/log/nginx/so.netkiller.cn.access.log;
    error_log /var/log/nginx/so.netkiller.cn.error.log;
	
	auth_basic "Protected Elasticsearch";
	auth_basic_user_file passwords;

	location ~* ^(/_cluster|/_nodes) {
		return 403;
		break;
	}
    location ~* _(open|close) {
            return 403;
            break;
    }
	location / {
    
		if ($request_filename ~ _shutdown) {
		    return 403;
		    break;
		}

        if ($request_method !~ ^(GET|HEAD|POST)$) {
			return 403;
		}

		proxy_pass http://elasticsearch;
		proxy_http_version 1.1;
		proxy_set_header Connection "Keep-Alive";
		proxy_set_header Proxy-Connection "Keep-Alive";
	}

}
			</pre><p>反复使用下面方法请求，最终你会发现 total_opened 会达到你的nginx 配置数量</p><pre class="screen">
$ curl 'http://test:test@localhost:9200/_nodes/stats/http?pretty' | grep total_opened
# "total_opened" : 15			
			</pre><p>上面的例子适用于绝大多数场景。</p><div class="example"><a id="idm102602871552"></a><p class="title"><strong>例 8.1. Elasticsearch master / slave</strong></p><div class="example-contents"><pre class="screen">
				
upstream elasticsearch {
	server 172.16.0.10:9200;
	server 172.16.0.20:9200 backup;

	keepalive 15;
}

server {
	listen 9200;
	server_name so.netkiller.cn;
	
	auth_basic "Protected Elasticsearch";
	auth_basic_user_file passwords;

	location ~* ^(/_cluster|/_nodes) {
		return 403;
		break;
	} 

	location / {
    
		if ($request_filename ~ _shutdown) {
		    return 403;
		    break;
		}
		if ($request_method !~ "HEAD") {
          return 403;
          break;
        }
        if ($request_method ~ "DELETE") {
          return 403;
          break;
        }

		proxy_pass http://elasticsearch;
		proxy_http_version 1.1;
		proxy_set_header Connection "Keep-Alive";
		proxy_set_header Proxy-Connection "Keep-Alive";
	}

}
				
					</pre></div></div><br class="example-break" /><p>通过 limit_except 可以控制访问权限，例如删除操作。</p><pre class="screen">
			
limit_except PUT {
	allow 192.168.1.1;
	deny all;
}
limit_except DELETE {
	allow 192.168.1.1;
	deny all;
}
			
				</pre></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="idm102627017168"></a>8.1.4. docker-compose 安装</h3></div></div></div><pre class="screen">
			
version: '3.8'
services:
  es01:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.9.2
    container_name: es01
    environment:
      - node.name=es01
      - cluster.name=elasticsearch-cluster
      - bootstrap.memory_lock=true
      - discovery.zen.ping.unicast.hosts=es01,es02,es03
      - discovery.zen.minimum_master_nodes=2
      - discovery.zen.ping_timeout=5s
      - node.master=true
      - node.data=true
      - node.ingest=false
      - ES_JAVA_OPTS=-Xms256m -Xmx256m
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - data01:/usr/share/elasticsearch/data
    ports:
      - 9200:9200
      - 9300:9300
    networks:
      - elastic
  es02:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.9.2
    container_name: es02
    environment:
      - node.name=es02
      - cluster.name=elasticsearch-cluster
      - bootstrap.memory_lock=true
      - discovery.zen.ping.unicast.hosts=es01,es02,es03
      - discovery.zen.minimum_master_nodes=2
      - discovery.zen.ping_timeout=5s
      - node.master=true
      - node.data=true
      - node.ingest=false
      - ES_JAVA_OPTS=-Xms256m -Xmx256m
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - data02:/usr/share/elasticsearch/data
    networks:
      - elastic
    depends_on:
      - es01  
  es03:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.9.2
    container_name: es03
    environment:
      - node.name=es03
      - cluster.name=elasticsearch-cluster
      - bootstrap.memory_lock=true
      - discovery.zen.ping.unicast.hosts=es01,es02,es03
      - discovery.zen.minimum_master_nodes=2
      - discovery.zen.ping_timeout=5s
      - node.master=true
      - node.data=true
      - node.ingest=true
      - ES_JAVA_OPTS=-Xms256m -Xmx256m
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - data03:/usr/share/elasticsearch/data
    networks:
      - elastic
    depends_on:
      - es01
  kibana:
    image: docker.elastic.co/kibana/kibana:7.9.2
    container_name: kibana
    environment:
      # SERVER_NAME: kibana.example.org
      ELASTICSEARCH_HOSTS: http://es01:9200
    ports:
      - 5601:5601
    networks:
      - elastic
    depends_on:
      - es01
volumes:
  data01:
    driver: local
  data02:
    driver: local
  data03:
    driver: local

networks:
  elastic:
    driver: bridge   			
			
			</pre><p>查看节点信息</p><pre class="screen">
			
neo@MacBook-Pro-Neo ~/workspace/docker % curl "http://localhost:9200/_cat/nodes?v&amp;pretty"
ip         heap.percent ram.percent cpu load_1m load_5m load_15m node.role master name
172.19.0.4           48          86  35    4.86    2.90     1.84 dilmrt    *      es03
172.19.0.3           67          86  35    4.86    2.90     1.84 dlmrt     -      es02
172.19.0.2           45          86  35    4.86    2.90     1.84 dlmrt     -      es01			
			
			</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="idm102602867952"></a>8.1.5. Kubernetes</h3></div></div></div><pre class="screen">
			
apiVersion: v1
kind: ConfigMap
metadata:
  name: elasticsearch-logging-config
  namespace: kube-public
  labels:
    app: elasticsearch-logging
data:
  limits.conf: |-
    elasticsearch soft memlock unlimited
    elasticsearch hard memlock unlimited
    elasticsearch hard nofile 65536
    elasticsearch soft nofile 65536
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: elasticsearch-logging
  namespace: kube-public
  labels:
    app: elasticsearch-logging
spec:
  serviceName: elasticsearch-logging
  replicas: 1
  selector:
    matchLabels:
      app: elasticsearch-logging
  template:
    metadata:
      labels:
        app: elasticsearch-logging
    spec:
      initContainers:
      - name: elasticsearch-logging-init
        image: alpine:latest
        imagePullPolicy: IfNotPresent
        command: ["/sbin/sysctl", "-w", "vm.max_map_count=262144"]
        securityContext:
          privileged: true
      containers:
      - name: elasticsearch-logging
        image: docker.elastic.co/elasticsearch/elasticsearch:7.9.2
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            cpu: 200m
            # memory: "1Gi"
          requests:
            cpu: 200m
            # memory: "1Gi"
        env:
        - name: "NAMESPACE"
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: node.name
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: "cluster.name"
          value: "elasticsearch-cluster"
        - name: "bootstrap.memory_lock"
          # value: "true"
          value: "false"
        - name: "discovery.seed_hosts"
          value: "elasticsearch-logging-0,elasticsearch-logging-1,elasticsearch-logging-2"
        - name: "cluster.initial_master_nodes"
          value: "elasticsearch-logging-0"
        - name: "discovery.find_peers_interval"
          value: "5s"

        - name: "gateway.expected_nodes"
          value: "2"
        - name: "gateway.expected_master_nodes"
          value: "1"

        - name: "http.cors.enabled"
          value: "true"
        - name: "http.cors.allow-origin"
          value: "*"

        - name: "ES_JAVA_OPTS"
          value: "-Xms1g -Xmx1g"
        - name: RLIMIT_MEMLOCK
          value: "unlimited"
        ports:
        - containerPort: 9200
          name: restful
          protocol: TCP
        - containerPort: 9300
          name: transport
          protocol: TCP
        # readinessProbe:
        #     httpGet:
        #       scheme: HTTP
        #       path: /_cluster/health?local=true
        #       port: 9200
        #     initialDelaySeconds: 5  
        # livenessProbe:
        #   tcpSocket:
        #     port: transport
        #   initialDelaySeconds: 20
        #   periodSeconds: 10
        volumeMounts:
        - name: elasticsearch-config
          mountPath: /etc/security/limits.conf
          subPath: limits.conf
        - name: elasticsearch-data
          mountPath: /data
      volumes:
      - name: elasticsearch-data
        emptyDir: {}
        # hostPath:
          # path: /data
      - name: elasticsearch-config
        configMap:
          name: elasticsearch-logging-config
---
apiVersion: v1
kind: Service
metadata:
  name: elasticsearch-logging
  namespace: kube-public
  labels:
    k8s-app: elasticsearch-logging
    kubernetes.io/cluster-service: "true"
    kubernetes.io/name: "Elasticsearch"
spec:
  selector:
    app: elasticsearch-logging
  type: NodePort
  # type: ClusterIP
  # clusterIP: None
  ports:
  - name: restful
    port: 9200
    protocol: TCP
    targetPort: restful
    nodePort: 30092
  - name: transport
    port: 9300
    targetPort: transport
			
			
			</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="idm102602867312"></a>8.1.6. netkiller-devops 编排 elasticsearch</h3></div></div></div><p>创建 docker.py 文件</p><pre class="screen">
			
#!/usr/bin/env python3
from netkiller.docker import *
			
volume = Volumes('elasticsearch')
			
elasticsearch = Services('elasticsearch')
elasticsearch.container_name('elasticsearch').environment([
	'discovery.type=single-node',
	'ES_JAVA_OPTS=-Xms512m -Xmx2048m'
])
elasticsearch.image('docker.elastic.co/elasticsearch/elasticsearch:7.15.0').ports(['9200:9200','9300:9300']).volumes(['elasticsearch:/usr/share/elasticsearch/data'])

experiment = Composes('experiment')
experiment.version('3.9')
experiment.volumes(volume)
experiment.services(elasticsearch)

if __name__ == '__main__':
	try:
		docker = Docker()
		docker.sysctl([{'vm.max_map_count':'262144'}])
		docker.environment(experiment)
		docker.main()
	except KeyboardInterrupt:
		print ("Crtl+C Pressed. Shutting down.")
			
			</pre><p></p><pre class="screen">
			
[root@localhost ~]# python3 docker.py -e experiment -l
experiment :
     fluentd
     redis
     mongo
     mysql
     elasticsearch
     
[root@localhost ~]# python3 docker.py -e experiment up elasticsearch
Starting elasticsearch ... done

[root@localhost ~]# python3 docker.py -e experiment ps elasticsearch
    Name                   Command               State                                         Ports                                       
-------------------------------------------------------------------------------------------------------------------------------------------
elasticsearch   /bin/tini -- /usr/local/bi ...   Up      0.0.0.0:9200-&gt;9200/tcp,:::9200-&gt;9200/tcp, 0.0.0.0:9300-&gt;9300/tcp,:::9300-&gt;9300/tcp			
			
			</pre><p>测试</p><pre class="screen">
			
[root@localhost ~]# curl -s -X GET "localhost:9200/_cat/nodes?v=true&amp;pretty"
ip         heap.percent ram.percent cpu load_1m load_5m load_15m node.role   master name
172.21.0.2           16          99   5    1.68    0.60     0.26 cdfhilmrstw *      aeedaff1ac15			
			
			</pre><p>停止</p><pre class="screen">
			
[root@localhost ~]# python3 docker.py -e experiment stop elasticsearch
Stopping elasticsearch ... done			
			
			</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="version"></a>8.1.7. 安装指定版本的 Elasticsearch</h3></div></div></div><p>使用 yum 安装默认为最新版本，我们常常会遇到一个问题 elasticsearch-analysis-ik 的版本晚于 Elasticsearch。如果使用 yum 安装 Elasticsearch 可能 elasticsearch-analysis-ik 插件不支持这个版本，有些版本的 elasticsearch-analysis-ik 可以修改插件配置文件中的版本号，使其与elasticsearch版本相同，可以欺骗 elasticsearch 跳过版本不一致异常。</p><p>
				最佳的解决方案是去
				<a class="ulink" href="https://github.com/medcl/elasticsearch-analysis-ik" target="_top">elasticsearch-analysis-ik github</a>
				找到兼容的版本，安装我们安装 elasticsearch-analysis-ik 的版本需求来指定安装 elasticsearch
			</p><p></p><pre class="screen">
Versions

IK version	ES version
master	5.x -&gt; master
5.6.0	5.6.0
5.5.3	5.5.3
5.4.3	5.4.3
5.3.3	5.3.3
5.2.2	5.2.2
5.1.2	5.1.2
1.10.1	2.4.1
1.9.5	2.3.5
1.8.1	2.2.1
1.7.0	2.1.1
1.5.0	2.0.0
1.2.6	1.0.0
1.2.5	0.90.x
1.1.3	0.20.x
1.0.0	0.16.2 -&gt; 0.19.0			
			</pre><p>最新版是 elasticsearch 5.6.1 但分词插件 elasticsearch-analysis-ik 仅能支持到 elasticsearch 版本是 5.6.0 </p><pre class="screen">
root@netkiller /var/log % yum --showduplicates list elasticsearch | expand | tail
Repository epel is listed more than once in the configuration  
elasticsearch.noarch                 5.5.3-1                  elasticsearch-5.x     
elasticsearch.noarch                 5.6.0-1                  elasticsearch-5.x   
elasticsearch.noarch                 5.6.1-1                  elasticsearch-5.x 
			</pre><p>安装 5.6.0</p><pre class="screen">
# yum install elasticsearch-5.6.0-1

Loaded plugins: fastestmirror, langpacks
Repository epel is listed more than once in the configuration
Loading mirror speeds from cached hostfile
Resolving Dependencies
--&gt; Running transaction check
---&gt; Package elasticsearch.noarch 0:5.6.0-1 will be installed
--&gt; Finished Dependency Resolution

Dependencies Resolved

==========================================================================================================================================================================================================
 Package                                            Arch                                        Version                                      Repository                                              Size
==========================================================================================================================================================================================================
Installing:
 elasticsearch                                      noarch                                      5.6.0-1                                      elasticsearch-5.x                                       32 M

Transaction Summary
==========================================================================================================================================================================================================
Install  1 Package

Total download size: 32 M
Installed size: 36 M
Is this ok [y/d/N]: y
			</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="plugin"></a>8.1.8. Plugin</h3></div></div></div><p>Elasticsearch 提供了插件管理命令 elasticsearch-plugin</p><pre class="screen">
root@netkiller ~ % /usr/share/elasticsearch/bin/elasticsearch-plugin -h
A tool for managing installed elasticsearch plugins

Commands
--------
list - Lists installed elasticsearch plugins
install - Install a plugin
remove - removes a plugin from Elasticsearch

Non-option arguments:
command              

Option         Description        
------         -----------        
-h, --help     show help          
-s, --silent   show minimal output
-v, --verbose  show verbose output			
			</pre><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="elasticsearch-analysis-ik"></a>8.1.8.1. elasticsearch-analysis-ik</h4></div></div></div><p>安装插件</p><pre class="screen">
root@netkiller ~ % /usr/share/elasticsearch/bin/elasticsearch-plugin install https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v5.5.1/elasticsearch-analysis-ik-5.5.1.zip
-&gt; Downloading https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v5.5.1/elasticsearch-analysis-ik-5.5.1.zip
[=================================================] 100%   
-&gt; Installed analysis-ik
				</pre><pre class="screen">
curl -XPOST http://localhost:9200/index/fulltext/_mapping -d'
{
        "properties": {
            "content": {
                "type": "text",
                "analyzer": "ik_max_word",
                "search_analyzer": "ik_max_word"
            }
        }
    
}'			
				</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="elasticsearch-analysis-pinyin"></a>8.1.8.2. elasticsearch-analysis-pinyin</h4></div></div></div><p>https://github.com/medcl/elasticsearch-analysis-pinyin</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="idm102602853216"></a>8.1.9. Elastic Cloud on Kubernetes</h3></div></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="idm102602852832"></a>8.1.10. 发现配置</h3></div></div></div><p>https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-discovery-settings.html</p><pre class="screen">
			
cluster.initial_master_nodes 集群初始化的提供的master候选地址，第一次启动时将从该列表中获取master

discovery.seed_hosts 配置该节点会与哪些候选地址进行通信，hostname,ip ,ip+port
discovery.seed_providers 指定种子地址提供的方式，默认settings，也支持其他Discovery Plugins，包括EC2 Discovery，Azure Classic discovery，GCE discovery（ Google Compute Engine discovery ）

discovery.seed_providers: file 当指定的时候，可以在该指定文件中填写ip，方便单独维护。
discovery.find_peers_interval 未发现主节点的重试时间，默认1s

discovery.seed_resolver.timeout 种子提供地址的超时时间
discovery.seed_resolver.max_concurrent_resolvers 并发查找的数量

由以下配置提供未填写端口时的端口范围。
transport.profiles.default.port
transport.port			
			
			</pre><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm102602850944"></a>8.1.10.1. 即将废弃</h4></div></div></div><p>多播配置下，节点向集群发送多播请求，其他节点收到请求后会做出响应。配置参数如下：</p><pre class="screen">
			
discovery.zen.ping.multicast.group:224.2.2.4  	组地址
discovery.zen.ping.multicast.port：54328  		端口
discovery.zen.ping.multicast.ttl:3 				广播消息ttl
discovery.zen.ping.multicast.address:null		绑定的地址，null表示绑定所有可用的网络接口
discovery.zen.ping.multicast.enabled:true 		多播自动发现禁用开关
			
				</pre><p>单播配置下，节点向指定的主机发送单播请求，配置如下：</p><pre class="screen">
			
# discovery.zen.ping.unicast.hosts:host1:port1,host2:port2
discovery.zen.ping.unicast.hosts=es01,es02,es03
discovery.zen.minimum_master_nodes=2
discovery.zen.ping_timeout=5s
			
				</pre></div></div></div></div><div xmlns="" id="SOHUCS"></div><script xmlns="" charset="utf-8" type="text/javascript" src="https://cy-cdn.kuaizhan.com/upload/changyan.js"></script><script xmlns="" type="text/javascript">
window.changyan.api.config({
appid: 'cyvwjQUG3',
conf: 'prod_ef966242df3d8b5acb1e0ee9fc01cafe'
});
</script><script xmlns="" type="text/javascript" id="clustrmaps" src="//cdn.clustrmaps.com/map_v2.js?u=r5HG&amp;d=9mi5r_kkDC8uxG8HuY3p4-2qgeeVypAK9vMD-2P6BYM"></script><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="../index.html">上一页</a> </td><td width="20%" align="center"><a accesskey="u" href="../index.html">上一级</a></td><td width="40%" align="right"> <a accesskey="n" href="document.html">下一页</a></td></tr><tr><td width="40%" align="left" valign="top">部分 II. Search Engine </td><td width="20%" align="center"><a accesskey="h" href="../../index.html">起始页</a></td><td width="40%" align="right" valign="top"> 8.2. 文档API</td></tr></table></div><script xmlns="">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-11694057-1', 'auto');
  ga('send', 'pageview');

</script><script xmlns="" async="async">
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?93967759a51cda79e49bf4e34d0b0f2c";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script xmlns="" async="async">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script></body></html>