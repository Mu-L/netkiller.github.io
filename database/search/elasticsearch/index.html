<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>第 8 章 Elasticsearch</title><link rel="stylesheet" type="text/css" href="../../docbook.css" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><meta name="keywords" content="MySQL, PostgreSQL, Oracle, NoSQL, ER, TokyoCabinet/Tyrant, Memcache, Membase, Redis, Flare, Voldemort, LevelDB, MongoDB, GreenSQL, RDBMS, ORDBMS" /><link rel="home" href="../../index.html" title="Netkiller Database 手札" /><link rel="up" href="../index.html" title="部分 II. Search Engine" /><link rel="prev" href="../index.html" title="部分 II. Search Engine" /><link rel="next" href="document.html" title="8.2. 文档API" /></head><body><a xmlns="" href="//www.netkiller.cn/">Home</a> |
		<a xmlns="" href="//netkiller.github.io/">简体中文</a> |
	    <a xmlns="" href="http://netkiller.sourceforge.net/">繁体中文</a> |
	    <a xmlns="" href="/journal/index.html">杂文</a> |
	    <a xmlns="" href="https://github.com/netkiller">Github</a> |
	    <a xmlns="" href="https://zhuanlan.zhihu.com/netkiller">知乎专栏</a> |
   	    <a xmlns="" href="https://edu.51cto.com/lecturer/1703915.html">51CTO学院</a> |
	    <a xmlns="" href="https://edu.csdn.net/lecturer/6423">CSDN程序员研修院</a> |
	    <a xmlns="" href="http://my.oschina.net/neochen/">OSChina 博客</a> |
	    <a xmlns="" href="https://cloud.tencent.com/developer/column/2078">腾讯云社区</a> |
	    <a xmlns="" href="https://yq.aliyun.com/u/netkiller/">阿里云栖社区</a> |
	    <a xmlns="" href="https://www.facebook.com/bg7nyt">Facebook</a> |
	    <a xmlns="" href="http://cn.linkedin.com/in/netkiller/">Linkedin</a> |
	    <a xmlns="" href="https://www.youtube.com/user/bg7nyt/videos">Youtube</a> |
	    <a xmlns="" href="//www.netkiller.cn/home/donations.html">打赏(Donations)</a> |
	    <a xmlns="" href="//www.netkiller.cn/home/about.html">About</a><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">第 8 章 Elasticsearch</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="../index.html">上一页</a> </td><th width="60%" align="center">部分 II. Search Engine</th><td width="20%" align="right"> <a accesskey="n" href="document.html">下一页</a></td></tr></table><hr /></div><table xmlns=""><tr><td><iframe src="//ghbtns.com/github-btn.html?user=netkiller&amp;repo=netkiller.github.io&amp;type=watch&amp;count=true&amp;size=large" height="30" width="170" frameborder="0" scrolling="0" style="width:170px; height: 30px;" allowTransparency="true"></iframe></td><td><iframe src="//ghbtns.com/github-btn.html?user=netkiller&amp;repo=netkiller.github.io&amp;type=fork&amp;count=true&amp;size=large" height="30" width="170" frameborder="0" scrolling="0" style="width:170px; height: 30px;" allowTransparency="true"></iframe></td><td><iframe src="//ghbtns.com/github-btn.html?user=netkiller&amp;type=follow&amp;count=true&amp;size=large" height="30" width="240" frameborder="0" scrolling="0" style="width:240px; height: 30px;" allowTransparency="true"></iframe></td><td></td><td><a href="https://zhuanlan.zhihu.com/netkiller"><img src="/images/logo/zhihu-card-default.svg" height="25" /></a></td><td valign="middle"><a href="https://zhuanlan.zhihu.com/netkiller">知乎专栏</a> ｜ <a href="https://www.zhihu.com/club/1241768772601950208">多维度架构</a></td><td></td><td></td><td></td><td></td></tr></table><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="index"></a>第 8 章 Elasticsearch</h2></div></div></div><div class="toc"><p><strong>目录</strong></p><dl class="toc"><dt><span class="section"><a href="index.html#install">8.1. 安装 Elasticsearch</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#idm254556120896">8.1.1. Docker 8.8.1</a></span></dt><dt><span class="section"><a href="index.html#idm254556136752">8.1.2. IK 分词</a></span></dt><dt><span class="section"><a href="index.html#idm254556147136">8.1.3. Helm Chart 安装 Elasticsearch</a></span></dt><dt><span class="section"><a href="index.html#idm254556150912">8.1.4. Elastic Cloud on Kubernetes</a></span></dt><dt><span class="section"><a href="index.html#idm254556153536">8.1.5. docker-compose 安装</a></span></dt><dt><span class="section"><a href="index.html#idm254556159136">8.1.6. Kubernetes</a></span></dt><dt><span class="section"><a href="index.html#idm254556162752">8.1.7. netkiller-devops 编排 elasticsearch</a></span></dt><dt><span class="section"><a href="index.html#version">8.1.8. 安装指定版本的 Elasticsearch</a></span></dt><dt><span class="section"><a href="index.html#plugin">8.1.9. Plugin</a></span></dt><dt><span class="section"><a href="index.html#idm254556264304">8.1.10. netkiller-devops 编排 Kubernetes</a></span></dt></dl></dd><dt><span class="section"><a href="document.html">8.2. 文档API</a></span></dt><dd><dl><dt><span class="section"><a href="document.html#quickstart">8.2.1. 快速上手</a></span></dt><dt><span class="section"><a href="document.html#put">8.2.2. 写入 PUT/POST</a></span></dt><dt><span class="section"><a href="document.html#get">8.2.3. 获取 GET</a></span></dt><dt><span class="section"><a href="document.html#head">8.2.4. 检查记录是否存在</a></span></dt><dt><span class="section"><a href="document.html#delete">8.2.5. 删除 Delete</a></span></dt><dt><span class="section"><a href="document.html#param">8.2.6. 参数</a></span></dt></dl></dd><dt><span class="section"><a href="search.html">8.3. 搜索</a></span></dt><dd><dl><dt><span class="section"><a href="search.html#query">8.3.1. URL 搜索</a></span></dt><dt><span class="section"><a href="search.html#search.page">8.3.2. 分页</a></span></dt></dl></dd><dt><span class="section"><a href="dsl.html">8.4. Query DSL</a></span></dt><dd><dl><dt><span class="section"><a href="dsl.html#match">8.4.1. match 匹配</a></span></dt><dt><span class="section"><a href="dsl.html#multi_match">8.4.2. multi_match 多字段匹配</a></span></dt><dt><span class="section"><a href="dsl.html#bool">8.4.3. Query bool 布尔条件</a></span></dt><dt><span class="section"><a href="dsl.html#filter">8.4.4. filter 过滤</a></span></dt><dt><span class="section"><a href="dsl.html#sort">8.4.5. sort 排序</a></span></dt><dt><span class="section"><a href="dsl.html#_source">8.4.6. _source</a></span></dt><dt><span class="section"><a href="dsl.html#highlight">8.4.7. highlight 高亮处理</a></span></dt></dl></dd><dt><span class="section"><a href="manager.html">8.5. 集群管理</a></span></dt><dd><dl><dt><span class="section"><a href="manager.html#health">8.5.1. 节点健康状态</a></span></dt><dt><span class="section"><a href="manager.html#nodes">8.5.2. 节点http状态</a></span></dt><dt><span class="section"><a href="manager.html#master">8.5.3. 查看master节点</a></span></dt><dt><span class="section"><a href="manager.html#shards">8.5.4. 查看索引的节点分布</a></span></dt><dt><span class="section"><a href="manager.html#idm254556344608">8.5.5. 索引的开启与关闭</a></span></dt></dl></dd><dt><span class="section"><a href="elasticsearch-analysis-ik.html">8.6. 中文分词插件管理</a></span></dt><dd><dl><dt><span class="section"><a href="elasticsearch-analysis-ik.html#idm254555717728">8.6.1. 通过 elasticsearch-plugin 命令安装分词插件</a></span></dt><dt><span class="section"><a href="elasticsearch-analysis-ik.html#plugin.install">8.6.2. 手工安装插件</a></span></dt><dt><span class="section"><a href="elasticsearch-analysis-ik.html#plugin.index">8.6.3. 创建索引</a></span></dt><dt><span class="section"><a href="elasticsearch-analysis-ik.html#plugin.delete">8.6.4. 删除索引</a></span></dt><dt><span class="section"><a href="elasticsearch-analysis-ik.html#plugin.config">8.6.5. 配置索引分词插件</a></span></dt></dl></dd><dt><span class="section"><a href="index.html">8.7. 索引管理</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#index.indices">8.7.1. 查看索引</a></span></dt><dt><span class="section"><a href="index.html#index.delete">8.7.2. 删除索引</a></span></dt></dl></dd><dt><span class="section"><a href="mapping.html">8.8. 映射</a></span></dt><dd><dl><dt><span class="section"><a href="mapping.html#mapping.get">8.8.1. 查看 _mapping</a></span></dt><dt><span class="section"><a href="mapping.html#mapping.delete">8.8.2. 删除 _mapping </a></span></dt><dt><span class="section"><a href="mapping.html#mapping.post">8.8.3. 创建 _mapping</a></span></dt><dt><span class="section"><a href="mapping.html#mapping.update">8.8.4. 更新 mapping</a></span></dt><dt><span class="section"><a href="mapping.html#mapping.change">8.8.5. 修改 _mapping</a></span></dt><dt><span class="section"><a href="mapping.html#type">8.8.6. 数据类型</a></span></dt></dl></dd><dt><span class="section"><a href="alias.html">8.9. Alias management 别名管理</a></span></dt><dd><dl><dt><span class="section"><a href="alias.html#idm254555690048">8.9.1. 查看索引别名</a></span></dt><dt><span class="section"><a href="alias.html#idm254555688288">8.9.2. 创建索引别名</a></span></dt><dt><span class="section"><a href="alias.html#idm254555686656">8.9.3. 修改别名</a></span></dt><dt><span class="section"><a href="alias.html#idm254555685712">8.9.4. 删除别名</a></span></dt></dl></dd><dt><span class="section"><a href="example.html">8.10. Example</a></span></dt><dd><dl><dt><span class="section"><a href="example.html#idm254555684272">8.10.1. 新闻资讯应用案例</a></span></dt><dt><span class="section"><a href="example.html#idm254555683632">8.10.2. 文章搜索案例</a></span></dt></dl></dd><dt><span class="section"><a href="jdbc-input-plugin.html">8.11. Migrating MySQL Data into Elasticsearch using logstash</a></span></dt><dd><dl><dt><span class="section"><a href="jdbc-input-plugin.html#logstash.install">8.11.1. 安装 logstash</a></span></dt><dt><span class="section"><a href="jdbc-input-plugin.html#logstash.config">8.11.2. 配置 logstash</a></span></dt><dt><span class="section"><a href="jdbc-input-plugin.html#logstash.start">8.11.3. 启动 Logstash</a></span></dt><dt><span class="section"><a href="jdbc-input-plugin.html#logstash.test">8.11.4. 验证</a></span></dt><dt><span class="section"><a href="jdbc-input-plugin.html#logstash.template">8.11.5. 配置模板</a></span></dt><dt><span class="section"><a href="jdbc-input-plugin.html#logstash.sync">8.11.6. 解决数据不对称问题</a></span></dt><dt><span class="section"><a href="jdbc-input-plugin.html#logstash.mapping">8.11.7. 修改 Mapping</a></span></dt></dl></dd><dt><span class="section"><a href="ch08s12.html">8.12. ElasticHD</a></span></dt><dt><span class="section"><a href="install.html">8.13. 安装 Elasticsearch 早起版本</a></span></dt><dd><dl><dt><span class="section"><a href="install.html#idm254481013904">8.13.1. 6.x 安装</a></span></dt><dt><span class="section"><a href="install.html#single">8.13.2. 单机模式 (适用于开发环境) 5.x </a></span></dt><dt><span class="section"><a href="install.html#cluster">8.13.3. Elasticsearch Cluster 5.x</a></span></dt><dt><span class="section"><a href="install.html#idm254481004224">8.13.4. RPM 安装</a></span></dt><dt><span class="section"><a href="install.html#idm254480989776">8.13.5. YUM 安装</a></span></dt><dt><span class="section"><a href="install.html#idm254480988176">8.13.6. 测试安装是否正常</a></span></dt><dt><span class="section"><a href="install.html#plugin">8.13.7. Plugin 插件管理</a></span></dt></dl></dd><dt><span class="section"><a href="faq.html">8.14. FAQ</a></span></dt><dd><dl><dt><span class="section"><a href="faq.html#idm254480982720">8.14.1. Plugin [analysis-ik] is incompatible with Elasticsearch [2.3.5]. Was designed for version [2.3.4]</a></span></dt><dt><span class="section"><a href="faq.html#idm254480981312">8.14.2. plugin [analysis-ik] is incompatible with version [5.6.1]; was designed for version [5.5.2]</a></span></dt><dt><span class="section"><a href="faq.html#idm254480979008">8.14.3. mapper_parsing_exception: failed to parse [ctime]</a></span></dt><dt><span class="section"><a href="faq.html#idm254480977856">8.14.4. 配置 JAVA_HOME</a></span></dt><dt><span class="section"><a href="faq.html#idm254480976832">8.14.5. memory locking requested for elasticsearch process but memory is not locked</a></span></dt></dl></dd></dl></div><p>http://www.elasticsearch.org/</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="install"></a>8.1. 安装 Elasticsearch</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="idm254556120896"></a>8.1.1. Docker 8.8.1</h3></div></div></div><p>创建卷</p><pre class="screen">
     
docker volume create es-data
docker volume create es-plugins
    
    </pre><p>拉取镜像</p><pre class="screen">
     
docker pull docker.elastic.co/elasticsearch/elasticsearch:8.8.1
    
    </pre><p>HTTP 但节点模式</p><pre class="screen">
    
docker run -d --name elasticsearch -p 9200:9200 -p 9300:9300 \
-e ES_JAVA_OPTS="-Xms1g -Xmx1g" \
-e xpack.security.enabled=false \
-e discovery.type=single-node \
-v es-data:/usr/share/elasticsearch/data \
-v es-plugins:/usr/share/elasticsearch/plugins \
docker.elastic.co/elasticsearch/elasticsearch:8.8.1
    
    </pre><p>测试安装是否成功</p><pre class="screen">
     
[root@netkiller ~]# curl http://localhost:9200
{
  "name" : "89eb025a8f53",
  "cluster_name" : "docker-cluster",
  "cluster_uuid" : "BXH81Lt-QuS6ZqIQh0ocPw",
  "version" : {
    "number" : "8.8.1",
    "build_flavor" : "default",
    "build_type" : "docker",
    "build_hash" : "f8edfccba429b6477927a7c1ce1bc6729521305e",
    "build_date" : "2023-06-05T21:32:25.188464208Z",
    "build_snapshot" : false,
    "lucene_version" : "9.6.0",
    "minimum_wire_compatibility_version" : "7.17.0",
    "minimum_index_compatibility_version" : "7.0.0"
  },
  "tagline" : "You Know, for Search"
}    
    
    </pre><p>HTTPS 模式</p><pre class="screen">
     
docker run --name elasticsearch -p 9200:9200 -p 9300:9300 \
-e ES_JAVA_OPTS="-Xms1g -Xmx1g" \
-e discovery.type=single-node \
-e ELASTIC_PASSWORD=elastic \
-v es-data:/usr/share/elasticsearch/data \
-v es-plugins:/usr/share/elasticsearch/plugins \
docker.elastic.co/elasticsearch/elasticsearch:8.8.1    

docker exec -it elasticsearch /usr/share/elasticsearch/bin/elasticsearch-reset-password
docker cp elasticsearch:/usr/share/elasticsearch/config/certs/http_ca.crt .
curl --cacert http_ca.crt -u elastic https://localhost:9200
    
    </pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="idm254556136752"></a>8.1.2. IK 分词</h3></div></div></div><p>安装 IK 分词，方法一</p><p>https://github.com/medcl/elasticsearch-analysis-ik/releases</p><pre class="screen">
    
下载 zip 解压，复制到 plugins 目录
wget https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v8.7.0/elasticsearch-analysis-ik-8.7.0.zip
docker cp ik elasticsearch:/usr/share/elasticsearch/plugins    
    
    </pre><p>方法二</p><pre class="screen">
    
docker container rm elasticsearch
docker volume rm es-data
docker volume rm es-plugins

docker volume create es-data
docker volume create es-plugins

docker run --name elasticsearch -p 9200:9200 -p 9300:9300 \
-e ES_JAVA_OPTS="-Xms1g -Xmx1g" \
-e xpack.security.enabled=false \
-e discovery.type=single-node \
-v es-data:/usr/share/elasticsearch/data \
-v es-plugins:/usr/share/elasticsearch/plugins \
docker.elastic.co/elasticsearch/elasticsearch:8.7.0

docker exec -it elasticsearch ./bin/elasticsearch-plugin install https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v8.7.0/elasticsearch-analysis-ik-8.7.0.zip

docker restart elasticsearch

curl -XPOST -H 'Content-Type: application/json' -d '{"analyzer": "ik_smart","text": "我是中国人，我热爱我的祖国"}' http://localhost:9200/_analyze

    
    </pre><p>分词演示</p><pre class="screen">
     
[root@sfzito ~]# curl -s -XPOST -H 'Content-Type: application/json' -d '{"analyzer": "ik_smart","text": "我是中国人，我热爱我的祖国"}' http://localhost:9200/_analyze |jq
{
  "tokens": [
    {
      "token": "我",
      "start_offset": 0,
      "end_offset": 1,
      "type": "CN_CHAR",
      "position": 0
    },
    {
      "token": "是",
      "start_offset": 1,
      "end_offset": 2,
      "type": "CN_CHAR",
      "position": 1
    },
    {
      "token": "中国人",
      "start_offset": 2,
      "end_offset": 5,
      "type": "CN_WORD",
      "position": 2
    },
    {
      "token": "我",
      "start_offset": 6,
      "end_offset": 7,
      "type": "CN_CHAR",
      "position": 3
    },
    {
      "token": "热",
      "start_offset": 7,
      "end_offset": 8,
      "type": "CN_CHAR",
      "position": 4
    },
    {
      "token": "爱我",
      "start_offset": 8,
      "end_offset": 10,
      "type": "CN_WORD",
      "position": 5
    },
    {
      "token": "的",
      "start_offset": 10,
      "end_offset": 11,
      "type": "CN_CHAR",
      "position": 6
    },
    {
      "token": "祖国",
      "start_offset": 11,
      "end_offset": 13,
      "type": "CN_WORD",
      "position": 7
    }
  ]
}    
    
    </pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="idm254556147136"></a>8.1.3. Helm Chart 安装 Elasticsearch</h3></div></div></div><pre class="screen">
			
Add the Elastic Helm Chart Repo: helm repo add elastic https://helm.elastic.co
Install Elasticsearch: helm install --name elasticsearch elastic/elasticsearch
Install Kibana: helm install --name kibana elastic/kibana			
			
		</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="idm254556150912"></a>8.1.4. Elastic Cloud on Kubernetes</h3></div></div></div><p>https://www.elastic.co/guide/en/cloud-on-k8s/current/index.html</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="idm254556153536"></a>8.1.5. docker-compose 安装</h3></div></div></div><pre class="screen">
			
version: '3.8'
services:
  es01:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.9.2
    container_name: es01
    environment:
      - node.name=es01
      - cluster.name=elasticsearch-cluster
      - bootstrap.memory_lock=true
      - discovery.zen.ping.unicast.hosts=es01,es02,es03
      - discovery.zen.minimum_master_nodes=2
      - discovery.zen.ping_timeout=5s
      - node.master=true
      - node.data=true
      - node.ingest=false
      - ES_JAVA_OPTS=-Xms256m -Xmx256m
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - data01:/usr/share/elasticsearch/data
    ports:
      - 9200:9200
      - 9300:9300
    networks:
      - elastic
  es02:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.9.2
    container_name: es02
    environment:
      - node.name=es02
      - cluster.name=elasticsearch-cluster
      - bootstrap.memory_lock=true
      - discovery.zen.ping.unicast.hosts=es01,es02,es03
      - discovery.zen.minimum_master_nodes=2
      - discovery.zen.ping_timeout=5s
      - node.master=true
      - node.data=true
      - node.ingest=false
      - ES_JAVA_OPTS=-Xms256m -Xmx256m
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - data02:/usr/share/elasticsearch/data
    networks:
      - elastic
    depends_on:
      - es01  
  es03:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.9.2
    container_name: es03
    environment:
      - node.name=es03
      - cluster.name=elasticsearch-cluster
      - bootstrap.memory_lock=true
      - discovery.zen.ping.unicast.hosts=es01,es02,es03
      - discovery.zen.minimum_master_nodes=2
      - discovery.zen.ping_timeout=5s
      - node.master=true
      - node.data=true
      - node.ingest=true
      - ES_JAVA_OPTS=-Xms256m -Xmx256m
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - data03:/usr/share/elasticsearch/data
    networks:
      - elastic
    depends_on:
      - es01
  kibana:
    image: docker.elastic.co/kibana/kibana:7.9.2
    container_name: kibana
    environment:
      # SERVER_NAME: kibana.example.org
      ELASTICSEARCH_HOSTS: http://es01:9200
    ports:
      - 5601:5601
    networks:
      - elastic
    depends_on:
      - es01
volumes:
  data01:
    driver: local
  data02:
    driver: local
  data03:
    driver: local

networks:
  elastic:
    driver: bridge   			
			
		</pre><p>查看节点信息</p><pre class="screen">
			
neo@MacBook-Pro-Neo ~/workspace/docker % curl "http://localhost:9200/_cat/nodes?v&amp;pretty"
ip         heap.percent ram.percent cpu load_1m load_5m load_15m node.role master name
172.19.0.4           48          86  35    4.86    2.90     1.84 dilmrt    *      es03
172.19.0.3           67          86  35    4.86    2.90     1.84 dlmrt     -      es02
172.19.0.2           45          86  35    4.86    2.90     1.84 dlmrt     -      es01			
			
		</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="idm254556159136"></a>8.1.6. Kubernetes</h3></div></div></div><pre class="screen">
			
apiVersion: v1
kind: ConfigMap
metadata:
  name: elasticsearch-logging-config
  namespace: kube-public
  labels:
    app: elasticsearch-logging
data:
  limits.conf: |-
    elasticsearch soft memlock unlimited
    elasticsearch hard memlock unlimited
    elasticsearch hard nofile 65536
    elasticsearch soft nofile 65536
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: elasticsearch-logging
  namespace: kube-public
  labels:
    app: elasticsearch-logging
spec:
  serviceName: elasticsearch-logging
  replicas: 1
  selector:
    matchLabels:
      app: elasticsearch-logging
  template:
    metadata:
      labels:
        app: elasticsearch-logging
    spec:
      initContainers:
      - name: elasticsearch-logging-init
        image: alpine:latest
        imagePullPolicy: IfNotPresent
        command: ["/sbin/sysctl", "-w", "vm.max_map_count=262144"]
        securityContext:
          privileged: true
      containers:
      - name: elasticsearch-logging
        image: docker.elastic.co/elasticsearch/elasticsearch:7.9.2
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            cpu: 200m
            # memory: "1Gi"
          requests:
            cpu: 200m
            # memory: "1Gi"
        env:
        - name: "NAMESPACE"
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: node.name
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: "cluster.name"
          value: "elasticsearch-cluster"
        - name: "bootstrap.memory_lock"
          # value: "true"
          value: "false"
        - name: "discovery.seed_hosts"
          value: "elasticsearch-logging-0,elasticsearch-logging-1,elasticsearch-logging-2"
        - name: "cluster.initial_master_nodes"
          value: "elasticsearch-logging-0"
        - name: "discovery.find_peers_interval"
          value: "5s"

        - name: "gateway.expected_nodes"
          value: "2"
        - name: "gateway.expected_master_nodes"
          value: "1"

        - name: "http.cors.enabled"
          value: "true"
        - name: "http.cors.allow-origin"
          value: "*"

        - name: "ES_JAVA_OPTS"
          value: "-Xms1g -Xmx1g"
        - name: RLIMIT_MEMLOCK
          value: "unlimited"
        ports:
        - containerPort: 9200
          name: restful
          protocol: TCP
        - containerPort: 9300
          name: transport
          protocol: TCP
        # readinessProbe:
        #     httpGet:
        #       scheme: HTTP
        #       path: /_cluster/health?local=true
        #       port: 9200
        #     initialDelaySeconds: 5  
        # livenessProbe:
        #   tcpSocket:
        #     port: transport
        #   initialDelaySeconds: 20
        #   periodSeconds: 10
        volumeMounts:
        - name: elasticsearch-config
          mountPath: /etc/security/limits.conf
          subPath: limits.conf
        - name: elasticsearch-data
          mountPath: /data
      volumes:
      - name: elasticsearch-data
        emptyDir: {}
        # hostPath:
          # path: /data
      - name: elasticsearch-config
        configMap:
          name: elasticsearch-logging-config
---
apiVersion: v1
kind: Service
metadata:
  name: elasticsearch-logging
  namespace: kube-public
  labels:
    k8s-app: elasticsearch-logging
    kubernetes.io/cluster-service: "true"
    kubernetes.io/name: "Elasticsearch"
spec:
  selector:
    app: elasticsearch-logging
  type: NodePort
  # type: ClusterIP
  # clusterIP: None
  ports:
  - name: restful
    port: 9200
    protocol: TCP
    targetPort: restful
    nodePort: 30092
  - name: transport
    port: 9300
    targetPort: transport
			
			
		</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="idm254556162752"></a>8.1.7. netkiller-devops 编排 elasticsearch</h3></div></div></div><p>创建 docker.py 文件</p><pre class="screen">
			
#!/usr/bin/env python3
from netkiller.docker import *
			
volume = Volumes('elasticsearch')
			
elasticsearch = Services('elasticsearch')
elasticsearch.container_name('elasticsearch').environment([
	'discovery.type=single-node',
	'ES_JAVA_OPTS=-Xms512m -Xmx2048m'
])
elasticsearch.image('docker.elastic.co/elasticsearch/elasticsearch:7.15.0').ports(['9200:9200','9300:9300']).volumes(['elasticsearch:/usr/share/elasticsearch/data'])

experiment = Composes('experiment')
experiment.version('3.9')
experiment.volumes(volume)
experiment.services(elasticsearch)

if __name__ == '__main__':
	try:
		docker = Docker()
		docker.sysctl([{'vm.max_map_count':'262144'}])
		docker.environment(experiment)
		docker.main()
	except KeyboardInterrupt:
		print ("Crtl+C Pressed. Shutting down.")
			
		</pre><p></p><pre class="screen">
			
[root@localhost ~]# python3 docker.py -e experiment -l
experiment :
     fluentd
     redis
     mongo
     mysql
     elasticsearch
     
[root@localhost ~]# python3 docker.py -e experiment up elasticsearch
Starting elasticsearch ... done

[root@localhost ~]# python3 docker.py -e experiment ps elasticsearch
    Name                   Command               State                                         Ports                                       
-------------------------------------------------------------------------------------------------------------------------------------------
elasticsearch   /bin/tini -- /usr/local/bi ...   Up      0.0.0.0:9200-&gt;9200/tcp,:::9200-&gt;9200/tcp, 0.0.0.0:9300-&gt;9300/tcp,:::9300-&gt;9300/tcp			
			
		</pre><p>测试</p><pre class="screen">
			
[root@localhost ~]# curl -s -X GET "localhost:9200/_cat/nodes?v=true&amp;pretty"
ip         heap.percent ram.percent cpu load_1m load_5m load_15m node.role   master name
172.21.0.2           16          99   5    1.68    0.60     0.26 cdfhilmrstw *      aeedaff1ac15			
			
		</pre><p>停止</p><pre class="screen">
			
[root@localhost ~]# python3 docker.py -e experiment stop elasticsearch
Stopping elasticsearch ... done			
			
		</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="version"></a>8.1.8. 安装指定版本的 Elasticsearch</h3></div></div></div><p>使用 yum 安装默认为最新版本，我们常常会遇到一个问题 elasticsearch-analysis-ik 的版本晚于 Elasticsearch。如果使用 yum 安装 Elasticsearch 可能 elasticsearch-analysis-ik 插件不支持这个版本，有些版本的 elasticsearch-analysis-ik 可以修改插件配置文件中的版本号，使其与elasticsearch版本相同，可以欺骗 elasticsearch 跳过版本不一致异常。</p><p> 最佳的解决方案是去 <a class="ulink" href="https://github.com/medcl/elasticsearch-analysis-ik" target="_top">elasticsearch-analysis-ik github</a> 找到兼容的版本，安装我们安装 elasticsearch-analysis-ik 的版本需求来指定安装 elasticsearch </p><p></p><pre class="screen">
Versions

IK version	ES version
master	5.x -&gt; master
5.6.0	5.6.0
5.5.3	5.5.3
5.4.3	5.4.3
5.3.3	5.3.3
5.2.2	5.2.2
5.1.2	5.1.2
1.10.1	2.4.1
1.9.5	2.3.5
1.8.1	2.2.1
1.7.0	2.1.1
1.5.0	2.0.0
1.2.6	1.0.0
1.2.5	0.90.x
1.1.3	0.20.x
1.0.0	0.16.2 -&gt; 0.19.0			
			</pre><p>最新版是 elasticsearch 5.6.1 但分词插件 elasticsearch-analysis-ik 仅能支持到 elasticsearch 版本是 5.6.0 </p><pre class="screen">
root@netkiller /var/log % yum --showduplicates list elasticsearch | expand | tail
Repository epel is listed more than once in the configuration  
elasticsearch.noarch                 5.5.3-1                  elasticsearch-5.x     
elasticsearch.noarch                 5.6.0-1                  elasticsearch-5.x   
elasticsearch.noarch                 5.6.1-1                  elasticsearch-5.x 
			</pre><p>安装 5.6.0</p><pre class="screen">
# yum install elasticsearch-5.6.0-1

Loaded plugins: fastestmirror, langpacks
Repository epel is listed more than once in the configuration
Loading mirror speeds from cached hostfile
Resolving Dependencies
--&gt; Running transaction check
---&gt; Package elasticsearch.noarch 0:5.6.0-1 will be installed
--&gt; Finished Dependency Resolution

Dependencies Resolved

==========================================================================================================================================================================================================
 Package                                            Arch                                        Version                                      Repository                                              Size
==========================================================================================================================================================================================================
Installing:
 elasticsearch                                      noarch                                      5.6.0-1                                      elasticsearch-5.x                                       32 M

Transaction Summary
==========================================================================================================================================================================================================
Install  1 Package

Total download size: 32 M
Installed size: 36 M
Is this ok [y/d/N]: y
			</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="plugin"></a>8.1.9. Plugin</h3></div></div></div><p>Elasticsearch 提供了插件管理命令 elasticsearch-plugin</p><pre class="screen">
root@netkiller ~ % /usr/share/elasticsearch/bin/elasticsearch-plugin -h
A tool for managing installed elasticsearch plugins

Commands
--------
list - Lists installed elasticsearch plugins
install - Install a plugin
remove - removes a plugin from Elasticsearch

Non-option arguments:
command              

Option         Description        
------         -----------        
-h, --help     show help          
-s, --silent   show minimal output
-v, --verbose  show verbose output			
			</pre><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="elasticsearch-analysis-ik"></a>8.1.9.1. elasticsearch-analysis-ik</h4></div></div></div><p>安装插件</p><pre class="screen">
root@netkiller ~ % /usr/share/elasticsearch/bin/elasticsearch-plugin install https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v5.5.1/elasticsearch-analysis-ik-5.5.1.zip
-&gt; Downloading https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v5.5.1/elasticsearch-analysis-ik-5.5.1.zip
[=================================================] 100%   
-&gt; Installed analysis-ik
				</pre><pre class="screen">
curl -XPOST http://localhost:9200/index/fulltext/_mapping -d'
{
        "properties": {
            "content": {
                "type": "text",
                "analyzer": "ik_max_word",
                "search_analyzer": "ik_max_word"
            }
        }
    
}'			
				</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="elasticsearch-analysis-pinyin"></a>8.1.9.2. elasticsearch-analysis-pinyin</h4></div></div></div><p>https://github.com/medcl/elasticsearch-analysis-pinyin</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="idm254556264304"></a>8.1.10. netkiller-devops 编排 Kubernetes</h3></div></div></div><p>参考《Netkiller Container 手札》</p></div></div></div><div xmlns="" id="SOHUCS"></div><script xmlns="" charset="utf-8" type="text/javascript" src="https://cy-cdn.kuaizhan.com/upload/changyan.js"></script><script xmlns="" type="text/javascript">
window.changyan.api.config({
appid: 'cyvwjQUG3',
conf: 'prod_ef966242df3d8b5acb1e0ee9fc01cafe'
});
</script><script xmlns="" type="text/javascript" id="clustrmaps" src="//cdn.clustrmaps.com/map_v2.js?u=r5HG&amp;d=9mi5r_kkDC8uxG8HuY3p4-2qgeeVypAK9vMD-2P6BYM"></script><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="../index.html">上一页</a> </td><td width="20%" align="center"><a accesskey="u" href="../index.html">上一级</a></td><td width="40%" align="right"> <a accesskey="n" href="document.html">下一页</a></td></tr><tr><td width="40%" align="left" valign="top">部分 II. Search Engine </td><td width="20%" align="center"><a accesskey="h" href="../../index.html">起始页</a></td><td width="40%" align="right" valign="top"> 8.2. 文档API</td></tr></table></div><script xmlns="">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-11694057-1', 'auto');
  ga('send', 'pageview');

</script><script xmlns="" async="async">
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?93967759a51cda79e49bf4e34d0b0f2c";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script xmlns="" async="async">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script></body></html>