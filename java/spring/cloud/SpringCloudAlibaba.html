<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>10.11. Spring Cloud Alibaba</title><link rel="stylesheet" type="text/css" href="../../docbook.css" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><link rel="home" href="../../index.html" title="Netkiller Java 手札（版）" /><link rel="up" href="index.html" title="第 10 章 Spring Cloud" /><link rel="prev" href="ch10s10.html" title="10.10. Spring Cloud with Kubernetes" /><link rel="next" href="cloud.faq.html" title="10.12. FAQ" /></head><body><a xmlns="" href="//www.netkiller.cn/">Home</a> | <a xmlns="" href="//netkiller.github.io/">简体中文</a> | <a xmlns="" href="http://netkiller.sourceforge.net/">繁体中文</a> | <a xmlns="" href="/journal/index.html">杂文</a>
		| <a xmlns="" href="https://github.com/netkiller">Github</a> | <a xmlns="" href="https://zhuanlan.zhihu.com/netkiller">知乎专栏</a> | <a xmlns="" href="https://edu.51cto.com/lecturer/1703915.html">51CTO学院</a> | <a xmlns="" href="https://edu.csdn.net/lecturer/6423">CSDN程序员研修院</a> | <a xmlns="" href="http://my.oschina.net/neochen/">OSChina 博客</a> | <a xmlns="" href="https://cloud.tencent.com/developer/column/2078">腾讯云社区</a> | <a xmlns="" href="https://yq.aliyun.com/u/netkiller/">阿里云栖社区</a> | <a xmlns="" href="https://www.facebook.com/bg7nyt">Facebook</a> | <a xmlns="" href="http://cn.linkedin.com/in/netkiller/">Linkedin</a> | <a xmlns="" href="https://www.youtube.com/user/bg7nyt/videos">Youtube</a> | <a xmlns="" href="//www.netkiller.cn/home/donations.html">打赏(Donations)</a> | <a xmlns="" href="//www.netkiller.cn/home/about.html">About</a><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">10.11. Spring Cloud Alibaba</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="ch10s10.html">上一页</a> </td><th width="60%" align="center">第 10 章 Spring Cloud</th><td width="20%" align="right"> <a accesskey="n" href="cloud.faq.html">下一页</a></td></tr></table><hr /></div><table xmlns=""><tr><td><iframe src="//ghbtns.com/github-btn.html?user=netkiller&amp;repo=netkiller.github.io&amp;type=watch&amp;count=true&amp;size=large" height="30" width="170" frameborder="0" scrolling="0" style="width:170px; height: 30px;" allowTransparency="true"></iframe></td><td><iframe src="//ghbtns.com/github-btn.html?user=netkiller&amp;repo=netkiller.github.io&amp;type=fork&amp;count=true&amp;size=large" height="30" width="170" frameborder="0" scrolling="0" style="width:170px; height: 30px;" allowTransparency="true"></iframe></td><td><iframe src="//ghbtns.com/github-btn.html?user=netkiller&amp;type=follow&amp;count=true&amp;size=large" height="30" width="240" frameborder="0" scrolling="0" style="width:240px; height: 30px;" allowTransparency="true"></iframe></td><td></td><td><a href="https://zhuanlan.zhihu.com/netkiller"><img src="/images/logo/zhihu-card-default.svg" height="25" /></a></td><td valign="middle"><a href="https://zhuanlan.zhihu.com/netkiller">知乎专栏</a> ｜ <a href="https://www.zhihu.com/club/1241768772601950208">多维度架构</a></td><td></td><td></td><td></td><td></td></tr></table><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="SpringCloudAlibaba"></a>10.11. Spring Cloud Alibaba</h2></div></div></div>
	
	<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="idm23627655200"></a>10.11.1. 安装 Nacos</h3></div></div></div>
		
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm23627654400"></a>10.11.1.1. Docker 安装 Nacos</h4></div></div></div>
			
			<p>安装 netkiller-devops 库</p>
			<pre class="screen">
		
pip install netkiller-devops		
		
			</pre>
			<p>创建 docker.py 编排文件</p>
			<pre class="screen">
		
#!/usr/bin/env python3
from netkiller.docker import *

volume = Volumes()
volume.create('mysql')

mysql = Services('mysql')
mysql.image('mysql:5.7').container_name('mysql').restart('always').hostname('db.netkiller.cn').env_file(os.getcwd()+'/nacos/env/mysql.env')
mysql.ports(['3306:3306']).volumes([
	'mysql:/var/lib/mysql'
]).command([
	'--socket=/var/lib/mysql/mysql.sock',
	'--default-authentication-plugin=mysql_native_password',
    '--character-set-server=utf8mb4',
    '--collation-server=utf8mb4_general_ci',
    '--explicit_defaults_for_timestamp=true',
    '--lower_case_table_names=1',
    '--max_execution_time=0'
])

nacos = Services('nacos')
nacos.container_name('nacos').env_file(os.getcwd()+'/nacos/env/nacos-mysql.env')
# .environment([
# 	'PREFER_HOST_MODE=hostname',
# 	'MODE=standalone'
# ])
nacos.image('nacos/nacos-server').volumes([
	'../nacos/logs/:/home/nacos/logs',
	'../nacos/init.d/custom.properties:/home/nacos/init.d/custom.properties'
]).ports([
	"8848:8848",
    "9848:9848",
	'9555:9555'
]).depends_on('mysql').restart('on-failure')

experiment = Composes('experiment')
experiment.version('3.9')
experiment.volumes(volume)
experiment.services(mysql)
experiment.services(nacos)

if __name__ == '__main__':
	try:
		docker = Docker()
		docker.sysctl([{'vm.max_map_count':'262144'}])
		docker.environment(experiment)
		docker.main()
	except KeyboardInterrupt:
		print ("Crtl+C Pressed. Shutting down.")
		
			</pre>
			<p>查看帮助信息</p>
			<pre class="screen">
		
[root@localhost ~]# python3 docker.py 
Python controls the docker manager.
Usage: docker.py [options] up|rm|start|stop|restart|logs|top|images|exec &lt;service&gt;

Options:
  -h, --help            show this help message and exit
  --debug               debug mode
  -e development|testing|production, --environment=development|testing|production
                        environment
  -d, --daemon          run as daemon
  --logfile=LOGFILE     logs file.
  -l, --list            print service of environment
  -f, --follow          following logging
  -c, --compose         show docker compose
  --export              export docker compose

Homepage: http://www.netkiller.cn	Author: Neo &lt;netkiller@msn.com&gt;		
		
			</pre>
			<p>启动 nacos</p>
			<pre class="screen">
		
[root@localhost ~]# python3 docker.py -e experiment up nacos
mysql is up-to-date
Starting nacos ... done

[root@localhost ~]# python3 docker.py -e experiment ps 
    Name                   Command               State                                                         Ports                                                      
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------                            
mysql           docker-entrypoint.sh --soc ...   Up      0.0.0.0:3306-&gt;3306/tcp,:::3306-&gt;3306/tcp, 33060/tcp                                                              
nacos           bin/docker-startup.sh            Up      0.0.0.0:8848-&gt;8848/tcp,:::8848-&gt;8848/tcp, 0.0.0.0:9555-&gt;9555/tcp,:::9555-&gt;9555/tcp,                              
                                                         0.0.0.0:9848-&gt;9848/tcp,:::9848-&gt;9848/tcp   		
		
			</pre>
			<p>查看启动端口</p>
			<pre class="screen">
		
[root@localhost ~]# ss -lnt | grep -E "(8848|9848)"
LISTEN 0      1024         0.0.0.0:8848       0.0.0.0:*          
LISTEN 0      1024         0.0.0.0:9848       0.0.0.0:*          
LISTEN 0      1024            [::]:8848          [::]:*          
LISTEN 0      1024            [::]:9848          [::]:*   		
		
			</pre>
			<p>测试配置中心</p>
			<pre class="screen">
		
[root@localhost ~]# curl -X POST "http://127.0.0.1:8848/nacos/v1/cs/configs?dataId=nacos.cfg.dataId&amp;group=test&amp;content=helloWorld"
true

[root@localhost ~]# curl -X GET "http://127.0.0.1:8848/nacos/v1/cs/configs?dataId=nacos.cfg.dataId&amp;group=test"
helloWorld
		
			</pre>
			<p>登陆 Web 界面 http://192.168.30.12:8848/nacos/ 默认的账号密码是：nacos/nacos </p>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm23627654144"></a>10.11.1.2. Kubernetes 安装 Nacos</h4></div></div></div>
			
			<p>创建 nacos 数据库用户</p>
			<pre class="programlisting">
			
CREATE USER 'nacos'@'%' IDENTIFIED BY 'nacos';

GRANT ALL PRIVILEGES ON nacos.* TO 'nacos'@'%';

SHOW GRANTS FOR 'nacos'@'%';			
			
			</pre>
			<p> 前往 <a class="ulink" href="https://github.com/alibaba/nacos/blob/master/distribution/conf/nacos-mysql.sql" target="_top">https://github.com/alibaba/nacos/blob/master/distribution/conf/nacos-mysql.sql</a>
				下来SQL文件，恢复到 nacos 数据中。 </p>
			<pre class="programlisting">
			
import sys
sys.path.insert(0, '/Users/neo/workspace/devops')
from netkiller.kubernetes import *
namespace = 'default'

config = ConfigMap('nacos')
config.apiVersion('v1')
config.metadata().name('nacos').namespace(namespace)
config.data({
    'mysql.host': "rm-bp1g441na9an26wsb.mysql.rds.aliyuncs.com",
    'mysql.port': "3306",
    'mysql.dbname': "nacos",
    'mysql.user': "nacos",
    'mysql.password': "nacos"
})
# config.debug()

statefulSet = StatefulSet()
statefulSet = StatefulSet()
statefulSet.apiVersion('apps/v1')
statefulSet.metadata().name('nacos').labels(
    {'app': 'nacos'}).namespace(namespace)
statefulSet.spec().replicas(3)
statefulSet.spec().serviceName('nacos')
statefulSet.spec().selector({'matchLabels': {'app': 'nacos'}})
statefulSet.spec().template().metadata().labels({'app': 'nacos'})
statefulSet.spec().template().metadata().annotations(
    {'pod.alpha.kubernetes.io/initialized': "true"})
# statefulSet.spec().template().spec().affinity().nodeAffinity({
#     'requiredDuringSchedulingIgnoredDuringExecution': [
#         {'labelSelector': {
#             'matchExpressions': [
#                 {'key': 'app',
#                  'operator': 'In',
#                  'values': ['nacos']
#                  }]
#             },
#         'topologyKey': "kubernetes.io/hostname"
#         }
#     ]
# })
statefulSet.spec().template().spec().containers().name('nacos').imagePullPolicy(Define.containers.imagePullPolicy.IfNotPresent).image(
    'nacos/nacos-server:latest').resources(
        # {'requests': {
        # # 'cpu':'200m',
        # 'memory': "2Gi"}}
        ).ports([
        {'name':'client','containerPort': 8848},
        {'name':'client-rpc','containerPort': 9848},
        {'name':'raft-rpc','containerPort': 9849}
    ]).env([
        {'name': 'TZ', 'value': 'Asia/Shanghai'},
        {'name': 'LANG', 'value': 'en_US.UTF-8'},
        {'name': 'NACOS_REPLICAS', 'value': '1'},

        # {'name': 'SPRING_DATASOURCE_PLATFORM', 'value': 'mysql'},
        # {'name': 'MYSQL_SERVICE_HOST', 'value': 'mysql-0.mysql.default.svc.cluster.local'},
        {'name': 'MYSQL_SERVICE_HOST', 'valueFrom':{'configMapKeyRef':{'name': 'nacos','key': 'mysql.host'}}},
        {'name': 'MYSQL_SERVICE_PORT', 'valueFrom':{'configMapKeyRef':{'name': 'nacos','key': 'mysql.port'}}},
        {'name': 'MYSQL_SERVICE_DB_NAME', 'valueFrom':{'configMapKeyRef':{'name': 'nacos','key': 'mysql.dbname'}}},
        {'name': 'MYSQL_SERVICE_USER', 'valueFrom':{'configMapKeyRef':{'name': 'nacos','key': 'mysql.user'}}},
        {'name': 'MYSQL_SERVICE_PASSWORD', 'valueFrom':{'configMapKeyRef':{'name': 'nacos','key': 'mysql.password'}}},
        # {'name': 'MYSQL_SERVICE_DB_PARAM', 'value': 'characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true&amp;useSSL=false&amp;serverTimezone=GMT%2B8'},
        
        {'name': 'NACOS_SERVER_PORT', 'value': '8848'},
        {'name': 'NACOS_APPLICATION_PORT', 'value': '8848'},
        {'name': 'PREFER_HOST_MODE', 'value': 'hostname'},
        {'name': 'NACOS_SERVERS', 'value': 'nacos-0.nacos.default.svc.cluster.local:8848 nacos-1.nacos.default.svc.cluster.local:8848 nacos-2.nacos.default.svc.cluster.local:8848'},

        # {'name': 'JVM_XMX', 'value': '4g'},
        # {'name': 'NACOS_DEBUG', 'value': 'true'},
        # {'name': 'TOMCAT_ACCESSLOG_ENABLED', 'value': 'true'},
    ])

# statefulSet.debug()

service = Service()
service.metadata().name('nacos')
service.metadata().namespace(namespace)
service.metadata().labels({'app':'nacos'})
service.spec().selector({'app': 'nacos'})
service.spec().type('ClusterIP')
service.spec().ports([
    {'name': 'server', 'protocol': 'TCP', 'port': 8848, 'targetPort': 8848},
    {'name': 'client-rpc', 'protocol': 'TCP', 'port': 9848, 'targetPort': 9848},
    {'name': 'raft-rpc', 'protocol': 'TCP', 'port': 9555, 'targetPort': 9555}
])

# service.debug()

ingress = Ingress()
ingress.apiVersion('networking.k8s.io/v1')
ingress.metadata().name('nacos')
ingress.metadata().namespace(namespace)
# ingress.metadata().annotations({'kubernetes.io/ingress.class': 'nginx'})
ingress.spec().rules([{
    'host': 'nacos.netkiller.com',
    'http':{
        'paths': [{
            'pathType': Define.Ingress.pathType.Prefix,
            'path': '/nacos', 
            'backend':{
                'service':{
                    'name':'nacos', 
                    'port':{'number': 8848}
                }
            }}]
}}])
# ingress.debug()

kubernetes = Kubernetes('/Volumes/Data/kubeconfig')
compose = Compose('nacos')
compose.add(config)
compose.add(statefulSet)
compose.add(service)
compose.add(ingress)
kubernetes.compose(compose)
kubernetes.main()

			
			</pre>
			<pre class="screen">
			
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm23627642160"></a>10.11.1.3. IP限制，白名单</h4></div></div></div>
			
			<pre class="screen">
			 
	location /nacos {
        allow 192.168.0.0/24;
        allow 172.18.0.0/16;
        allow 202.104.66.10;        
        deny all;

        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_pass http://192.168.0.10:8848;
    }
			
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm23627640512"></a>10.11.1.4. 防火墙配置</h4></div></div></div>
			
			<p>配置防火墙，限制 8848 端口的访问策略，防止本地或其他服务注册到 Nacos 中。</p>
			<pre class="screen">
			 
$ iptables -A INPUT -s 172.18.5.0/24 -p tcp --dport 8848 -j REJECT
			
			</pre>
			<p>172.18.5.0/24 是办公网络，添加上面IP规则，可以防止开发人的电脑注册到测试环境。</p>
			<p>删除规则</p>
			<p>删除方法一</p>
			<pre class="screen">
			 
$ iptables -L -n --line-number | grep 8848
8    REJECT     tcp  --  172.18.5.0/24        0.0.0.0/0            tcp dpt:8848 reject-with icmp-port-unreachable
134  ACCEPT     tcp  --  0.0.0.0/0            172.17.0.119         tcp dpt:8848

$ iptables -D INPUT 8
			
			</pre>
			<p>删除方法二</p>
			<pre class="screen">
			 
$ iptables -D INPUT -s 172.18.5.0/24 -p tcp --dport 8848 -j REJECT
			
			</pre>
		</div>
	</div>
	<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="idm23627635856"></a>10.11.2. Kubernetes 部署微服务</h3></div></div></div>
		
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm23627634960"></a>10.11.2.1. pom.xml 中加入 docker 插件</h4></div></div></div>
			
			<pre class="programlisting">
			
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;
	&lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

	&lt;groupId&gt;com.example&lt;/groupId&gt;
	&lt;artifactId&gt;demo&lt;/artifactId&gt;
	&lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;
	&lt;packaging&gt;jar&lt;/packaging&gt;

	&lt;name&gt;demo&lt;/name&gt;
	&lt;description&gt;Demo project for Spring Boot&lt;/description&gt;

	&lt;parent&gt;
		&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
		&lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;
		&lt;version&gt;2.6.3&lt;/version&gt;
		&lt;relativePath /&gt; &lt;!-- lookup parent from repository --&gt;
	&lt;/parent&gt;

	&lt;properties&gt;
		&lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;
		&lt;project.reporting.outputEncoding&gt;UTF-8&lt;/project.reporting.outputEncoding&gt;
		&lt;java.version&gt;1.8&lt;/java.version&gt;

		&lt;sonar.projectKey&gt;netkiller.cn_java_AX0HsoVkT19KeT2iVgUT&lt;/sonar.projectKey&gt;
		&lt;sonar.qualitygate.wait&gt;true&lt;/sonar.qualitygate.wait&gt;

		&lt;docker.registry&gt;registry.netkiller.cn/netkiller.cn&lt;/docker.registry&gt;

	&lt;/properties&gt;

	&lt;repositories&gt;
		&lt;repository&gt;
			&lt;id&gt;gitlab-maven&lt;/id&gt;
			&lt;url&gt;${env.CI_API_V4_URL}/projects/${env.CI_PROJECT_ID}/packages/maven&lt;/url&gt;
		&lt;/repository&gt;
	&lt;/repositories&gt;
	&lt;distributionManagement&gt;
		&lt;repository&gt;
			&lt;id&gt;gitlab-maven&lt;/id&gt;
			&lt;url&gt;${CI_API_V4_URL}/projects/${env.CI_PROJECT_ID}/packages/maven&lt;/url&gt;
		&lt;/repository&gt;
		&lt;snapshotRepository&gt;
			&lt;id&gt;gitlab-maven&lt;/id&gt;
			&lt;url&gt;${CI_API_V4_URL}/projects/${env.CI_PROJECT_ID}/packages/maven&lt;/url&gt;
		&lt;/snapshotRepository&gt;
	&lt;/distributionManagement&gt;

	&lt;dependencies&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
			&lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
		&lt;/dependency&gt;

		&lt;dependency&gt;
			&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
			&lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;
			&lt;scope&gt;test&lt;/scope&gt;
		&lt;/dependency&gt;

		&lt;dependency&gt;
			&lt;groupId&gt;junit&lt;/groupId&gt;
			&lt;artifactId&gt;junit&lt;/artifactId&gt;
			&lt;!-- &lt;version&gt;4.13.2&lt;/version&gt; --&gt;
			&lt;scope&gt;test&lt;/scope&gt;
		&lt;/dependency&gt;

	&lt;/dependencies&gt;

	&lt;build&gt;
		&lt;plugins&gt;
			&lt;plugin&gt;
				&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
				&lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;
			&lt;/plugin&gt;
			&lt;plugin&gt;
				&lt;groupId&gt;com.spotify&lt;/groupId&gt;
				&lt;artifactId&gt;docker-maven-plugin&lt;/artifactId&gt;
				&lt;version&gt;1.2.2&lt;/version&gt;
				&lt;configuration&gt;
					&lt;imageName&gt;${docker.registry}/${project.artifactId}&lt;/imageName&gt;
					&lt;baseImage&gt;openjdk:8-alpine&lt;/baseImage&gt;
					&lt;maintainer&gt;netkiller@msn.com&lt;/maintainer&gt;
					&lt;volumes&gt;/srv&lt;/volumes&gt;
					&lt;workdir&gt;/srv&lt;/workdir&gt;
					&lt;env&gt;
						&lt;JAVA_OPTS&gt;-server -Xms512m -Xmx4096m -Djava.security.egd=file:/dev/./urandom&lt;/JAVA_OPTS&gt;
					&lt;/env&gt;
					&lt;exposes&gt;8080&lt;/exposes&gt;
					&lt;entryPoint&gt;["sh", "-c", "/srv/docker-entrypoint.sh"]&lt;/entryPoint&gt;
					&lt;resources&gt;
						&lt;resource&gt;
							&lt;targetPath&gt;/srv&lt;/targetPath&gt;
							&lt;directory&gt;${project.build.directory}&lt;/directory&gt;
							&lt;include&gt;${project.build.finalName}.jar&lt;/include&gt;
						&lt;/resource&gt;
						&lt;resource&gt;
							&lt;targetPath&gt;/srv&lt;/targetPath&gt;
							&lt;directory&gt;.&lt;/directory&gt;
							&lt;include&gt;docker-entrypoint.sh&lt;/include&gt;
						&lt;/resource&gt;
					&lt;/resources&gt;
					&lt;registryUrl&gt;http://${docker.registry}/v2/&lt;/registryUrl&gt;
					&lt;imageTags&gt;
						&lt;imageTag&gt;${project.version}&lt;/imageTag&gt;
						&lt;imageTag&gt;latest&lt;/imageTag&gt;
					&lt;/imageTags&gt;
				&lt;/configuration&gt;
			&lt;/plugin&gt;
		&lt;/plugins&gt;
	&lt;/build&gt;
&lt;/project&gt;			
			
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm23627633568"></a>10.11.2.2. 容器启动脚本</h4></div></div></div>
			
			<p>在项目目录创建 docker-entrypoint.sh 文件</p>
			<pre class="programlisting">
			
#!/bin/sh

if [ ! -z $1 ]; then
    MODULE=$1
    shift
fi

if [ -z $JAVA_OPTS ]; then
    JAVA_OPTS='-Xms1024m -Xmx4096m -XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=512m -Djava.security.egd=file:/dev/./urandom -Duser.timezone=GMT+8 -Dfile.encoding=utf-8'
fi

if [ -z $MODULE ]; then
    echo "MODULE environment is not set"
    exit 127
else
    PACKAGE=/srv/$MODULE.jar
fi

DEBUG='-Xdebug -Xrunjdwp:transport=dt_socket,suspend=n,server=y,address=5555'
SKYWALKING="-javaagent:/srv/skywalking/agent/skywalking-agent.jar -Dskywalking.collector.backend_service=oap.netkiller.cn:11800 -Dskywalking.agent.service_name=${MODULE}"

exec java ${JAVA_OPTS}  -jar ${PACKAGE} $@			
			
			</pre>
			<p>暂时 DEBUG，SKYWALKING 没有使用，放在一遍不碍事。脚本的用法</p>
			<pre class="screen">
			
./docker-entrypoint.sh your_module --server.port=8080
			
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm23627630304"></a>10.11.2.3. 构建 docker 镜像</h4></div></div></div>
			
			<p>运行 mvn 命令构建 docker 镜像</p>
			<pre class="screen">
			
neo@Netkiller-iMac ~/w/java.netkiller.cn (master)&gt; mvn package docker:build docker:push			
			
			</pre>
			<p>不出预料，你会看到下面输出</p>
			<pre class="screen">
			
[INFO] Building image registry.netkiller.cn/netkiller.cn/demo
Step 1/9 : FROM openjdk:8-alpine

 ---&gt; a3562aa0b991
Step 2/9 : MAINTAINER netkiller@msn.com

 ---&gt; Using cache
 ---&gt; b4a79be602ae
Step 3/9 : ENV JAVA_OPTS -server -Xms512m -Xmx4096m -Djava.security.egd=file:/dev/./urandom

 ---&gt; Using cache
 ---&gt; 9d685ea4a0d3
Step 4/9 : WORKDIR /srv

 ---&gt; Using cache
 ---&gt; e2feea451bb1
Step 5/9 : ADD /srv/demo-0.0.1-SNAPSHOT.jar /srv/

 ---&gt; 7ad53fb991b8
Step 6/9 : ADD /srv/docker-entrypoint.sh /srv/

 ---&gt; 39def6507064
Step 7/9 : EXPOSE 8080

 ---&gt; Running in 338a99e6ec36
Removing intermediate container 338a99e6ec36
 ---&gt; f192b73ab3b9
Step 8/9 : ENTRYPOINT ["sh", "-c", "/srv/docker-entrypoint.sh"]

 ---&gt; Running in 5bda82acd305
Removing intermediate container 5bda82acd305
 ---&gt; 85c1b2615a97
Step 9/9 : VOLUME /srv

 ---&gt; Running in 27d71c55bf7e
Removing intermediate container 27d71c55bf7e
 ---&gt; 64e0d8992fdd
ProgressMessage{id=null, status=null, stream=null, error=null, progress=null, progressDetail=null}
Successfully built 64e0d8992fdd
Successfully tagged registry.netkiller.cn/netkiller.cn/demo:latest
[INFO] Built registry.netkiller.cn/netkiller.cn/demo
[INFO] Tagging registry.netkiller.cn/netkiller.cn/demo with 0.0.1-SNAPSHOT
[INFO] Tagging registry.netkiller.cn/netkiller.cn/demo with latest
			
			</pre>
			<p>查看镜像</p>
			<pre class="screen">
			
neo@Netkiller-iMac ~/w/java.netkiller.cn (master)&gt; docker image ls | grep netkiller
registry.netkiller.cn/netkiller.cn/demo                       0.0.1-SNAPSHOT   64e0d8992fdd   3 minutes ago    122MB
registry.netkiller.cn/netkiller.cn/demo                       latest           64e0d8992fdd   3 minutes ago    122MB			
			
			</pre>
		</div>

		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm23627626464"></a>10.11.2.4. 编排 kubernetes 容器</h4></div></div></div>
			
			<pre class="programlisting">
			
from netkiller.kubernetes import *
namespace = 'default'

compose = Compose('development')

module = 'demo'
# version = '0.0.1-SNAPSHOT'
version = 'latest'

deployment = Deployment()
deployment.apiVersion('apps/v1')

deployment.metadata().name(module).labels({'app': module}).namespace(namespace)
deployment.spec().replicas(1)
deployment.spec().selector({'matchLabels': {'app': module}})
deployment.spec().template().metadata().labels({'app': module})
deployment.spec().template().spec().containers().name(module).image(
    'registry.netkiller.cn/netkiller.cn/cloud.netkiller.cn:%s' % version).ports([{
        'containerPort': 8080
    }]).env([
        {'name': 'TZ', 'value': 'Asia/Shanghai'},
        {'name': 'LANG', 'value': 'en_US.UTF-8'},
    ]).args([module,'--server.port=8080'])

# deployment.debug()
# deployment.json()

service = Service()
service.metadata().name(module)
service.metadata().namespace(namespace)
service.spec().selector({'app': module})
service.spec().type('NodePort')
service.spec().ports([{
    'name': 'http',
    'protocol': 'TCP',
    'port': 8080,
    'targetPort': 8080
}])

compose.add(deployment)
compose.add(service)

print("=" * 40, "Compose", "=" * 40)
compose.debug()
compose.delete()
compose.create()⏎  			
			
			</pre>
			<p>查看容器运行状态</p>
			<pre class="screen">
			
neo@Netkiller-iMac ~/w/java.netkiller.cn (master)&gt; kubectl get pods
NAME                       READY   STATUS             RESTARTS   AGE
nginx-88c84c4d8-8pmzp      1/1     Running            1          3d20h
demo-76b7598b76-5hstp      1/1     Running            0          5h43m
busybox                    0/1     CrashLoopBackOff   52         4h44m			
			
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm23627623984"></a>10.11.2.5. 启动指定 nacos</h4></div></div></div>
			
			<p>容器中不方便修改配置文件，我们可以使用环境变量覆盖配置</p>
			<pre class="screen">
			 
JAVA_OPTS=-Dspring.cloud.nacos.username=nacos \
-Dspring.cloud.nacos.password=nacos \
-Dspring.cloud.nacos.config.server-addr=mse-032dbef0-nacos-ans.mse.aliyuncs.com:8848 \
-Dspring.cloud.nacos.discovery.server-addr=mse-032dbef0-nacos-ans.mse.aliyuncs.com:8848 \
			
			</pre>
			<p>相当于</p>
			<pre class="screen">
			 
java -Dspring.cloud.nacos.username=nacos \
-Dspring.cloud.nacos.password=nacos \
-Dspring.cloud.nacos.config.server-addr=mse-032dbef0-nacos-ans.mse.aliyuncs.com:8848 \
-Dspring.cloud.nacos.discovery.server-addr=mse-032dbef0-nacos-ans.mse.aliyuncs.com:8848 \
-jar netkiller.jar
			
			</pre>
		</div>
	</div>

	<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="idm23627620912"></a>10.11.3. Nacos 配置中心/注册中心代码实例</h3></div></div></div>
		
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm23627619936"></a>10.11.3.1. Maven</h4></div></div></div>
			
			<pre class="screen">
			
&lt;project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;
	&lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
	&lt;groupId&gt;cn.netkiller&lt;/groupId&gt;
	&lt;artifactId&gt;bottleneck&lt;/artifactId&gt;
	&lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;
	&lt;name&gt;bottleneck&lt;/name&gt;
	&lt;description&gt;bottleneck&lt;/description&gt;
	&lt;organization&gt;
		&lt;name&gt;Netkiller Spring Cloud 手札&lt;/name&gt;
		&lt;url&gt;https://www.netkiller.cn&lt;/url&gt;
	&lt;/organization&gt;
	&lt;developers&gt;
		&lt;developer&gt;
			&lt;name&gt;Neo&lt;/name&gt;
			&lt;email&gt;netkiller@msn.com&lt;/email&gt;
			&lt;organization&gt;Netkiller Spring Cloud 手札&lt;/organization&gt;
			&lt;organizationUrl&gt;https://www.netkiller.cn&lt;/organizationUrl&gt;
			&lt;roles&gt;
				&lt;role&gt;Author&lt;/role&gt;
			&lt;/roles&gt;
		&lt;/developer&gt;
	&lt;/developers&gt;
	&lt;parent&gt;
		&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
		&lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;
		&lt;version&gt;2.7.3&lt;/version&gt;
		&lt;relativePath /&gt;
	&lt;/parent&gt;
	&lt;properties&gt;
		&lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;
	&lt;/properties&gt;
	&lt;dependencies&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
			&lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
			&lt;!-- Exclude the Tomcat dependency --&gt;
			&lt;exclusions&gt;
				&lt;exclusion&gt;
					&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
					&lt;artifactId&gt;spring-boot-starter-tomcat&lt;/artifactId&gt;
				&lt;/exclusion&gt;
			&lt;/exclusions&gt;
		&lt;/dependency&gt;
		&lt;!-- Use Undertow instead Tomcat --&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
			&lt;artifactId&gt;spring-boot-starter-undertow&lt;/artifactId&gt;
		&lt;/dependency&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
			&lt;artifactId&gt;spring-boot-starter-webflux&lt;/artifactId&gt;
		&lt;/dependency&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
			&lt;artifactId&gt;spring-boot-starter-jdbc&lt;/artifactId&gt;
		&lt;/dependency&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
			&lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;
		&lt;/dependency&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
			&lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;
			&lt;scope&gt;test&lt;/scope&gt;
		&lt;/dependency&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;mysql&lt;/groupId&gt;
			&lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;
		&lt;/dependency&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
			&lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;
			&lt;exclusions&gt;
				&lt;exclusion&gt;
					&lt;groupId&gt;io.lettuce&lt;/groupId&gt;
					&lt;artifactId&gt;lettuce-core&lt;/artifactId&gt;
				&lt;/exclusion&gt;
			&lt;/exclusions&gt;
		&lt;/dependency&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;redis.clients&lt;/groupId&gt;
			&lt;artifactId&gt;jedis&lt;/artifactId&gt;
		&lt;/dependency&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;org.springframework.data&lt;/groupId&gt;
			&lt;artifactId&gt;spring-data-commons&lt;/artifactId&gt;
		&lt;/dependency&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;org.projectlombok&lt;/groupId&gt;
			&lt;artifactId&gt;lombok&lt;/artifactId&gt;
		&lt;/dependency&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
			&lt;artifactId&gt;spring-boot-starter-data-elasticsearch&lt;/artifactId&gt;
		&lt;/dependency&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
			&lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-config&lt;/artifactId&gt;
			&lt;version&gt;2.2.9.RELEASE&lt;/version&gt;
		&lt;/dependency&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
			&lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;
			&lt;version&gt;2.2.9.RELEASE&lt;/version&gt;
		&lt;/dependency&gt;

		&lt;!-- https://mvnrepository.com/artifact/org.fluentd/fluent-logger --&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;org.fluentd&lt;/groupId&gt;
			&lt;artifactId&gt;fluent-logger&lt;/artifactId&gt;
			&lt;version&gt;0.3.4&lt;/version&gt;
		&lt;/dependency&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;com.sndyuk&lt;/groupId&gt;
			&lt;artifactId&gt;logback-more-appenders&lt;/artifactId&gt;
			&lt;version&gt;1.8.7&lt;/version&gt;
		&lt;/dependency&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
			&lt;artifactId&gt;spring-cloud-context&lt;/artifactId&gt;
			&lt;version&gt;3.1.4&lt;/version&gt;
		&lt;/dependency&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
			&lt;artifactId&gt;spring-cloud-commons&lt;/artifactId&gt;
			&lt;version&gt;3.1.4&lt;/version&gt;
		&lt;/dependency&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
			&lt;artifactId&gt;spring-cloud-starter-loadbalancer&lt;/artifactId&gt;
			&lt;version&gt;3.1.4&lt;/version&gt;
		&lt;/dependency&gt;

		&lt;dependency&gt;
			&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
			&lt;artifactId&gt;spring-cloud-starter-bootstrap&lt;/artifactId&gt;
			&lt;version&gt;3.1.4&lt;/version&gt;
		&lt;/dependency&gt;
	&lt;/dependencies&gt;
	&lt;build&gt;
		&lt;plugins&gt;
			&lt;plugin&gt;
				&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
				&lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;
				&lt;configuration&gt;
					&lt;mainClass&gt;cn.netkiller.Application&lt;/mainClass&gt;
				&lt;/configuration&gt;
			&lt;/plugin&gt;
			&lt;plugin&gt;
				&lt;artifactId&gt;maven-surefire-plugin&lt;/artifactId&gt;
				&lt;configuration&gt;
					&lt;skip&gt;true&lt;/skip&gt;
				&lt;/configuration&gt;
			&lt;/plugin&gt;

			&lt;plugin&gt;
				&lt;groupId&gt;com.spotify&lt;/groupId&gt;
				&lt;artifactId&gt;docker-maven-plugin&lt;/artifactId&gt;
				&lt;version&gt;1.2.2&lt;/version&gt;
				&lt;configuration&gt;
					&lt;imageName&gt;netkiller/${project.artifactId}&lt;/imageName&gt;
					&lt;baseImage&gt;openjdk:19-alpine&lt;/baseImage&gt;
					&lt;maintainer&gt;netkiller@msn.com&lt;/maintainer&gt;
					&lt;volumes&gt;/tmp&lt;/volumes&gt;
					&lt;workdir&gt;/srv&lt;/workdir&gt;
					&lt;exposes&gt;8080&lt;/exposes&gt;
					&lt;env&gt;
						&lt;JAVA_OPTS&gt;-server -Xms128m -Xmx2048m&lt;/JAVA_OPTS&gt;
					&lt;/env&gt;
					&lt;entryPoint&gt;["sh", "-c", "java ${JAVA_OPTS} -jar /srv/${project.build.finalName}.jar ${SPRING_OPTS}"]&lt;/entryPoint&gt;
					&lt;resources&gt;
						&lt;resource&gt;
							&lt;targetPath&gt;/srv&lt;/targetPath&gt;
							&lt;directory&gt;${project.build.directory}&lt;/directory&gt;
							&lt;include&gt;${project.build.finalName}.jar&lt;/include&gt;
						&lt;/resource&gt;
					&lt;/resources&gt;
					&lt;image&gt;netkiller/${project.artifactId}&lt;/image&gt;
					&lt;newName&gt;netkiller/${project.artifactId}:${project.version}&lt;/newName&gt;
					&lt;!-- &lt;serverId&gt;docker-hub&lt;/serverId&gt; --&gt;
					&lt;registryUrl&gt;http://${docker.registry}/v2/&lt;/registryUrl&gt;
					&lt;imageTags&gt;
						&lt;imageTag&gt;undertow&lt;/imageTag&gt;
						&lt;!-- &lt;imageTag&gt;tomcat&lt;/imageTag&gt; &lt;imageTag&gt;${project.version}&lt;/imageTag&gt; &lt;imageTag&gt;latest&lt;/imageTag&gt; --&gt;
					&lt;/imageTags&gt;
				&lt;/configuration&gt;
			&lt;/plugin&gt;
		&lt;/plugins&gt;
	&lt;/build&gt;
&lt;/project&gt;			
			
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm23627618704"></a>10.11.3.2. SpringBootApplication</h4></div></div></div>
			
			<pre class="screen">
			
package cn.netkiller;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;

@EnableDiscoveryClient
@SpringBootApplication
public class Application {

	public static void main(String[] args) {
		System.out.println("Netkiller bottleneck tool!");
		SpringApplication.run(Application.class, args);
	}
}			
			
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm23627616960"></a>10.11.3.3. ConfigController</h4></div></div></div>
			
			<pre class="screen">
			
package cn.netkiller.controller;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.cloud.context.config.annotation.RefreshScope;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

@RefreshScope
@RestController
public class ConfigController {

	public ConfigController() {
		// TODO Auto-generated constructor stub
	}

	@Value("${key}")
	public String name;

	@GetMapping("/config")
	public String config() {

		String name = this.name;
		return name;
	}
}
			
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm23627615056"></a>10.11.3.4. 配置文件</h4></div></div></div>
			
			<pre class="screen">
			
#debug=true
server.port=8080

#server.tomcat.max-connections=10000
#server.tomcat.max-threads=4096
#server.tomcat.accept-count=1000
#server.tomcat.min-spare-threads=100

server.undertow.max-http-post-size=0 
server.undertow.io-threads=16
server.undertow.worker-threads=4096
server.undertow.buffer-size=1024
server.undertow.buffers-per-region=1024
server.undertow.direct-buffers=true

spring.application.name=bottleneck
spring.profiles.active=dev
#spring.profiles.active=test
##spring.profiles.active=prod
#
#logging.file.path=/tmp
##logging.file.name=spring.log
#
endpoints.metrics.enabled=true
management.endpoints.jmx.exposure.include=*
management.endpoints.web.exposure.include=*
management.endpoints.health.show-details=always
#
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver
spring.datasource.url=jdbc:mysql://172.18.200.5:3306/test?useUnicode=true&amp;characterEncoding=UTF-8
spring.datasource.username=root
spring.datasource.password=passw0rd

spring.datasource.type=com.zaxxer.hikari.HikariDataSource
spring.datasource.hikari.minimum-idle=5
spring.datasource.hikari.maximum-pool-size=200
spring.datasource.hikari.auto-commit=true
spring.datasource.hikari.idle-timeout=30000
spring.datasource.hikari.pool-name=Hikari
spring.datasource.hikari.max-lifetime=55000
spring.datasource.hikari.connection-timeout=30000
spring.datasource.hikari.connection-test-query=SELECT 1

spring.redis.host=172.18.200.5
spring.redis.port=6379
spring.redis.password=passw0rd
spring.redis.database=0

spring.redis.jedis.pool.max-active=1000
spring.redis.jedis.pool.max-idle=80
spring.redis.jedis.pool.min-idle=20
spring.redis.jedis.pool.max-wait=-1

spring.cloud.nacos.server-addr=nacos.netkiller.cn:8848
spring.cloud.nacos.username=neo
spring.cloud.nacos.password=netkiller

#spring.cloud.nacos.config.enable-remote-sync-config=true
spring.cloud.nacos.config.namespace=${spring.profiles.active}
spring.cloud.nacos.config.group=DEFAULT_GROUP
spring.cloud.nacos.config.prefix=${spring.application.name}
spring.cloud.nacos.config.file-extension=yaml
spring.cloud.nacos.discovery.service=${spring.application.name:DEFAULT-SERVICE-NAME}
spring.cloud.nacos.discovery.namespace=${spring.profiles.active}
			
			</pre>
		</div>
	</div>

	<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="idm23627613904"></a>10.11.4. FAQ</h3></div></div></div>
		
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm23627612944"></a>10.11.4.1. 禁用 Nacos</h4></div></div></div>
			
			<p>当 Maven 引入了 nacos 依赖，启动就会要求配置 Nacos，可以通过下面方法禁用 Nacos</p>
			<pre class="screen">
			
spring.cloud.nacos.config.enabled=false  
spring.cloud.nacos.discovery.enabled=false 
spring.cloud.nacos.config.refresh-enabled=false
spring.cloud.nacos.discovery.instance-enabled=false			
			
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm23627610992"></a>10.11.4.2. 禁止注册</h4></div></div></div>
			
			<p>有时我们希望只获取配置，并不希望服务注册</p>
			<p>register-enabled: false</p>
			<pre class="screen">
			
spring:
  profiles:
    active: dev
  application:
    name: netkiller
  main:
    allow-bean-definition-overriding: true
  cloud:
    nacos:
      username: dev
      password: passw0rd
      config:
        server-addr: http://${spring.profiles.active}.netkiller.cn:8848
        file-extension: yaml
        enabled: true
        namespace: ${spring.profiles.active}
        enable-remote-sync-config: true
      discovery:
        server-addr: http://${spring.profiles.active}.netkiller.cn:8848
        namespace: ${spring.profiles.active}
        register-enabled: true			
			
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm23627608896"></a>10.11.4.3. Failed to bind properties under 'server.tomcat.basedir' to java.io.File:</h4></div></div></div>
			
			<p>环境 Docker 安装 nacos 提示 server.tomcat.basedir 错误</p>
			<pre class="screen">
			
nacos  | ***************************
nacos  | APPLICATION FAILED TO START
nacos  | ***************************
nacos  | 
nacos  | Description:
nacos  | 
nacos  | Failed to bind properties under 'server.tomcat.basedir' to java.io.File:
nacos  | 
nacos  |     Property: server.tomcat.basedir
nacos  |     Value: 
nacos  |     Origin: InputStream resource [resource loaded through InputStream] - 34:0
nacos  |     Reason: failed to convert java.lang.String to java.io.File (caused by java.lang.IllegalStateException: Could not retrieve file for class path resource []: class path resource [] cannot be resolved to absolute file path because it does not reside in the file system: jar:file:/home/nacos/target/nacos-server.jar!/BOOT-INF/classes!/)
nacos  | 
nacos  | Action:
nacos  | 
nacos  | Update your application's configuration			
			
			</pre>
			<p>解决方案</p>
			<p>进入容器复制 application.properties 文件到本地，修改 server.tomcat.basedir= 配置，改为
				server.tomcat.basedir=. 然后在挂载到容器卷中。</p>
			<pre class="screen">
			
[root@cloud ops.sfzito.com]# docker run -it --entrypoint sh  nacos/nacos-server
sh-4.2# cat /home/nacos/conf/application.properties 
# spring
server.servlet.contextPath=${SERVER_SERVLET_CONTEXTPATH:/nacos}
server.contextPath=/nacos
server.port=${NACOS_APPLICATION_PORT:8848}
spring.datasource.platform=${SPRING_DATASOURCE_PLATFORM:""}
nacos.cmdb.dumpTaskInterval=3600
nacos.cmdb.eventTaskInterval=10
nacos.cmdb.labelTaskInterval=300
nacos.cmdb.loadDataAtStart=false
db.num=${MYSQL_DATABASE_NUM:1}
db.url.0=jdbc:mysql://${MYSQL_SERVICE_HOST}:${MYSQL_SERVICE_PORT:3306}/${MYSQL_SERVICE_DB_NAME}?${MYSQL_SERVICE_DB_PARAM:characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true&amp;useSSL=false}
db.url.1=jdbc:mysql://${MYSQL_SERVICE_HOST}:${MYSQL_SERVICE_PORT:3306}/${MYSQL_SERVICE_DB_NAME}?${MYSQL_SERVICE_DB_PARAM:characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true&amp;useSSL=false}
db.user=${MYSQL_SERVICE_USER}
db.password=${MYSQL_SERVICE_PASSWORD}

### The auth system to use, currently only 'nacos' and 'ldap' is supported:
nacos.core.auth.system.type=${NACOS_AUTH_SYSTEM_TYPE:nacos}

### worked when nacos.core.auth.system.type=nacos
### The token expiration in seconds:
nacos.core.auth.plugin.nacos.token.expire.seconds=${NACOS_AUTH_TOKEN_EXPIRE_SECONDS:18000}
### The default token:
nacos.core.auth.plugin.nacos.token.secret.key=${NACOS_AUTH_TOKEN:SecretKey012345678901234567890123456789012345678901234567890123456789}

### Turn on/off caching of auth information. By turning on this switch, the update of auth information would have a 15 seconds delay.
nacos.core.auth.caching.enabled=${NACOS_AUTH_CACHE_ENABLE:false}
nacos.core.auth.enable.userAgentAuthWhite=${NACOS_AUTH_USER_AGENT_AUTH_WHITE_ENABLE:false}
nacos.core.auth.server.identity.key=${NACOS_AUTH_IDENTITY_KEY:serverIdentity}
nacos.core.auth.server.identity.value=${NACOS_AUTH_IDENTITY_VALUE:security}
server.tomcat.accesslog.enabled=${TOMCAT_ACCESSLOG_ENABLED:false}
server.tomcat.accesslog.pattern=%h %l %u %t "%r" %s %b %D
# default current work dir
server.tomcat.basedir=
## spring security config
### turn off security
nacos.security.ignore.urls=${NACOS_SECURITY_IGNORE_URLS:/,/error,/**/*.css,/**/*.js,/**/*.html,/**/*.map,/**/*.svg,/**/*.png,/**/*.ico,/console-fe/public/**,/v1/auth/**,/v1/console/health/**,/actuator/**,/v1/console/server/**}
# metrics for elastic search
management.metrics.export.elastic.enabled=false
management.metrics.export.influx.enabled=false

nacos.naming.distro.taskDispatchThreadCount=10
nacos.naming.distro.taskDispatchPeriod=200
nacos.naming.distro.batchSyncKeyCount=1000
nacos.naming.distro.initDataRatio=0.9
nacos.naming.distro.syncRetryDelay=5000
nacos.naming.data.warmup=true

			
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm23627604336"></a>10.11.4.4. 不读取 bootstrap.yaml 文件</h4></div></div></div>
			
			<p>Nacos 是一个独立项目，并不依赖 Spring Cloud，如果只是想使用配置中心，在 Springboot 中引入 Nacos 依赖，你会发现
				Springboot 不读取 bootstrap.yaml。</p>
			<p>解决方法</p>
			<pre class="screen">
			
		&lt;dependency&gt;
			&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
			&lt;artifactId&gt;spring-cloud-starter-bootstrap&lt;/artifactId&gt;
			&lt;version&gt;3.1.4&lt;/version&gt;
		&lt;/dependency&gt;			
			
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm23627601824"></a>10.11.4.5. WARN [com.alibaba.nacos.client.naming:177] [,] - out of date data received,
				old-t: 1665711914993, new-t: 1665711902390</h4></div></div></div>
			
			<p>出错信息如下，故障是因为每个节点的时间不同步造成的。</p>
			<pre class="screen">
			
[2022-10-14 09:44:51.289 [com.alibaba.nacos.naming.push.receiver] WARN [com.alibaba.nacos.client.naming:177] [,] - out of date data received, old-t: 1665711914993, new-t: 1665711902390
			
			</pre>
			<p>解决方法，安装时间同步软件。例如 NTP</p>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm23627599344"></a>10.11.4.6. User limit of inotify instances reached or too many open files</h4></div></div></div>
			
			<pre class="screen">
			
nacos  | 09:22:23.431 [main] ERROR org.springframework.boot.SpringApplication - Application run failed
nacos  | com.alibaba.nacos.api.exception.runtime.NacosRuntimeException: ErrCode:500, ErrMsg:User limit of inotify instances reached or too many open files
nacos  | 	at com.alibaba.nacos.core.listener.StartingApplicationListener.loadPreProperties(StartingApplicationListener.java:161)
nacos  | 	at com.alibaba.nacos.core.listener.StartingApplicationListener.environmentPrepared(StartingApplicationListener.java:100)
nacos  | 	at com.alibaba.nacos.core.code.SpringApplicationRunListener.environmentPrepared(SpringApplicationRunListener.java:60)
nacos  | 	at org.springframework.boot.SpringApplicationRunListeners.lambda$environmentPrepared$2(SpringApplicationRunListeners.java:66)
nacos  | 	at java.util.ArrayList.forEach(ArrayList.java:1259)
nacos  | 	at org.springframework.boot.SpringApplicationRunListeners.doWithListeners(SpringApplicationRunListeners.java:120)
nacos  | 	at org.springframework.boot.SpringApplicationRunListeners.doWithListeners(SpringApplicationRunListeners.java:114)
nacos  | 	at org.springframework.boot.SpringApplicationRunListeners.environmentPrepared(SpringApplicationRunListeners.java:65)
nacos  | 	at org.springframework.boot.SpringApplication.prepareEnvironment(SpringApplication.java:343)
nacos  | 	at org.springframework.boot.SpringApplication.run(SpringApplication.java:301)
nacos  | 	at org.springframework.boot.SpringApplication.run(SpringApplication.java:1317)
nacos  | 	at org.springframework.boot.SpringApplication.run(SpringApplication.java:1306)
nacos  | 	at com.alibaba.nacos.Nacos.main(Nacos.java:35)
nacos  | 	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
nacos  | 	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
nacos  | 	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
nacos  | 	at java.lang.reflect.Method.invoke(Method.java:498)
nacos  | 	at org.springframework.boot.loader.MainMethodRunner.run(MainMethodRunner.java:49)
nacos  | 	at org.springframework.boot.loader.Launcher.launch(Launcher.java:108)
nacos  | 	at org.springframework.boot.loader.Launcher.launch(Launcher.java:58)
nacos  | 	at org.springframework.boot.loader.PropertiesLauncher.main(PropertiesLauncher.java:467)
nacos  | Caused by: com.alibaba.nacos.api.exception.NacosException: java.io.IOException: User limit of inotify instances reached or too many open files
nacos  | 	at com.alibaba.nacos.sys.file.WatchFileCenter$WatchDirJob.&lt;init&gt;(WatchFileCenter.java:184)
nacos  | 	at com.alibaba.nacos.sys.file.WatchFileCenter.registerWatcher(WatchFileCenter.java:92)
nacos  | 	at com.alibaba.nacos.core.listener.StartingApplicationListener.registerWatcher(StartingApplicationListener.java:167)
nacos  | 	at com.alibaba.nacos.core.listener.StartingApplicationListener.loadPreProperties(StartingApplicationListener.java:159)
nacos  | 	... 20 common frames omitted
nacos  | Caused by: java.io.IOException: User limit of inotify instances reached or too many open files
nacos  | 	at sun.nio.fs.LinuxWatchService.&lt;init&gt;(LinuxWatchService.java:64)
nacos  | 	at sun.nio.fs.LinuxFileSystem.newWatchService(LinuxFileSystem.java:47)
nacos  | 	at com.alibaba.nacos.sys.file.WatchFileCenter$WatchDirJob.&lt;init&gt;(WatchFileCenter.java:179)
nacos  | 	... 23 common frames omitted
nacos  | 09:22:23.435 [Thread-4] WARN com.alibaba.nacos.common.executor.ThreadPoolManager - [ThreadPoolManager] Start destroying ThreadPool
nacos  | 09:22:23.435 [Thread-4] WARN com.alibaba.nacos.common.executor.ThreadPoolManager - [ThreadPoolManager] Destruction of the end
			
			</pre>
			<p>加大 fs.inotify.max_user_instances 配置即可，默认是 128</p>
			<pre class="screen">
			
sysctl fs.inotify.max_user_watches
sudo sysctl -w fs.inotify.max_user_watches=50889300
 
sysctl fs.inotify.max_user_instances
sudo sysctl -w fs.inotify.max_user_instances=65535			
			
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm23627596992"></a>10.11.4.7. 开启权限</h4></div></div></div>
			
			<pre class="screen">
			
nacos.core.auth.enabled= true			
			
			</pre>
			<p>在容器中设置开启验证：NACOS_AUTH_ENABLE=true</p>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm23627595248"></a>10.11.4.8. ERROR Whitelabel</h4></div></div></div>
			
			<p>当Nacos开启了认证配置nacos.core.auth.enabled=true时，当前账号没有该命名空间的权限，就会出现下面的错误提示。</p>
			<pre class="screen">
			
2022-11-07 18:42:04,370 [,,,] INFO com.alibaba.nacos.client.config.impl.LocalConfigInfoProcessor:212 [main] - LOCAL_SNAPSHOT_PATH:/root/nacos/config
Mon, Nov 7 2022 6:42:04 pm	2022-11-07 18:42:04,393 [,,,] ERROR com.alibaba.nacos.client.config.impl.ClientWorker:304 [main] - [fixed-nacos.default.svc.cluster.local_8848-test] [sub-server-error] no right, dataId=netkiller, group=DEFAULT_GROUP, tenant=test
Mon, Nov 7 2022 6:42:04 pm	2022-11-07 18:42:04,393 [,,,] ERROR com.alibaba.cloud.nacos.client.NacosPropertySourceBuilder:104 [main] - get data from Nacos error,dataId:netkiller
Mon, Nov 7 2022 6:42:04 pm	com.alibaba.nacos.api.exception.NacosException: &lt;html&gt;&lt;body&gt;&lt;h1&gt;Whitelabel Error Page&lt;/h1&gt;&lt;p&gt;This application has no explicit mapping for /error, so you are seeing this as a fallback.&lt;/p&gt;&lt;div id='created'&gt;Mon Nov 07 18:42:04 CST 2022&lt;/div&gt;&lt;div&gt;There was an unexpected error (type=Forbidden, status=403).&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;			
			
			</pre>
			<p>解决方案，在权限控制-&gt;权限管理中「添加权限」可以解决。</p>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm23627591968"></a>10.11.4.9. </h4></div></div></div>
			
			<p></p>
			<pre class="screen">
			
spring:
  cloud:
    nacos:
      discovery:
        server-addr: 127.0.0.1:8848
        metadata: 
          preserved.heart.beat.interval: 1000 	# 客户端上报心跳的间隔时间。（单位:毫秒）
          preserved.heart.beat.timeout: 3000	# 不发送心跳后，从健康到不健康的时间。（单位:毫秒）
          preserved.ip.delete.timeout: 3000		# 不发送心跳后，被nacos下掉该实例的时间。（单位:毫秒）
			
			</pre>
			<p>Spring cloud 网关 Gateway 的 ribbion 配置 </p>
			<pre class="screen">
			
#ribbon config,Interval to refresh the server list from the source
ribbon: 
  ServerListRefreshInterval: 3000		
			
			</pre>
			<p>最终 Openfeign 获得注册服务的时间是 Nacos + Gateway = 6ms</p>
		</div>
	</div>
</div><div xmlns="" id="SOHUCS"></div><script xmlns="" charset="utf-8" type="text/javascript" src="https://cy-cdn.kuaizhan.com/upload/changyan.js"></script><script xmlns="" type="text/javascript">
			window.changyan.api.config({
			appid: 'cyvwjQUG3',
			conf: 'prod_ef966242df3d8b5acb1e0ee9fc01cafe'
			});
</script><script xmlns="" type="text/javascript" id="clustrmaps" src="//cdn.clustrmaps.com/map_v2.js?u=r5HG&amp;d=9mi5r_kkDC8uxG8HuY3p4-2qgeeVypAK9vMD-2P6BYM"></script><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="ch10s10.html">上一页</a> </td><td width="20%" align="center"><a accesskey="u" href="index.html">上一级</a></td><td width="40%" align="right"> <a accesskey="n" href="cloud.faq.html">下一页</a></td></tr><tr><td width="40%" align="left" valign="top">10.10. Spring Cloud with Kubernetes </td><td width="20%" align="center"><a accesskey="h" href="../../index.html">起始页</a></td><td width="40%" align="right" valign="top"> 10.12. FAQ</td></tr></table></div><script xmlns="">
			(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

			ga('create', 'UA-11694057-1', 'auto');
			ga('send', 'pageview');

		</script><script xmlns="" async="async">
			var _hmt = _hmt || [];
			(function() {
			var hm = document.createElement("script");
			hm.src = "https://hm.baidu.com/hm.js?93967759a51cda79e49bf4e34d0b0f2c";
			var s = document.getElementsByTagName("script")[0];
			s.parentNode.insertBefore(hm, s);
			})();
</script><script xmlns="" async="async">
			(function(){
			var bp = document.createElement('script');
			var curProtocol = window.location.protocol.split(':')[0];
			if (curProtocol === 'https') {
			bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
			}
			else {
			bp.src = 'http://push.zhanzhang.baidu.com/push.js';
			}
			var s = document.getElementsByTagName("script")[0];
			s.parentNode.insertBefore(bp, s);
			})();
</script></body></html>