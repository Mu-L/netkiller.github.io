<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>5.6. Spring boot with Logging</title><link rel="stylesheet" type="text/css" href="../../docbook.css" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><link rel="home" href="../../index.html" title="Netkiller Java 手札（版）" /><link rel="up" href="index.html" title="第 5 章 Spring Boot" /><link rel="prev" href="springboot.properties.html" title="5.5. Properties 配置文件" /><link rel="next" href="Undertow.html" title="5.7. Undertow" /></head><body><a xmlns="" href="//www.netkiller.cn/">Home</a> |
		<a xmlns="" href="//netkiller.github.io/">简体中文</a> |
	    <a xmlns="" href="http://netkiller.sourceforge.net/">繁体中文</a> |
	    <a xmlns="" href="/journal/index.html">杂文</a> |
	    <a xmlns="" href="https://github.com/netkiller">Github</a> |
	    <a xmlns="" href="https://zhuanlan.zhihu.com/netkiller">知乎专栏</a> |
   	    <a xmlns="" href="https://edu.51cto.com/lecturer/1703915.html">51CTO学院</a> |
	    <a xmlns="" href="https://edu.csdn.net/lecturer/6423">CSDN程序员研修院</a> |
	    <a xmlns="" href="http://my.oschina.net/neochen/">OSChina 博客</a> |
	    <a xmlns="" href="https://cloud.tencent.com/developer/column/2078">腾讯云社区</a> |
	    <a xmlns="" href="https://yq.aliyun.com/u/netkiller/">阿里云栖社区</a> |
	    <a xmlns="" href="https://www.facebook.com/bg7nyt">Facebook</a> |
	    <a xmlns="" href="http://cn.linkedin.com/in/netkiller/">Linkedin</a> |
	    <a xmlns="" href="https://www.youtube.com/user/bg7nyt/videos">Youtube</a> |
	    <a xmlns="" href="//www.netkiller.cn/home/donations.html">打赏(Donations)</a> |
	    <a xmlns="" href="//www.netkiller.cn/home/about.html">About</a><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">5.6. Spring boot with Logging</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="springboot.properties.html">上一页</a> </td><th width="60%" align="center">第 5 章 Spring Boot</th><td width="20%" align="right"> <a accesskey="n" href="Undertow.html">下一页</a></td></tr></table><hr /></div><table xmlns=""><tr><td><iframe src="//ghbtns.com/github-btn.html?user=netkiller&amp;repo=netkiller.github.io&amp;type=watch&amp;count=true&amp;size=large" height="30" width="170" frameborder="0" scrolling="0" style="width:170px; height: 30px;" allowTransparency="true"></iframe></td><td><iframe src="//ghbtns.com/github-btn.html?user=netkiller&amp;repo=netkiller.github.io&amp;type=fork&amp;count=true&amp;size=large" height="30" width="170" frameborder="0" scrolling="0" style="width:170px; height: 30px;" allowTransparency="true"></iframe></td><td><iframe src="//ghbtns.com/github-btn.html?user=netkiller&amp;type=follow&amp;count=true&amp;size=large" height="30" width="240" frameborder="0" scrolling="0" style="width:240px; height: 30px;" allowTransparency="true"></iframe></td><td></td><td><a href="https://zhuanlan.zhihu.com/netkiller"><img src="/images/logo/zhihu-card-default.svg" height="25" /></a></td><td valign="middle"><a href="https://zhuanlan.zhihu.com/netkiller">知乎专栏</a> ｜ <a href="https://www.zhihu.com/club/1241768772601950208">多维度架构</a></td><td></td><td></td><td></td><td></td></tr></table><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="logging"></a>5.6. Spring boot with Logging</h2></div></div></div>
	
	<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="idm8577650320"></a>5.6.1. 配置日志文件</h3></div></div></div>
		
		<p>一般的日志需求可以通过配置 application.properties实现。</p>
		<p>Spring Boot中 日志默认是输出到控制台的，这样是为了方便开发人员，但是在生产环境中应该输出到日志文件中。</p>
		<div class="itemizedlist"><p class="title"><strong>配置如下</strong></p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">logging.file.path：指定日志文件的路径	</li><li class="listitem">logging.file.name：日志的文件名(默认为spring.log)</li><li class="listitem">logging.pattern.console：控制台的输出格式</li><li class="listitem">logging.pattern.file：日志文件的输出格式</li></ul></div>
		<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[提示]" src="/graphics/tip.png" /></td><th align="left">提示</th></tr><tr><td align="left" valign="top">
			<p>注意：这两个属性不能同时配置，只需要配置一个即可。</p>
		</td></tr></table></div>
		<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[提示]" src="/graphics/tip.png" /></td><th align="left">提示</th></tr><tr><td align="left" valign="top">
			<p>旧版本</p>
			<p>logging.file，设置文件，可以是绝对路径，也可以是相对路径。如：logging.file=my.log</p>
			<p>logging.path，设置目录，如果 logging.file
				没有设置，会在该目录下创建spring.log文件作为默认日志文件。</p>
			<pre class="screen">
		
logging.file=target/spring.log
#logging.path=
		
			</pre>
			<p>如果仍不能满足可以使用 logback.xml 配置日志。</p>
			<pre class="screen">
		
logging.path=/tmp
logging.config=classpath:logback.xml
		
			</pre>
		</td></tr></table></div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm8577640256"></a>5.6.1.1. 日志输出级别</h4></div></div></div>
			
			<pre class="screen">
		
几种常见的日志级别由低到高分为：TRACE &lt; DEBUG &lt; INFO &lt; WARN &lt; ERROR &lt; FATAL
		
			</pre>
			<p>显示所有DEBUG信息</p>
			<pre class="screen">
			
logging.level.root=DEBUG			
			
			</pre>
			<p>仅仅显示 springframework 调试信息</p>
			<pre class="screen">
			
logging.level.org.springframework.web=DEBUG			
			
			</pre>
			<p>仅仅显示 cn.netkiller.web.TestController 调试信息</p>
			<pre class="screen">
			
private static final Logger log = LoggerFactory.getLogger(TestController.class);

log.debug(message);

logging.level.cn.netkiller.web.TestController=DEBUG			
			

			</pre>
			<p>YAML 配置文件写法</p>
			<pre class="screen">
			
logging:
  level:
    root: info
    cn.netkiller.test: debug
    cn.netkiller.sharding.MonthShardingAlgorithm: DEBUG
			
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm8577640128"></a>5.6.1.2. Spring boot 2.1 以后的版本不打印 Mapped 日志问题</h4></div></div></div>
			
			<pre class="screen">
		
logging.level.org.springframework.web=trace		
		
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm8577633840"></a>5.6.1.3. 禁止控制台输出日志</h4></div></div></div>
			
			<p>禁止控制台日志输出，同时将日志写入日志文件.</p>
			<p>src/main/resources/application.properties</p>
			<pre class="screen">
			
logging.file.path=/tmp
logging.file.name=/tmp/spring.log
logging.level.root=INFO
logging.level.org.springframework.web=DEBUG
logging.level.org.hibernate=ERROR
			
			</pre>
			<p>src/main/resources/logback.xml</p>
			<pre class="screen">
			
$ cat src/main/resources/logback.xml
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;configuration&gt;
  &lt;include resource="org/springframework/boot/logging/logback/defaults.xml" /&gt;
  &lt;include resource="org/springframework/boot/logging/logback/file-appender.xml" /&gt;

  &lt;root level="INFO"&gt;
    &lt;appender-ref ref="FILE" /&gt;
  &lt;/root&gt;
&lt;/configuration&gt;
			
			</pre>
			<p>使用 java -jar project-version-xxx.jar 启动后控制不会再输出日志</p>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm8577629728"></a>5.6.1.4. 定制日志格式</h4></div></div></div>
			
			<div class="itemizedlist"><p class="title"><strong>定制日志格式有两个配置</strong></p><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">logging.pattern.console：控制台的输出格式	</li><li class="listitem">logging.pattern.file：日志文件的输出格式</li></ul></div>
			<p>分别是控制台的输出格式和文件中的日志输出格式</p>
			<p>举例</p>
			<pre class="screen">
			
logging.pattern.console=%d{yyyy/MM/dd-HH:mm:ss} [%thread] %-5level %logger- %msg%n
logging.pattern.file=%d{yyyy/MM/dd-HH:mm} [%thread] %-5level %logger- %msg%n			
			
			</pre>
			<p>格式说明</p>
			<pre class="screen">
			
%d{HH:mm:ss.SSS} 日志输出时间
%thread 	输出日志的进程名字，这在Web应用以及异步任务处理中很有用
%-5level 	日志级别，并且使用5个字符靠左对齐
%logger		日志输出者的名字
%msg		日志消息
%n			平台的换行符
			
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm8577624512"></a>5.6.1.5. 彩色输出</h4></div></div></div>
			
			<pre class="programlisting">
			
spring.main.banner-mode=off 
spring.output.ansi.enabled=ALWAYS
logging.pattern.console=%clr(%d{yy-MM-dd E HH:mm:ss.SSS}){blue} %clr(%-5p) %clr(${PID}){faint} %clr(---){faint} %clr([%8.15t]){cyan} %clr(%-40.40logger{0}){blue} %clr(:){red} %clr(%m){faint}%n			
			
			</pre>
		</div>
	</div>

	<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="idm8577648816"></a>5.6.2. 打印日志</h3></div></div></div>
		
		<p>日志的用法，首先开发中我们根据实际的需要打印不同级别的日志。</p>
		<pre class="programlisting">
			
package cn.netkiller.web;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.ResponseBody;

@Controller
public class TestController {

	private static final Logger log = LoggerFactory.getLogger(TestController.class);

	@RequestMapping("/test/log")
	@ResponseBody
	public String log() {
		String message = "Test";
		log.debug(message);
		log.info(message);
		log.warn(message);
		log.error(message);
		log.trace(message);
		return message;
	}
}
			
		</pre>
		<p>然后通过application.properties配置那些需要显示，那些不需要，以及显示的级别是什么。 </p>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm8577620336"></a>5.6.2.1. lombok</h4></div></div></div>
			
			<pre class="screen">
			
		&lt;dependency&gt;
            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;
            &lt;artifactId&gt;lombok&lt;/artifactId&gt;
        &lt;/dependency&gt;			
			
			</pre>
			<pre class="programlisting">
			
@Slf4j
class DemoApplicationTests {
  @Test
  public void test(){
    log.debug("输出DEBUG日志.......");
  }
}			
			
			</pre>
		</div>
	</div>

	<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="springboot.logback"></a>5.6.3. logback 配置详解</h3></div></div></div>
		
		<p>配置文件名默认是：logback-spring.xml，使用其他文件名通过下面配置项指定即可。</p>
		<pre class="screen">
		
logging.config=classpath:logback.xml		
		
		</pre>
		<p>基本配置</p>
		<pre class="screen">
		
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;configuration&gt;
    &lt;appender name="stdout" class="ch.qos.logback.core.ConsoleAppender"&gt;
        &lt;encoder&gt;
            &lt;pattern&gt;%d{yy-MMMM-dd HH:mm:ss:SSS} %5p %t %c{2}:%L - %m%n&lt;/pattern&gt;
        &lt;/encoder&gt;
    &lt;/appender&gt;
    &lt;root level="INFO"&gt;
        &lt;appender-ref ref="stdout"/&gt;
    &lt;/root&gt;
&lt;/configuration&gt;		
		
		</pre>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm8577615024"></a>5.6.3.1. 禁止 logback 日志输出</h4></div></div></div>
			
			<pre class="screen">
			
	&lt;statusListener class="ch.qos.logback.core.status.NopStatusListener" /&gt;			
			
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm8577613632"></a>5.6.3.2. 指定Class过滤日志</h4></div></div></div>
			
			<pre class="programlisting">
			
    &lt;logger name="cn.netkiller.controller"/&gt;
    
    &lt;logger name="cn.netkiller.controller.HomeController" level="WARN" additivity="false"&gt;
        &lt;appender-ref ref="console"/&gt;
    &lt;/logger&gt;
			
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm8577612144"></a>5.6.3.3. configuration 属性配置</h4></div></div></div>
			
			<pre class="screen">
			
scan:当此属性设置为true时，配置文件如果发生改变，将会被重新加载，默认值为true。
scanPeriod:设置监测配置文件是否有修改的时间间隔，如果没有给出时间单位，默认单位是毫秒。当scan为true时，此属性生效。默认的时间间隔为1分钟。
debug:当此属性设置为true时，将打印出logback内部日志信息，实时查看logback运行状态。默认值为false。			
			
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="logback.contextName"></a>5.6.3.4. contextName 设置上下文名称</h4></div></div></div>
			
			<pre class="screen">
			

每个logger都关联到logger上下文，默认上下文名称为“default”。但可以使用设置成其他名字，用于区分不同应用程序的记录。设置后可以通过%contextName来打印日志上下文名称。
&lt;contextName&gt;logback&lt;/contextName&gt;			
			
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="logback.property"></a>5.6.3.5. property 设置变量</h4></div></div></div>
			
			<pre class="screen">
			
用来定义变量值的标签， 有两个属性，name和value；其中name的值是变量的名称，value的值时变量定义的值。通过定义的值会被插入到logger上下文中。定义变量后，可以使“${}”来使用变量。

&lt;property name="log.path" value="/tmp" /&gt;
			
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="logback.encoder"></a>5.6.3.6. encoder 日志格式设置</h4></div></div></div>
			
			<pre class="screen">
			
&lt;encoder&gt;表示对日志进行编码：

%d{HH: mm:ss.SSS}——日志输出时间
%thread——输出日志的进程名字，这在Web应用以及异步任务处理中很有用
%-5level——日志级别，并且使用5个字符靠左对齐
%logger{36}——日志输出者的名字
%msg——日志消息
%n——平台的换行符			
			
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="RollingFileAppender"></a>5.6.3.7. RollingFileAppender</h4></div></div></div>
			
			<pre class="screen">
			
上例中&lt;fileNamePattern&gt;${log.path}/logback.%d{yyyy-MM-dd}.log&lt;/fileNamePattern&gt;定义了日志的切分方式——把每一天的日志归档到一个文件中，同理，可以使用%d{yyyy-MM-dd_HH-mm}来定义精确到分的日志切分方式。
&lt;maxHistory&gt;30&lt;/maxHistory&gt;表示只保留最近30天的日志，以防止日志填满整个磁盘空间。
&lt;totalSizeCap&gt;1GB&lt;/totalSizeCap&gt;用来指定日志文件的上限大小，例如设置为1GB的话，那么到了这个值，就会删除旧的日志。	
			
			</pre>
			<div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="idm8577602976"></a>按日期分割日志</h5></div></div></div>
				
				<pre class="screen">
			
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;configuration  scan="true" scanPeriod="60 seconds" debug="false"&gt;
    &lt;contextName&gt;logback&lt;/contextName&gt;
    &lt;property name="log.path" value="target" /&gt;
    &lt;!--输出到控制台--&gt;
    &lt;appender name="console" class="ch.qos.logback.core.ConsoleAppender"&gt;
        &lt;encoder&gt;
            &lt;pattern&gt;%d{HH:mm:ss.SSS} %contextName [%thread] %-5level %logger{36} - %msg%n&lt;/pattern&gt;
        &lt;/encoder&gt;
    &lt;/appender&gt;

    &lt;!--输出到文件--&gt;
    &lt;appender name="file" class="ch.qos.logback.core.rolling.RollingFileAppender"&gt;
        &lt;rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy"&gt;
            &lt;fileNamePattern&gt;${log.path}/spring.%d{yyyy-MM-dd}.log&lt;/fileNamePattern&gt;
        &lt;/rollingPolicy&gt;
        &lt;encoder&gt;
            &lt;pattern&gt;%d{HH:mm:ss.SSS} %contextName [%thread] %-5level %logger{36} - %msg%n&lt;/pattern&gt;
        &lt;/encoder&gt;
    &lt;/appender&gt;

    &lt;root level="info"&gt;
        &lt;appender-ref ref="console" /&gt;
        &lt;appender-ref ref="file" /&gt;
    &lt;/root&gt;
&lt;/configuration&gt;
			
				</pre>
			</div>
			<div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="idm8577601744"></a>按照文件尺寸分割日志</h5></div></div></div>
				
				<p>按日期分割文件</p>
				<pre class="screen">
			
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;configuration&gt;
  &lt;include resource="org/springframework/boot/logging/logback/defaults.xml" /&gt;
  &lt;include resource="org/springframework/boot/logging/logback/file-appender.xml" /&gt;

&lt;appender name="dailyRollingFileAppender" class="ch.qos.logback.core.rolling.RollingFileAppender"&gt;
  &lt;File&gt;logs/spring.log&lt;/File&gt;
  &lt;rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy"&gt;
    &lt;!-- daily rollover --&gt;
    &lt;FileNamePattern&gt;spring.%d{yyyy-MM-dd}.log&lt;/FileNamePattern&gt;
    &lt;!-- keep 30 days' worth of history --&gt;
    &lt;maxHistory&gt;60&lt;/maxHistory&gt;         
  &lt;/rollingPolicy&gt;
  &lt;encoder&gt;
    &lt;Pattern&gt;%d{HH:mm:ss.SSS} [%thread] %-5level %logger{35} - %msg %n&lt;/Pattern&gt;
  &lt;/encoder&gt;        
&lt;/appender&gt;

  &lt;root level="INFO"&gt;
    &lt;appender-ref ref="FILE" /&gt;
	&lt;appender-ref ref="dailyRollingFileAppender" /&gt;	
  &lt;/root&gt;
&lt;/configuration&gt;
			
			
				</pre>
				<p>通过级别分割日志将 info, error, debug 分割到指定文件中。</p>
				<pre class="screen">
			
&lt;configuration scan="true" scanPeriod="10 seconds"&gt;
     &lt;!-- 控制台日志输出--&gt;
    &lt;appender name="STDOUT" class="ch.qos.logback.core.ConsoleAppender"&gt;
        &lt;encoder&gt;
            &lt;pattern&gt;%d %p (%file:%line\)- %m%n&lt;/pattern&gt;
            &lt;charset&gt;UTF-8&lt;/charset&gt;
        &lt;/encoder&gt;
    &lt;/appender&gt;
    &lt;!-- info日志输出--&gt;
    &lt;appender name="INFO_FILE" class="ch.qos.logback.core.rolling.RollingFileAppender"&gt;
        &lt;encoder&gt;
            &lt;pattern&gt;%d %p (%file:%line\)- %m%n&lt;/pattern&gt;
            &lt;charset&gt;UTF-8&lt;/charset&gt;
        &lt;/encoder&gt;
        &lt;filter class="ch.qos.logback.classic.filter.ThresholdFilter"&gt;
            &lt;level&gt;INFO&lt;/level&gt;
        &lt;/filter&gt;
        &lt;File&gt;${LOG_PATH}/www.netkiller.cn.info.log&lt;/File&gt;
        &lt;rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy"&gt;
            &lt;fileNamePattern&gt;${LOG_PATH}/www.netkiller.cn.info-%d{yyyyMMdd}.log.%i
            &lt;/fileNamePattern&gt;
            &lt;timeBasedFileNamingAndTriggeringPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP"&gt;
                &lt;maxFileSize&gt;10MB&lt;/maxFileSize&gt;
            &lt;/timeBasedFileNamingAndTriggeringPolicy&gt;
            &lt;maxHistory&gt;30&lt;/maxHistory&gt;
        &lt;/rollingPolicy&gt;
        &lt;layout class="ch.qos.logback.classic.PatternLayout"&gt;
            &lt;Pattern&gt;%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} -%msg%n
            &lt;/Pattern&gt;
        &lt;/layout&gt;
    &lt;/appender&gt;
    &lt;!-- debug 日志输出--&gt;
    &lt;appender name="DEBUG_FILE" class="ch.qos.logback.core.rolling.RollingFileAppender"&gt;
        &lt;encoder&gt;
            &lt;pattern&gt;%d %p (%file:%line\)- %m%n&lt;/pattern&gt;
            &lt;charset&gt;UTF-8&lt;/charset&gt;
        &lt;/encoder&gt;
        &lt;filter class="ch.qos.logback.classic.filter.ThresholdFilter"&gt;
            &lt;level&gt;DEBUG&lt;/level&gt;
        &lt;/filter&gt;
        &lt;File&gt;${LOG_PATH}/www.netkiller.cn.debug.log&lt;/File&gt;
        &lt;rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy"&gt;
            &lt;fileNamePattern&gt;${LOG_PATH}/www.netkiller.cn.debug-%d{yyyyMMdd}.log.%i
            &lt;/fileNamePattern&gt;
            &lt;timeBasedFileNamingAndTriggeringPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP"&gt;
                &lt;maxFileSize&gt;10MB&lt;/maxFileSize&gt;
            &lt;/timeBasedFileNamingAndTriggeringPolicy&gt;
            &lt;maxHistory&gt;30&lt;/maxHistory&gt;
        &lt;/rollingPolicy&gt;
        &lt;layout class="ch.qos.logback.classic.PatternLayout"&gt;
            &lt;Pattern&gt;%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} -%msg%n
            &lt;/Pattern&gt;
        &lt;/layout&gt;
    &lt;/appender&gt;

      &lt;!--error 日志输出配置 --&gt;
    &lt;appender name="ERROR_FILE" class="ch.qos.logback.core.rolling.RollingFileAppender"&gt;
        &lt;encoder&gt;
            &lt;pattern&gt;%d %p (%file:%line\)- %m%n&lt;/pattern&gt;
            &lt;charset&gt;UTF-8&lt;/charset&gt;
        &lt;/encoder&gt;
        &lt;filter class="ch.qos.logback.classic.filter.ThresholdFilter"&gt;
            &lt;level&gt;ERROR&lt;/level&gt;
        &lt;/filter&gt;
        &lt;File&gt;${LOG_PATH}/www.netkiller.cn.error.log&lt;/File&gt;
        &lt;rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy"&gt;
            &lt;fileNamePattern&gt;${LOG_PATH}/www.netkiller.cn.error-%d{yyyyMMdd}.log.%i&lt;/fileNamePattern&gt;
            &lt;timeBasedFileNamingAndTriggeringPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP"&gt;
                &lt;maxFileSize&gt;10MB&lt;/maxFileSize&gt;
            &lt;/timeBasedFileNamingAndTriggeringPolicy&gt;
            &lt;maxHistory&gt;30&lt;/maxHistory&gt;
        &lt;/rollingPolicy&gt;
        &lt;layout class="ch.qos.logback.classic.PatternLayout"&gt;
            &lt;Pattern&gt;%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} -%msg%n&lt;/Pattern&gt;
        &lt;/layout&gt;
    &lt;/appender&gt;

    &lt;root level="DEBUG"&gt;
        &lt;!--
        &lt;appender-ref ref="STDOUT" /&gt;
        &lt;appender-ref ref="INFO_FILE" /&gt;
        &lt;appender-ref ref="ERROR_FILE" /&gt;
        &lt;appender-ref ref="DEBUG_FILE" /&gt;
        --&gt;
        &lt;appender-ref ref="ERROR_FILE" /&gt;
        &lt;appender-ref ref="INFO_FILE" /&gt;
        &lt;appender-ref ref="DEBUG_FILE" /&gt;
    &lt;/root&gt;

&lt;/configuration&gt;			
			
				</pre>
			</div>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm8577599584"></a>5.6.3.8. 日志过滤</h4></div></div></div>
			
			<p>将特定日志输出保存到指定位置</p>
			<pre class="programlisting">
			
package cn.netkiller;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.slf4j.Marker;
import org.slf4j.MarkerFactory;

public class Application {
	public static void main(String[] args) {
		final Logger logger = LoggerFactory.getLogger(Application.class);
		Marker notifyAdmin = MarkerFactory.getMarker("netkiller");
		logger.info("AAAAAAAAA");
		logger.info(notifyAdmin, "BBBBBBBBB");
		logger.error(notifyAdmin, "This is a serious an error requiring the admin's attention", new Exception("Just testing"));
	}
}
			
			</pre>
			<p>匹配到 marker 的日志才输出，通过 RollingFileAppender 可以保存到指定文件。</p>
			<pre class="programlisting">
			
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;configuration&gt;
	&lt;include resource="org/springframework/boot/logging/logback/defaults.xml" /&gt;
	&lt;include resource="org/springframework/boot/logging/logback/file-appender.xml" /&gt;
	&lt;appender name="STDOUT" class="ch.qos.logback.core.ConsoleAppender"&gt;
		&lt;filter class="ch.qos.logback.core.filter.EvaluatorFilter"&gt;
			&lt;evaluator class="ch.qos.logback.classic.boolex.OnMarkerEvaluator"&gt;
				&lt;marker&gt;netkiller&lt;/marker&gt;
			&lt;/evaluator&gt;
			&lt;onMatch&gt;ACCEPT&lt;/onMatch&gt;
			&lt;onMismatch&gt;DENY&lt;/onMismatch&gt;
		&lt;/filter&gt;
		&lt;encoder&gt;
			&lt;pattern&gt;%date{yyyy-MM-dd HH:mm:ss} %-4relative [%thread] %-5level %logger{35} : %msg %n&lt;/pattern&gt;
		&lt;/encoder&gt;
	&lt;/appender&gt;
	&lt;root level="INFO"&gt;
		&lt;appender-ref ref="STDOUT" /&gt;
		&lt;appender-ref ref="FILE" /&gt;
	&lt;/root&gt;
&lt;/configuration&gt;			
			
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="stdout"></a>5.6.3.9. 标准输出</h4></div></div></div>
			
			<pre class="screen">
			
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;configuration&gt;
	&lt;include resource="org/springframework/boot/logging/logback/defaults.xml" /&gt;
	&lt;include resource="org/springframework/boot/logging/logback/file-appender.xml" /&gt;
	&lt;appender name="STDOUT" class="ch.qos.logback.core.ConsoleAppender"&gt;
		&lt;encoder&gt;
			&lt;pattern&gt;%date{yyyy-MM-dd HH:mm:ss} %-4relative [%thread] %-5level %logger{35} : %msg %n&lt;/pattern&gt;
		&lt;/encoder&gt;
	&lt;/appender&gt;
	&lt;root level="INFO"&gt;
		&lt;appender-ref ref="STDOUT" /&gt;
		&lt;appender-ref ref="FILE" /&gt;
	&lt;/root&gt;
&lt;/configuration&gt;
			
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm8577592176"></a>5.6.3.10. MDC</h4></div></div></div>
			
			<p>每个 userId 生成一个日志文件</p>
			<pre class="programlisting">
			
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;configuration&gt;
	&lt;include resource="org/springframework/boot/logging/logback/defaults.xml" /&gt;
	&lt;include resource="org/springframework/boot/logging/logback/file-appender.xml" /&gt;

	&lt;property name="log.pattern" value="%d{yyyy-MM-dd HH:mm:ss} - [%25.25(%thread)] - [%-5level] - %-30.30(%logger{30}) : %msg%n" /&gt;

	&lt;appender name="siftingAppender" class="ch.qos.logback.classic.sift.SiftingAppender"&gt;
		&lt;discriminator&gt;
			&lt;key&gt;userId&lt;/key&gt;
			&lt;defaultValue&gt;unknown&lt;/defaultValue&gt;
		&lt;/discriminator&gt;
		&lt;sift&gt;
			&lt;appender name="${userId}" class="ch.qos.logback.core.rolling.RollingFileAppender"&gt;
				&lt;rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy"&gt;
					&lt;fileNamePattern&gt;${log.path}/${userId}.%d{yyyy-MM-dd}.log&lt;/fileNamePattern&gt;
				&lt;/rollingPolicy&gt;
				&lt;encoder&gt;
					&lt;pattern&gt;${log.pattern}&lt;/pattern&gt;
				&lt;/encoder&gt;
			&lt;/appender&gt;
		&lt;/sift&gt;
	&lt;/appender&gt;

	&lt;root level="INFO"&gt;
		&lt;appender-ref ref="siftingAppender" /&gt;
	&lt;/root&gt;
&lt;/configuration&gt;			
			
			</pre>
			<pre class="programlisting">
			
package cn.netkiller.log;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.slf4j.MDC;

public class LogTest {

	private static final Logger logger = LoggerFactory.getLogger(LogTest.class);

	public LogTest() {
		// TODO Auto-generated constructor stub
	}

	public static void main(String[] args) {
	
		MDC.put("userId","0001");
		logger.info("0001用户");
        MDC.clear(); 

        MDC.put("userId","0002");
        logger.info("0002用户");
        MDC.clear();

	}

}
			
			
			</pre>
		</div>

		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="logback.mongodb"></a>5.6.3.11. 日志写入 MongoDB</h4></div></div></div>
			
			<pre class="screen">
			

			
			</pre>
		</div>
	</div>
	<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="logback.logstash"></a>5.6.4. 日志发送给 logstash</h3></div></div></div>
		
		<p>https://github.com/logfellow/logstash-logback-encoder/</p>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm8577586720"></a>5.6.4.1. logstash 配置</h4></div></div></div>
			
			<p>配置 logstash 增加 tcp 接收输入端。</p>
			<pre class="screen">
				
input {
    tcp {
	    mode =&gt; "server"
	    host =&gt; "127.0.0.1"
	    port =&gt; 4567
	    codec =&gt; json_lines
	}
}				
				
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm8577584800"></a>5.6.4.2. Java 项目</h4></div></div></div>
			
			<p>Maven 配置文件 pom.xml 中添加</p>
			<pre class="screen">
				
&lt;dependency&gt;
    &lt;groupId&gt;net.logstash.logback&lt;/groupId&gt;
    &lt;artifactId&gt;logstash-logback-encoder&lt;/artifactId&gt;
    &lt;version&gt;7.2&lt;/version&gt;
&lt;/dependency&gt;
				
			</pre>
			<p>然后再resources添加logback.xml文件</p>
			<pre class="screen">
				
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;configuration scan="true" scanPeriod="60 seconds" debug="true"&gt;
	&lt;include resource="org/springframework/boot/logging/logback/defaults.xml" /&gt;
	&lt;include resource="org/springframework/boot/logging/logback/console-appender.xml" /&gt;
	&lt;include resource="org/springframework/boot/logging/logback/file-appender.xml" /&gt;

	&lt;appender name="logstash" class="net.logstash.logback.appender.LogstashTcpSocketAppender"&gt;
		&lt;destination&gt;127.0.0.1:4567&lt;/destination&gt;
		&lt;encoder class="net.logstash.logback.encoder.LogstashEncoder"&gt;
			&lt;providers&gt;
				&lt;timestamp /&gt;
				&lt;logLevel /&gt;
				&lt;threadName /&gt;
				&lt;loggerName /&gt;
				&lt;message /&gt;
			&lt;/providers&gt;
		&lt;/encoder&gt;
	&lt;/appender&gt;
	&lt;root level="info"&gt;
		&lt;appender-ref ref="CONSOLE" /&gt;
		&lt;appender-ref ref="logstash" /&gt;
	&lt;/root&gt;
&lt;/configuration&gt;				
				
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm8577582240"></a>5.6.4.3. 通过 tags 区分日志文件</h4></div></div></div>
			
			<div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="idm8577580640"></a>logstash pipeline 配置</h5></div></div></div>
				
				<p></p>
				<pre class="screen">
				
[root@netkiller ~]# cat /etc/logstash/conf.d/file.conf 
input {
  tcp {
    port =&gt; 4567 
    codec =&gt; json_lines
  }
}

filter {
    ruby {
	code =&gt; "event.set('datetime', event.get('@timestamp').time.localtime.strftime('%Y-%m-%d %H:%M:%S'))"
    }
}

output {
	if "finance" in [tags] { 
	    file {
	        path =&gt; "/opt/log/%{app}.finance.%{+yyyy}-%{+MM}-%{+dd}.log"
			codec =&gt; line { format =&gt; "[%{datetime}] %{level} %{message} %{tags}"}
		}
	} else if "market" in [tags] {
		file {
			path =&gt; "/opt/log/%{app}.market.%{+yyyy}-%{+MM}-%{+dd}.log"
			codec =&gt; line { format =&gt; "[%{datetime}] %{level} %{message} %{tags}"}
		}
	} else {
	    file {
			path =&gt; "/opt/log/%{app}.unknow.%{+yyyy}-%{+MM}-%{+dd}.log"
			codec =&gt; line { format =&gt; "[%{datetime}] %{level} %{message} %{tags}"}
		}
	}
}				
				
				</pre>
			</div>
			<div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="idm8577578992"></a>logback-spring.xml 配置</h5></div></div></div>
				
				<pre class="screen">
				
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;configuration scan="false" scanPeriod="60 seconds" debug="false"&gt;
	&lt;include resource="org/springframework/boot/logging/logback/defaults.xml" /&gt;
	&lt;include resource="org/springframework/boot/logging/logback/console-appender.xml" /&gt;
	&lt;include resource="org/springframework/boot/logging/logback/file-appender.xml" /&gt;

	&lt;logger name="org.springframework.web" level="INFO" /&gt;
	&lt;logger name="org.springboot.sample" level="TRACE" /&gt;
	&lt;property name="log.pattern" value="%date{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{35}.%method: %msg%n" /&gt;
	&lt;springProperty scope="context" name="app" source="spring.application.name" defaultValue="spring-boot-fusion" /&gt;
	&lt;property name="log.path" value="/tmp" /&gt;

	&lt;appender name="siftingAppender" class="ch.qos.logback.classic.sift.SiftingAppender"&gt;
		&lt;discriminator&gt;
			&lt;key&gt;userId&lt;/key&gt;
			&lt;defaultValue&gt;unknown&lt;/defaultValue&gt;
		&lt;/discriminator&gt;
		&lt;sift&gt;
			&lt;appender name="${userId}" class="ch.qos.logback.core.rolling.RollingFileAppender"&gt;
				&lt;rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy"&gt;
					&lt;fileNamePattern&gt;${log.path}/${userId}.%d{yyyy-MM-dd}.log&lt;/fileNamePattern&gt;
				&lt;/rollingPolicy&gt;
				&lt;encoder&gt;
					&lt;pattern&gt;${log.pattern}&lt;/pattern&gt;
				&lt;/encoder&gt;
			&lt;/appender&gt;
		&lt;/sift&gt;
	&lt;/appender&gt;
	&lt;springProfile name="prod"&gt;
		&lt;appender name="logstash" class="net.logstash.logback.appender.LogstashTcpSocketAppender"&gt;
			&lt;destination&gt;172.18.200.10:4567&lt;/destination&gt;
			&lt;keepAliveDuration&gt;5 minutes&lt;/keepAliveDuration&gt;
			&lt;reconnectionDelay&gt;3 second&lt;/reconnectionDelay&gt;
			&lt;writeBufferSize&gt;8192&lt;/writeBufferSize&gt;
			&lt;includeCallerData&gt;true&lt;/includeCallerData&gt;
			&lt;encoder class="net.logstash.logback.encoder.LogstashEncoder"&gt;
				&lt;shortenedLoggerNameLength&gt;36&lt;/shortenedLoggerNameLength&gt;
				&lt;timestampPattern&gt;yyyy-MM-dd HH:mm:ss.Asia/Shanghai&lt;/timestampPattern&gt;
				&lt;timeZone&gt;Asia/Shanghai&lt;/timeZone&gt;

				&lt;fieldNames&gt;
					&lt;timestamp&gt;@timestamp&lt;/timestamp&gt;
					&lt;version&gt;@version&lt;/version&gt;
					&lt;message&gt;message&lt;/message&gt;
					&lt;logger&gt;logger_name&lt;/logger&gt;
					&lt;!-- &lt;thread&gt;thread_name&lt;/thread&gt; --&gt;
					&lt;level&gt;level&lt;/level&gt;
					&lt;thread&gt;[ignore]&lt;/thread&gt;
					&lt;levelValue&gt;[ignore]&lt;/levelValue&gt;
				&lt;/fieldNames&gt;
			&lt;/encoder&gt;

			&lt;filter class="ch.qos.logback.core.filter.EvaluatorFilter"&gt;
				&lt;evaluator class="ch.qos.logback.classic.boolex.OnMarkerEvaluator"&gt;
					&lt;marker&gt;finance&lt;/marker&gt;
					&lt;marker&gt;market&lt;/marker&gt;
					&lt;marker&gt;customer&lt;/marker&gt;
				&lt;/evaluator&gt;
				&lt;onMatch&gt;ACCEPT&lt;/onMatch&gt;
				&lt;onMismatch&gt;DENY&lt;/onMismatch&gt;
			&lt;/filter&gt;
		&lt;/appender&gt;

	&lt;/springProfile&gt;

	&lt;root level="info"&gt;
		&lt;springProfile name="dev"&gt;
			&lt;appender-ref ref="CONSOLE" /&gt;
		&lt;/springProfile&gt;
		&lt;springProfile name="test"&gt;
			&lt;appender-ref ref="CONSOLE" /&gt;
			&lt;appender-ref ref="FILE" /&gt;
		&lt;/springProfile&gt;
		&lt;springProfile name="prod"&gt;
			&lt;appender-ref ref="CONSOLE" /&gt;
			&lt;appender-ref ref="logstash" /&gt;
		&lt;/springProfile&gt;
	&lt;/root&gt;
&lt;/configuration&gt;
				
				</pre>
			</div>
			<div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="idm8577576896"></a>打印日志</h5></div></div></div>
				
				<pre class="programlisting">
				
package cn.netkiller.controller;

import java.util.concurrent.TimeUnit;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.slf4j.MDC;
import org.slf4j.Marker;
import org.slf4j.MarkerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import cn.netkiller.LogMarker;
import lombok.extern.slf4j.Slf4j;

@RestController
@Slf4j
public class HomeController {
	private static final Logger logger = LoggerFactory.getLogger(HomeController.class);

	public HomeController() {
		// TODO Auto-generated constructor stub
	}

	@GetMapping("/")
	public String index() {

		Marker finance = MarkerFactory.getMarker(LogMarker.finance.toString());
		Marker customer = MarkerFactory.getMarker(LogMarker.customer.toString());
		Marker market = MarkerFactory.getMarker(LogMarker.market.toString());
		logger.info("AAAAAAAAA");
		logger.info(finance, "test");
		logger.info(finance, "finance");
		logger.info(customer, "customer");
		logger.info(market, "market");

		MDC.put("userId", "0001");
		logger.info("0001用户");
		MDC.clear();

		MDC.put("userId", "0002");
		logger.info("0002用户");
		MDC.clear();
		return "Hello world!!!";
	}
}
				
				
				</pre>
			</div>
		</div>
	</div>
	<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="springboot.fluentd"></a>5.6.5. fluentd</h3></div></div></div>
		
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm8577574432"></a>5.6.5.1. Maven 依赖</h4></div></div></div>
			
			<pre class="screen">
			
		&lt;dependency&gt;
			&lt;groupId&gt;org.fluentd&lt;/groupId&gt;
			&lt;artifactId&gt;fluent-logger&lt;/artifactId&gt;
			&lt;version&gt;0.3.4&lt;/version&gt;
		&lt;/dependency&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;com.sndyuk&lt;/groupId&gt;
			&lt;artifactId&gt;logback-more-appenders&lt;/artifactId&gt;
			&lt;version&gt;1.8.7&lt;/version&gt;
		&lt;/dependency&gt;			
			
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm8577572864"></a>5.6.5.2. 安装 fluent-bit</h4></div></div></div>
			
			<pre class="screen">
			
dnf install -y fluent-bit			
			
			</pre>
			<p>启动 fluent-bit</p>
			<pre class="screen">
			
[root@netkiller ~]# fluent-bit -i forward -o stdout
Fluent Bit v1.9.7
* Copyright (C) 2015-2022 The Fluent Bit Authors
* Fluent Bit is a CNCF sub-project under the umbrella of Fluentd
* https://fluentbit.io

[2022/09/24 23:25:25] [ info] [fluent bit] version=1.9.7, commit=, pid=1191240
[2022/09/24 23:25:25] [ info] [storage] version=1.2.0, type=memory-only, sync=normal, checksum=disabled, max_chunks_up=128
[2022/09/24 23:25:25] [ info] [cmetrics] version=0.3.5
[2022/09/24 23:25:25] [ info] [input:forward:forward.0] listening on 0.0.0.0:24224
[2022/09/24 23:25:25] [ info] [sp] stream processor started
[2022/09/24 23:25:25] [ info] [output:stdout:stdout.0] worker #0 started
			
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm8577570864"></a>5.6.5.3. 配置 logback-spring.xml</h4></div></div></div>
			
			<pre class="programlisting">
		
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;configuration debug="true"&gt;

    &lt;appender name="STDOUT" class="ch.qos.logback.core.ConsoleAppender"&gt;
        &lt;encoder&gt;
            &lt;pattern&gt;%date - %level - [%thread] - %logger - [%file:%line] - %msg%n&lt;/pattern&gt;
        &lt;/encoder&gt;
    &lt;/appender&gt;

    &lt;appender name="FLUENT" class="ch.qos.logback.more.appenders.DataFluentAppender"&gt;
        &lt;tag&gt;development&lt;/tag&gt;
        &lt;label&gt;normal&lt;/label&gt;
        &lt;remoteHost&gt;localhost&lt;/remoteHost&gt;
        &lt;port&gt;24224&lt;/port&gt;
        &lt;maxQueueSize&gt;20&lt;/maxQueueSize&gt;
    &lt;/appender&gt;

    &lt;logger name="cn.netkiller.log" level="DEBUG"/&gt;


    &lt;root level="DEBUG"&gt;
        &lt;appender-ref ref="STDOUT" /&gt;
        &lt;appender-ref ref="FLUENT" /&gt;
    &lt;/root&gt;

&lt;/configuration&gt;
		
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm8577568944"></a>5.6.5.4. 查看 fluent 输出</h4></div></div></div>
			
			<pre class="screen">
			
[0] development.normal: [1664033186.000000000, {"level"=&gt;"INFO", "logger"=&gt;"cn.netkiller.Application", "thread"=&gt;"main", "message"=&gt;"Starting Application using Java 18 on MacBook-Pro-Neo.local with PID 85696 (/Users/neo/workspace/bottleneck/target/classes started by neo in /Users/neo/workspace/bottleneck)"}]
[1] development.normal: [1664033186.000000000, {"level"=&gt;"INFO", "logger"=&gt;"cn.netkiller.Application", "thread"=&gt;"main", "message"=&gt;"The following 1 profile is active: "prod""}]
[0] development.normal: [1664033187.000000000, {"level"=&gt;"INFO", "logger"=&gt;"org.springframework.data.repository.config.RepositoryConfigurationDelegate", "thread"=&gt;"main", "message"=&gt;"Multiple Spring Data modules found, entering strict repository configuration mode"}]
[1] development.normal: [1664033187.000000000, {"level"=&gt;"INFO", "logger"=&gt;"org.springframework.data.repository.config.RepositoryConfigurationDelegate", "thread"=&gt;"main", "message"=&gt;"Bootstrapping Spring Data Redis repositories in DEFAULT mode."}]
[2] development.normal: [1664033187.000000000, {"level"=&gt;"INFO", "logger"=&gt;"org.springframework.data.repository.config.RepositoryConfigurationDelegate", "thread"=&gt;"main", "message"=&gt;"Finished Spring Data repository scanning in 6 ms. Found 0 Redis repository interfaces."}]
[0] development.normal: [1664033188.000000000, {"level"=&gt;"INFO", "logger"=&gt;"org.springframework.boot.web.embedded.tomcat.TomcatWebServer", "thread"=&gt;"main", "message"=&gt;"Tomcat initialized with port(s): 8080 (http)"}]
[1] development.normal: [1664033188.000000000, {"level"=&gt;"INFO", "logger"=&gt;"org.apache.catalina.core.StandardService", "thread"=&gt;"main", "message"=&gt;"Starting service [Tomcat]"}]
[2] development.normal: [1664033188.000000000, {"level"=&gt;"INFO", "logger"=&gt;"org.apache.catalina.core.StandardEngine", "thread"=&gt;"main", "message"=&gt;"Starting Servlet engine: [Apache Tomcat/9.0.65]"}]
[3] development.normal: [1664033188.000000000, {"level"=&gt;"INFO", "logger"=&gt;"org.apache.catalina.core.ContainerBase.[Tomcat].[localhost].[/]", "thread"=&gt;"main", "message"=&gt;"Initializing Spring embedded WebApplicationContext"}]
[4] development.normal: [1664033188.000000000, {"level"=&gt;"INFO", "logger"=&gt;"org.springframework.boot.web.servlet.context.ServletWebServerApplicationContext", "thread"=&gt;"main", "message"=&gt;"Root WebApplicationContext: initialization completed in 2133 ms"}]
[0] development.normal: [1664033189.000000000, {"level"=&gt;"INFO", "logger"=&gt;"org.springframework.boot.actuate.endpoint.web.EndpointLinksResolver", "thread"=&gt;"main", "message"=&gt;"Exposing 14 endpoint(s) beneath base path '/actuator'"}]
[0] development.normal: [1664033189.000000000, {"level"=&gt;"INFO", "logger"=&gt;"org.springframework.boot.web.embedded.tomcat.TomcatWebServer", "thread"=&gt;"main", "message"=&gt;"Tomcat started on port(s): 8080 (http) with context path ''"}]
[1] development.normal: [1664033189.000000000, {"level"=&gt;"INFO", "logger"=&gt;"cn.netkiller.Application", "thread"=&gt;"main", "message"=&gt;"Started Application in 4.224 seconds (JVM running for 4.918)"}]			
			
			</pre>
		</div>
	</div>
	<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="Loki4j"></a>5.6.6. Loki4j Logback</h3></div></div></div>
		
		<p>https://loki4j.github.io/loki-logback-appender/</p>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm8577565552"></a>5.6.6.1. Maven</h4></div></div></div>
			
			<pre class="screen">
			
&lt;dependency&gt;
    &lt;groupId&gt;com.github.loki4j&lt;/groupId&gt;
    &lt;artifactId&gt;loki-logback-appender&lt;/artifactId&gt;
    &lt;version&gt;1.3.2&lt;/version&gt;
&lt;/dependency&gt;			
			
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm8577564048"></a>5.6.6.2. logback.xml</h4></div></div></div>
			
			<pre class="screen">
			
&lt;appender name="LOKI" class="com.github.loki4j.logback.Loki4jAppender"&gt;
    &lt;http&gt;
        &lt;url&gt;http://localhost:3100/loki/api/v1/push&lt;/url&gt;
    &lt;/http&gt;
    &lt;format&gt;
        &lt;label&gt;
            &lt;pattern&gt;app=my-app,host=${HOSTNAME},level=%level&lt;/pattern&gt;
        &lt;/label&gt;
        &lt;message&gt;
            &lt;pattern&gt;l=%level h=${HOSTNAME} c=%logger{20} t=%thread | %msg %ex&lt;/pattern&gt;
        &lt;/message&gt;
        &lt;sortByTime&gt;true&lt;/sortByTime&gt;
    &lt;/format&gt;
&lt;/appender&gt;

&lt;root level="DEBUG"&gt;
    &lt;appender-ref ref="LOKI" /&gt;
&lt;/root&gt;
			
			</pre>
		</div>
	</div>
	<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="log4j2-gelf-logstash"></a>5.6.7. Log4j2 + Gelf + Logstash</h3></div></div></div>
		
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm8577561024"></a>5.6.7.1. Maven 配置</h4></div></div></div>
			
			<pre class="screen">
			
		&lt;dependency&gt;
			&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
			&lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
			&lt;!-- Exclude the Tomcat dependency --&gt;
			&lt;exclusions&gt;
				&lt;exclusion&gt;
					&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
					&lt;artifactId&gt;spring-boot-starter-tomcat&lt;/artifactId&gt;
				&lt;/exclusion&gt;
				&lt;!-- 禁用 logback --&gt;
				&lt;exclusion&gt;
					&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
					&lt;artifactId&gt;spring-boot-starter-logging&lt;/artifactId&gt;
				&lt;/exclusion&gt;
			&lt;/exclusions&gt;
		&lt;/dependency&gt;
		&lt;!-- 添加Log4j2 依赖 --&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
			&lt;artifactId&gt;spring-boot-starter-log4j2&lt;/artifactId&gt;
		&lt;/dependency&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;biz.paluch.logging&lt;/groupId&gt;
			&lt;artifactId&gt;logstash-gelf&lt;/artifactId&gt;
			&lt;version&gt;1.15.0&lt;/version&gt;
		&lt;/dependency&gt;		
			
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm8577559872"></a>5.6.7.2. log4j2.xml 配置</h4></div></div></div>
			
			<pre class="screen">
			
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;Configuration&gt;
	&lt;properties&gt;
		&lt;property name="log.pattern"&gt;[%d{yyyy-MM-dd HH:mm:ss}] [${hostName}] [%p] [%t] %l - %m%n&lt;/property&gt;
		&lt;property name="log.dir"&gt;/tmp/logs&lt;/property&gt;
		&lt;property name="log.level"&gt;info&lt;/property&gt;
	&lt;/properties&gt;
	&lt;Appenders&gt;
		&lt;!-- 控制台 --&gt;
		&lt;Console name="Console" target="SYSTEM_OUT"&gt;
			&lt;PatternLayout pattern="${log.pattern}" /&gt;
		&lt;/Console&gt;

		&lt;!-- INFO级别日志 --&gt;
		&lt;RollingFile name="RollingFileInfo" fileName="${log.dir}/info.log" filePattern="${log.dir}/info.%d{yyyy-MM-dd}.log"&gt;
			&lt;Filters&gt;
				&lt;ThresholdFilter level="INFO" /&gt;
				&lt;ThresholdFilter level="WARN" onMatch="DENY" onMismatch="NEUTRAL" /&gt;
			&lt;/Filters&gt;
			&lt;PatternLayout pattern="${log.pattern}" /&gt;
			&lt;Policies&gt;
				&lt;TimeBasedTriggeringPolicy interval="1" modulate="false" /&gt;
			&lt;/Policies&gt;
		&lt;/RollingFile&gt;

		&lt;!-- WARN级别日志 --&gt;
		&lt;RollingFile name="RollingFileWarn" fileName="${log.dir}/warn.log" filePattern="${log.dir}/warn.%d{yyyy-MM-dd}.log"&gt;
			&lt;Filters&gt;
				&lt;ThresholdFilter level="WARN" /&gt;
				&lt;ThresholdFilter level="ERROR" onMatch="DENY" onMismatch="NEUTRAL" /&gt;
			&lt;/Filters&gt;
			&lt;PatternLayout pattern="${log.pattern}" /&gt;
			&lt;Policies&gt;
				&lt;TimeBasedTriggeringPolicy interval="1" modulate="false" /&gt;
			&lt;/Policies&gt;
		&lt;/RollingFile&gt;

		&lt;!-- ERROR级别日志 --&gt;
		&lt;RollingFile name="RollingFileError" fileName="${log.dir}/error.log" filePattern="${log.dir}/error.%d{yyyy-MM-dd}.log"&gt;
			&lt;Filters&gt;
				&lt;ThresholdFilter level="ERROR" /&gt;
			&lt;/Filters&gt;
			&lt;PatternLayout pattern="${log.pattern}" /&gt;
			&lt;Policies&gt;
				&lt;TimeBasedTriggeringPolicy interval="1" modulate="false" /&gt;
			&lt;/Policies&gt;
		&lt;/RollingFile&gt;

		&lt;Gelf name="Gelf" host="udp:172.18.200.10" port="12201" version="1.1" extractStackTrace="true" filterStackTrace="true" mdcProfiling="true" includeFullMdc="true" maximumMessageSize="8192" originHost="%host{fqdn}"&gt;
			&lt;Field name="timestamp" pattern="%d{yyyy-MM-dd HH:mm:ss.SSS}" /&gt;
			&lt;Field name="logger" pattern="%logger" /&gt;
			&lt;Field name="level" pattern="%level" /&gt;
			&lt;Field name="class" pattern="%C{1}" /&gt;
			&lt;Field name="method" pattern="%M" /&gt;
			&lt;Field name="line" pattern="%L" /&gt;
			&lt;Field name="marker" pattern="%marker" /&gt;
			&lt;Filters&gt;
				&lt;MarkerFilter marker="finance" onMatch="ACCEPT" onMismatch="NEUTRAL" /&gt;
				&lt;MarkerFilter marker="market" onMatch="ACCEPT" onMismatch="DENY" /&gt;
			&lt;/Filters&gt;
		&lt;/Gelf&gt;
	&lt;/Appenders&gt;
	&lt;Loggers&gt;
		&lt;Root level="${sys:log.level}"&gt;
			&lt;AppenderRef ref="Console" /&gt;
			&lt;AppenderRef ref="Gelf" /&gt;
			&lt;!-- &lt;AppenderRef ref="RollingFileInfo" /&gt; &lt;AppenderRef ref="RollingFileWarn" /&gt; &lt;AppenderRef ref="RollingFileError" /&gt; --&gt;
		&lt;/Root&gt;
	&lt;/Loggers&gt;
&lt;/Configuration&gt;			
			
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm8577557824"></a>5.6.7.3. Java 测试代码</h4></div></div></div>
			
			<pre class="screen">
			
	@GetMapping("/log")
	public String log() {
		Marker finance = MarkerFactory.getMarker(LogMarker.finance.toString());
		Marker customer = MarkerFactory.getMarker(LogMarker.customer.toString());
		Marker market = MarkerFactory.getMarker(LogMarker.market.toString());
		logger.info("常规日志");
		logger.info(finance, "test");
		logger.info(finance, "finance");
		logger.info(customer, "customer");
		logger.info(market, "market");
		return "OK!!!\r\n";
	}

	@GetMapping("/log/marker")
	public String marker(@RequestParam("marker") String marker, @RequestParam("msg") String msg) {
		logger.info(MarkerFactory.getMarker(marker), msg);
		msg += "\r\n";
		return msg;
	}			
			
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm8577556512"></a>5.6.7.4. Logstash 配置</h4></div></div></div>
			
			<pre class="screen">
			
[root@netkiller log]# cat /etc/logstash/conf.d/file.conf 
input {
  tcp {
	port =&gt; 4567 
	codec =&gt; json_lines
  }
  gelf {
    port =&gt; 12201
    use_udp =&gt; true
    #use_tcp =&gt; true
  }
}

filter {
	ruby {
	    code =&gt; "event.set('datetime', event.get('@timestamp').time.localtime.strftime('%Y-%m-%d %H:%M:%S'))"
	}
}

output {

    file {
    	path =&gt; "/opt/log/%{marker}.%{+yyyy}-%{+MM}-%{+dd}.log"
    	codec =&gt; line { format =&gt; "[%{datetime}] %{level} %{message}"}
    }
   
    file {
        path =&gt; "/opt/log/origin.%{+yyyy}-%{+MM}-%{+dd}.log.gz"
		codec =&gt; json_lines
        gzip =&gt; true
    }

}			
			
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm8577554608"></a>5.6.7.5. 测试结果</h4></div></div></div>
			
			<pre class="screen">
			
[root@netkiller log]# ls
finance.2022-11-16.log  market.2022-11-16.log  origin.2022-11-16.log.gz

[root@netkiller log]# cat finance.2022-11-16.log 
[2022-11-16 15:02:36] INFO test
[2022-11-16 15:02:36] INFO finance
[2022-11-16 15:21:34] INFO test
[2022-11-16 15:21:34] INFO finance

[root@netkiller log]# cat market.2022-11-16.log 
[2022-11-16 15:02:36] INFO market
[2022-11-16 15:21:34] INFO market

[root@netkiller log]# zcat origin.2022-11-16.log.gz |jq
{
  "datetime": "2022-11-16 15:21:34",
  "timestamp": "2022-11-16 15:21:34.185",
  "message": "market",
  "host": "macbook-pro-neo.local",
  "level": "INFO",
  "line": 53,
  "@version": "1",
  "@timestamp": "2022-11-16T07:21:34.185Z",
  "marker": "market",
  "logger": "cn.netkiller.controller.HomeController",
  "version": "1.1",
  "method": "log",
  "class": "HomeController",
  "source_host": "172.18.5.142",
  "facility": "logstash-gelf"
}
{
  "datetime": "2022-11-16 15:21:34",
  "timestamp": "2022-11-16 15:21:34.143",
  "message": "test",
  "host": "macbook-pro-neo.local",
  "level": "INFO",
  "line": 49,
  "@version": "1",
  "@timestamp": "2022-11-16T07:21:34.143Z",
  "marker": "finance",
  "logger": "cn.netkiller.controller.HomeController",
  "version": "1.1",
  "method": "log",
  "class": "HomeController",
  "source_host": "172.18.5.142",
  "facility": "logstash-gelf"
}
{
  "datetime": "2022-11-16 15:21:34",
  "timestamp": "2022-11-16 15:21:34.184",
  "message": "finance",
  "host": "macbook-pro-neo.local",
  "level": "INFO",
  "line": 51,
  "@version": "1",
  "@timestamp": "2022-11-16T07:21:34.184Z",
  "marker": "finance",
  "logger": "cn.netkiller.controller.HomeController",
  "version": "1.1",
  "method": "log",
  "class": "HomeController",
  "source_host": "172.18.5.142",
  "facility": "logstash-gelf"
}
			
			
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm8577552736"></a>5.6.7.6. Log4j2 更多技巧</h4></div></div></div>
			
			<div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="idm8577551936"></a>多环境配置</h5></div></div></div>
				
				<p>方案一</p>
				<pre class="screen">
			
logging:
  config: classpath:log4j2-${spring.profiles.active}.xml
			
				</pre>
				<p>方案二</p>
				<pre class="screen">
				
@SpringBootApplication
public class Application implements CommandLineRunner {

    @Autowired
    private Environment env;

    public static void main(String[] args) {
        SpringApplication.run(Application.class, args);
    }

    @Override
    public void run(String... param) {
        if (Arrays.asList(env.getActiveProfiles()).contains("dev")) {
            Configurator.initialize(null, "/path/to/log4j2-dev.xml");
        } else {
            Configurator.initialize(null, "/path/to/log4j2.xml");
        }
    }
}				
				
				</pre>
			</div>
			<div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="idm8577548800"></a>控制 class 日志输出级别</h5></div></div></div>
				
				<pre class="screen">
				
#日志配置 无特殊需求无需更改
logging:
  config:  classpath:log4j2.xml
  level:
    root: INFO
    javax.activation: info
    org.apache.catalina: INFO
    org.apache.commons.beanutils.converters: INFO
    org.apache.coyote.http11.Http11Processor: INFO
    org.apache.http: INFO
    org.apache.tomcat: INFO
    org.springframework: INFO
    com.chinamobile.cmss.bdpaas.resource.monitor: DEBUG				
				
				</pre>
			</div>
			<div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="idm8577547136"></a>读取系统变量/环境变量</h5></div></div></div>
				
				<pre class="screen">
				
${sys:catalina.home}/logs
${env:log.home}/logs
				
				</pre>
			</div>
			<div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="idm8577545824"></a>读取 spring 配置</h5></div></div></div>
				
				<p>引入依赖</p>
				<pre class="screen">
				
		&lt;dependency&gt;
			&lt;groupId&gt;org.apache.logging.log4j&lt;/groupId&gt;
			&lt;artifactId&gt;log4j-spring-boot&lt;/artifactId&gt;
		&lt;/dependency&gt;				
				
				</pre>
				<p>例子</p>
				<pre class="screen">
				 
&lt;Configuration name="ConfigTest" status="ERROR" monitorInterval="5"&gt;
	&lt;properties&gt;
		&lt;property name="applicationName"&gt;${spring:spring.application.name}&lt;/property&gt;
	&lt;/properties&gt;
	&lt;Appenders&gt;
	
	&lt;SpringProfile name="dev | staging"&gt;
		&lt;Console name="Out"&gt;
			&lt;PatternLayout pattern="%m%n"/&gt;
		&lt;/Console&gt;
	&lt;/SpringProfile&gt;
	&lt;SpringProfile name="prod"&gt;
		&lt;List name="Out"&gt;
		&lt;/List&gt;
	&lt;/SpringProfile&gt;
	
	&lt;/Appenders&gt;
	&lt;Loggers&gt;
		&lt;Logger name="org.apache.test" level="trace" additivity="false"&gt;
		&lt;AppenderRef ref="Out"/&gt;
		&lt;/Logger&gt;
		&lt;Root level="error"&gt;
		&lt;AppenderRef ref="Out"/&gt;
		&lt;/Root&gt;
	&lt;/Loggers&gt;
&lt;/Configuration&gt;								  
				
				</pre>
				<p>读取方法 ${spring:spring.profiles.active}</p>
				<pre class="screen">
				
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;Configuration&gt;
	&lt;properties&gt;
		&lt;property name="log.pattern"&gt;[%d{yyyy-MM-dd HH:mm:ss}] [${hostName}] [%p] [%t] %l - %m%n&lt;/property&gt;
		&lt;property name="log.home"&gt;/tmp/logs&lt;/property&gt;
		&lt;property name="log.level"&gt;info&lt;/property&gt;
	&lt;/properties&gt;
	&lt;Appenders&gt;
		&lt;Console name="Console" target="SYSTEM_OUT"&gt;
			&lt;PatternLayout pattern="${log.pattern}" /&gt;
		&lt;/Console&gt;
		&lt;Gelf name="dev" host="udp:172.18.200.10" port="12201" version="1.1" extractStackTrace="true" filterStackTrace="true" mdcProfiling="true" includeFullMdc="true" maximumMessageSize="8192" originHost="%host{fqdn}"&gt;
			&lt;Field name="timestamp" pattern="%d{yyyy-MM-dd HH:mm:ss.SSS}" /&gt;
			&lt;Field name="logger" pattern="%logger" /&gt;
			&lt;Field name="level" pattern="%level" /&gt;
			&lt;Field name="class" pattern="%C{1}" /&gt;
			&lt;Field name="method" pattern="%M" /&gt;
			&lt;Field name="line" pattern="%L" /&gt;
			&lt;Field name="marker" pattern="%marker" /&gt;
			&lt;Filters&gt;
				&lt;MarkerFilter marker="finance" onMatch="ACCEPT" onMismatch="NEUTRAL" /&gt;
				&lt;MarkerFilter marker="market" onMatch="ACCEPT" onMismatch="DENY" /&gt;
			&lt;/Filters&gt;
		&lt;/Gelf&gt;
	&lt;/Appenders&gt;
	&lt;Loggers&gt;
		&lt;Root level="${sys:log.level}"&gt;
			&lt;AppenderRef ref="Console" /&gt;
			&lt;AppenderRef ref="${spring:spring.profiles.active:-dev}" /&gt;
		&lt;/Root&gt;
	&lt;/Loggers&gt;
&lt;/Configuration&gt;				
				
				</pre>
				<p>Spring 2.1.4 无法获取配置，解决方法使用 sys，同时启动的时候增加系统配置项 java
					-Dspring.application.name=netkiller -Dspring.profiles.active=dev
					-jar netkiller.jar </p>
				<pre class="screen">
				 
&lt;property name="service"&gt;${sys:spring.application.name}&lt;/property&gt;
&lt;property name="environment"&gt;${sys:spring.profiles.active}&lt;/property&gt;				
				
				</pre>
			</div>
		</div>
	</div>
	<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="idm8577540560"></a>5.6.8. 日志报警</h3></div></div></div>
		
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm8577539840"></a>5.6.8.1. Logstash 配置</h4></div></div></div>
			
			<p>将 ERROR 和 WARN 级别的日志发送到钉钉群</p>
			<pre class="screen">
			 
[root@netkiller ~]# cat /etc/logstash/conf.d/file.conf 
input {
	tcp {
	port =&gt; 4567 
	codec =&gt; json_lines
	}
	gelf {
	port =&gt; 12201
	use_udp =&gt; true
	#use_tcp =&gt; true
	}
}

filter {
	ruby {
		code =&gt; "event.set('datetime', event.get('@timestamp').time.localtime.strftime('%Y-%m-%d %H:%M:%S'))"
	}
}

output {

	file {
		path =&gt; "/opt/log/%{marker}.%{+yyyy}-%{+MM}-%{+dd}.log"
		codec =&gt; line { format =&gt; "[%{datetime}] %{level} %{message}"}
	}
	
	file {
		path =&gt; "/opt/log/origin.%{+yyyy}-%{+MM}-%{+dd}.log.gz"
		codec =&gt; json_lines
		gzip =&gt; true
	}
	if "ERROR" in [level] or "WARN" in [level] {
		http {
			url =&gt; "https://oapi.dingtalk.com/robot/send?access_token=56c27cb734a56cf549f6977ecc2761c4a16473db02d9d2881d008f9a239ba3e0"
			http_method =&gt; "post"
			content_type =&gt; "application/json; charset=utf-8"
			format =&gt; "message"
			message =&gt; '{"msgtype":"text","text":{"content":"Monitor: %{host}  - %{message}"}}'
		}
	}
}			
			
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm8577538048"></a>5.6.8.2. 监控 SpringBootApplication 的启动和退出</h4></div></div></div>
			
			<pre class="screen">
			 
neo@MacBook-Pro-M2 ~ % cat workspace/bottleneck/src/main/java/cn/netkiller/Application.java 
package cn.netkiller;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.slf4j.MarkerFactory;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;

import jakarta.annotation.PostConstruct;
import jakarta.annotation.PreDestroy;

@EnableDiscoveryClient
@SpringBootApplication
public class Application {
	private static final Logger logger = LoggerFactory.getLogger(Application.class);

	@PostConstruct
	public void init() {
		System.out.printf("==================== init ====================");
		logger.warn(MarkerFactory.getMarker("finance"), "XXX 系统启动");
	}

	@PreDestroy
	public void destroy() {
		System.out.printf("==================== destroy ====================");
		logger.error(MarkerFactory.getMarker("finance"), "XXX 系统销毁");
	}

	public static void main(String[] args) {
		System.out.println("Netkiller bottleneck tool!");
		SpringApplication.run(Application.class, args);
	}
}
			
			
			</pre>
			<p>@PostConstruct 可以监控 启动情况</p>
			<p>@PreDestroy 可以监控 退出情况</p>
		</div>
	</div>
	<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="SpringBoot.ELK"></a>5.6.9. Spring boot with ELK(Elasticsearch + Logstash + Kibana)</h3></div></div></div>
		
		<p>将 Spring boot 日志写入 ELK 有多种实现方式，这里仅提供三种方案：</p>
		<div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
				<p>Spring boot -&gt; logback -&gt; Tcp/IP -&gt; logstash -&gt;
					elasticsearch</p>
				这种方式实现非常方便不需要而外包或者软件
			</li><li class="listitem">
				<p>Spring boot -&gt; logback -&gt; Redis -&gt; logstash -&gt;
					elasticsearch</p>
				利用 Redis 提供的发布订阅功能将日志投递到 elasticsearch
			</li><li class="listitem">
				<p>Spring boot -&gt; logback -&gt; Kafka -&gt; logstash -&gt;
					elasticsearch</p>
				Kafka 方法适合大数据的情况。
			</li></ol></div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm8577529792"></a>5.6.9.1. TCP 方案</h4></div></div></div>
			
			<p>logstash 配置</p>
			<pre class="programlisting">
			
input {
  tcp {
    host =&gt; "172.16.1.16" 
    port =&gt; 9250
    mode =&gt; "server"
    tags =&gt; ["tags"]
    codec =&gt; json_lines  //可能需要更新logstash插件
  }
}

output {
 stdout{codec =&gt;rubydebug}
  elasticsearch {
   hosts =&gt; ["localhost:9200"]  //这块配置需要带端口号
    flush_size =&gt; 1000

  }
}			
			
			</pre>
			<p>Spring boot logback.xml 配置</p>
			<pre class="programlisting">
			
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;configuration&gt;
    &lt;property resource="properties/logback-variables.properties" /&gt; 

    &lt;appender name="STDOUT" class="ch.qos.logback.core.ConsoleAppender"&gt;
        &lt;encoder charset="UTF-8"&gt;
            &lt;pattern&gt;%d{HH:mm:ss.SSS} [%thread] %-5level %logger - %msg%n
            &lt;/pattern&gt;
        &lt;/encoder&gt;
    &lt;/appender&gt;
    &lt;appender name="LOGSTASH" class="net.logstash.logback.appender.LogstashTcpSocketAppender"&gt;
        &lt;destination&gt;172.16.1.16:9250&lt;/destination&gt;
        &lt;encoder charset="UTF-8" class="net.logstash.logback.encoder.LogstashEncoder" /&gt;
    &lt;/appender&gt;

    &lt;!--&lt;appender name="async" class="ch.qos.logback.classic.AsyncAppender"&gt;--&gt;
        &lt;!--&lt;appender-ref ref="stash" /&gt;--&gt;
    &lt;!--&lt;/appender&gt;--&gt;
    
    &lt;root level="info"&gt;                    &lt;!-- 设置日志级别 --&gt;
        &lt;appender-ref ref="STDOUT" /&gt;
        &lt;appender-ref ref="LOGSTASH" /&gt;
    &lt;/root&gt;
&lt;/configuration&gt;			
			
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm8577527120"></a>5.6.9.2. Redis 方案</h4></div></div></div>
			
			<p>https://github.com/kmtong/logback-redis-appender</p>
			<p>Maven pom.xml 增加 Logback Redis 依赖</p>
			<pre class="programlisting">
			
&lt;!-- https://mvnrepository.com/artifact/com.cwbase/logback-redis-appender --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.cwbase&lt;/groupId&gt;
    &lt;artifactId&gt;logback-redis-appender&lt;/artifactId&gt;
    &lt;version&gt;1.1.5&lt;/version&gt;
&lt;/dependency&gt;			
			
			</pre>
			<p>Spring boot logback.xml 配置</p>
			<pre class="programlisting">
			
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;configuration&gt;
	&lt;include resource="org/springframework/boot/logging/logback/defaults.xml" /&gt;
	&lt;include resource="org/springframework/boot/logging/logback/file-appender.xml" /&gt;
	&lt;property name="type.name" value="test" /&gt;
	&lt;appender name="LOGSTASH" class="com.cwbase.logback.RedisAppender"&gt;
		&lt;source&gt;spring-application&lt;/source&gt;
		&lt;type&gt;${type.name}&lt;/type&gt;
		&lt;host&gt;localhost&lt;/host&gt;
		&lt;key&gt;logstash:redis&lt;/key&gt;
		&lt;tags&gt;test-2&lt;/tags&gt;
		&lt;mdc&gt;true&lt;/mdc&gt;
		&lt;location&gt;true&lt;/location&gt;
		&lt;callerStackIndex&gt;0&lt;/callerStackIndex&gt;
		&lt;!--additionalField添加附加字段 用于head插件显示 --&gt;
		&lt;additionalField&gt;
			&lt;key&gt;MyKey&lt;/key&gt;
			&lt;value&gt;MyValue&lt;/value&gt;
		&lt;/additionalField&gt;
		&lt;additionalField&gt;
			&lt;key&gt;MySecondKey&lt;/key&gt;
			&lt;value&gt;MyOtherValue&lt;/value&gt;
		&lt;/additionalField&gt;
	&lt;/appender&gt;
	&lt;root level="INFO"&gt;
		&lt;appender-ref ref="FILE" /&gt;
		&lt;appender-ref ref="LOGSTASH" /&gt;
	&lt;/root&gt;
&lt;/configuration&gt;
			
			</pre>
			<p>logstash 配置</p>
			<pre class="programlisting">
			
input {
    redis {
        host =&gt; 'localhost'
        data_type =&gt; 'list'
        port =&gt; "6379"
        key =&gt; 'logstash:redis' #自定义
        type =&gt; 'redis-input'   #自定义
    }
}
output {
    elasticsearch {
        host =&gt; "localhost" 
        codec =&gt; "json"
        protocol =&gt; "http"
    }
}
			
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm8577520752"></a>5.6.9.3. Kafka 方案</h4></div></div></div>
			
			<pre class="programlisting">
			
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm8577519600"></a>5.6.9.4. Other</h4></div></div></div>
			
			<pre class="programlisting">
			
			</pre>
		</div>
	</div>
</div><div xmlns="" id="SOHUCS"></div><script xmlns="" charset="utf-8" type="text/javascript" src="https://cy-cdn.kuaizhan.com/upload/changyan.js"></script><script xmlns="" type="text/javascript">
window.changyan.api.config({
appid: 'cyvwjQUG3',
conf: 'prod_ef966242df3d8b5acb1e0ee9fc01cafe'
});
</script><script xmlns="" type="text/javascript" id="clustrmaps" src="//cdn.clustrmaps.com/map_v2.js?u=r5HG&amp;d=9mi5r_kkDC8uxG8HuY3p4-2qgeeVypAK9vMD-2P6BYM"></script><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="springboot.properties.html">上一页</a> </td><td width="20%" align="center"><a accesskey="u" href="index.html">上一级</a></td><td width="40%" align="right"> <a accesskey="n" href="Undertow.html">下一页</a></td></tr><tr><td width="40%" align="left" valign="top">5.5. Properties 配置文件 </td><td width="20%" align="center"><a accesskey="h" href="../../index.html">起始页</a></td><td width="40%" align="right" valign="top"> 5.7. Undertow</td></tr></table></div><script xmlns="">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-11694057-1', 'auto');
  ga('send', 'pageview');

</script><script xmlns="" async="async">
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?93967759a51cda79e49bf4e34d0b0f2c";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script xmlns="" async="async">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script></body></html>