<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>第 13 章 SonarQube</title><link rel="stylesheet" type="text/css" href="../docbook.css" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><meta name="keywords" content="&#10;svn, svnauthz-validate, svnlook,svn-populate-node-origins-index, svnsync, svnadmin, svndumpfilter, svnmucc, svnserve, svnversion&#10;&#9;&#9;&#9;, &#10;git,git-add,git-add--interactive,git-am,git-annotate,git-apply,git-archive,git-bisect,git-bisect--helper,git-blame,git-branch,git-bundle,git-cat-file,git-check-attr,git-checkout,git-checkout-index,git-check-ref-format,git-cherry,git-cherry-pick,git-clean,git-clone,git-commit,git-commit-tree,git-config,git-count-objects,git-daemon,git-describe,git-diff,git-diff-files,git-diff-index,git-difftool,git-difftool--helper,git-diff-tree,git-fast-export,git-fast-import,git-fetch,git-fetch-pack,git-filter-branch,git-fmt-merge-msg,git-for-each-ref,git-format-patch,git-fsck,git-fsck-objects,git-gc,git-get-tar-commit-id,git-grep,git-hash-object,git-help,git-http-backend,git-http-fetch,git-http-push,git-imap-send,git-index-pack,git-init,git-init-db,git-instaweb,git-log,git-lost-found,git-ls-files,git-ls-remote,git-ls-tree,git-mailinfo,git-mailsplit,git-merge,git-merge-base,git-merge-file,git-merge-index,git-merge-octopus,git-merge-one-file,git-merge-ours,git-merge-recursive,git-merge-resolve,git-merge-subtree,git-mergetool,git-mergetool--lib,git-merge-tree,git-mktag,git-mktree,git-mv,git-name-rev,git-notes,git-pack-objects,git-pack-redundant,git-pack-refs,git-parse-remote,git-patch-id,git-peek-remote,git-prune,git-prune-packed,git-pull,git-push,git-quiltimport,git-read-tree,git-rebase,git-rebase--interactive,git-receive-pack,git-reflog,git-relink,git-remote,git-remote-ftp,git-remote-ftps,git-remote-http,git-remote-https,git-remote-testgit,git-repack,git-replace,git-repo-config,git-request-pull,git-rerere,git-reset,git-revert,git-rev-list,git-rev-parse,git-rm,git-send-pack,git-shell,git-shortlog,git-show,git-show-branch,git-show-index,git-show-ref,git-sh-setup,git-stage,git-stash,git-status,git-stripspace,git-submodule,git-symbolic-ref,git-tag,git-tar-tree,git-unpack-file,git-unpack-objects,git-update-index,git-update-ref,git-update-server-info,git-upload-archive,git-upload-pack,git-var,git-verify-pack,git-verify-tag,git-web--browse,git-whatchanged,git-write-tree&#10;&#9;&#9;&#9;" /><link rel="home" href="../index.html" title="Netkiller DevOps 手札" /><link rel="up" href="../project.html" title="部分 II. 项目管理工具" /><link rel="prev" href="../jenkins/Jenkinsfile.example.html" title="12.6. Jenkinsfile Pipeline Example" /><link rel="next" href="ch13s02.html" title="13.2. 配置" /></head><body><a xmlns="" href="//www.netkiller.cn/">Home</a> |
		<a xmlns="" href="//netkiller.github.io/">简体中文</a> |
	    <a xmlns="" href="http://netkiller.sourceforge.net/">繁体中文</a> |
	    <a xmlns="" href="/journal/index.html">杂文</a> |
	    <a xmlns="" href="https://github.com/netkiller">Github</a> |
	    <a xmlns="" href="https://zhuanlan.zhihu.com/netkiller">知乎专栏</a> |
   	    <a xmlns="" href="https://edu.51cto.com/lecturer/1703915.html">51CTO学院</a> |
	    <a xmlns="" href="https://edu.csdn.net/lecturer/6423">CSDN程序员研修院</a> |
	    <a xmlns="" href="http://my.oschina.net/neochen/">OSChina 博客</a> |
	    <a xmlns="" href="https://cloud.tencent.com/developer/column/2078">腾讯云社区</a> |
	    <a xmlns="" href="https://yq.aliyun.com/u/netkiller/">阿里云栖社区</a> |
	    <a xmlns="" href="https://www.facebook.com/bg7nyt">Facebook</a> |
	    <a xmlns="" href="http://cn.linkedin.com/in/netkiller/">Linkedin</a> |
	    <a xmlns="" href="https://www.youtube.com/user/bg7nyt/videos">Youtube</a> |
	    <a xmlns="" href="//www.netkiller.cn/home/donations.html">打赏(Donations)</a> |
	    <a xmlns="" href="//www.netkiller.cn/home/about.html">About</a><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">第 13 章 SonarQube</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="../jenkins/Jenkinsfile.example.html">上一页</a> </td><th width="60%" align="center">部分 II. 项目管理工具</th><td width="20%" align="right"> <a accesskey="n" href="ch13s02.html">下一页</a></td></tr></table><hr /></div><table xmlns=""><tr><td><iframe src="//ghbtns.com/github-btn.html?user=netkiller&amp;repo=netkiller.github.io&amp;type=watch&amp;count=true&amp;size=large" height="30" width="170" frameborder="0" scrolling="0" style="width:170px; height: 30px;" allowTransparency="true"></iframe></td><td><iframe src="//ghbtns.com/github-btn.html?user=netkiller&amp;repo=netkiller.github.io&amp;type=fork&amp;count=true&amp;size=large" height="30" width="170" frameborder="0" scrolling="0" style="width:170px; height: 30px;" allowTransparency="true"></iframe></td><td><iframe src="//ghbtns.com/github-btn.html?user=netkiller&amp;type=follow&amp;count=true&amp;size=large" height="30" width="240" frameborder="0" scrolling="0" style="width:240px; height: 30px;" allowTransparency="true"></iframe></td><td></td><td><a href="https://zhuanlan.zhihu.com/netkiller"><img src="/images/logo/zhihu-card-default.svg" height="25" /></a></td><td valign="middle"><a href="https://zhuanlan.zhihu.com/netkiller">知乎专栏</a> ｜ <a href="https://www.zhihu.com/club/1241768772601950208">多维度架构</a></td><td></td><td></td><td></td><td></td></tr></table><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="index"></a>第 13 章 SonarQube</h2></div></div></div><div class="toc"><p><strong>目录</strong></p><dl class="toc"><dt><span class="section"><a href="index.html#idm405913992528">13.1. 安装</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#idm405913991856">13.1.1. Kubernetes 安装 SonarQube</a></span></dt><dt><span class="section"><a href="index.html#idm405913991728">13.1.2. Docker</a></span></dt><dt><span class="section"><a href="index.html#idm405913983936">13.1.3. netkiller-devops 安装</a></span></dt><dt><span class="section"><a href="index.html#idm405913981808">13.1.4. SonarScanner</a></span></dt></dl></dd><dt><span class="section"><a href="ch13s02.html">13.2. 配置 </a></span></dt><dd><dl><dt><span class="section"><a href="ch13s02.html#idm405913976064">13.2.1. 登陆 SonarQube</a></span></dt><dt><span class="section"><a href="ch13s02.html#idm405913970224">13.2.2. 本地 maven 执行 SonarQube</a></span></dt><dt><span class="section"><a href="ch13s02.html#idm405913948832">13.2.3. 集成 Gitlab</a></span></dt><dt><span class="section"><a href="ch13s02.html#SonarScanner">13.2.4. SonarScanner</a></span></dt></dl></dd><dt><span class="section"><a href="ch13s03.html">13.3. FAQ</a></span></dt><dd><dl><dt><span class="section"><a href="ch13s03.html#idm405913914448">13.3.1. bootstrap check failure [1] of [1]: max virtual memory areas vm.max_map_count [65530] is too low, increase to at least [262144]</a></span></dt><dt><span class="section"><a href="ch13s03.html#idm405913911808">13.3.2. failed: An API incompatibility was encountered while executing org.sonarsource.scanner.maven:sonar-maven-plugin:3.9.0.2155:sonar: java.lang.UnsupportedClassVersionError: org/sonar/batch/bootstrapper/EnvironmentInformation has been compiled by a more recent version of the Java Runtime (class file version 55.0), this version of the Java Runtime only recognizes class file versions up to 52.0</a></span></dt><dt><span class="section"><a href="ch13s03.html#idm405913911552">13.3.3. [ERROR] An unknown compilation problem occurred</a></span></dt><dt><span class="section"><a href="ch13s03.html#idm405913897952">13.3.4. can't have 2 modules with the following key</a></span></dt><dt><span class="section"><a href="ch13s03.html#idm405913897696">13.3.5. Kubernetes 运行 sonar-scanner</a></span></dt></dl></dd></dl></div>
	
	<p>
		<a class="ulink" href="https://www.sonarqube.org" target="_top">https://www.sonarqube.org</a>
	</p>
	<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="idm405913992528"></a>13.1. 安装</h2></div></div></div>
		
		<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="idm405913991856"></a>13.1.1. Kubernetes 安装 SonarQube</h3></div></div></div>
			
			<pre class="screen">
			
import sys, os

sys.path.insert(0, '/Users/neo/workspace/GitHub/devops')
from netkiller.kubernetes import *

namespace = 'default'

service = Service()
service.metadata().name('sonarqube')
service.metadata().namespace(namespace)
service.spec().selector({'app': 'sonarqube'})
service.spec().type('NodePort')
service.spec().ports([{
	'name': 'sonarqube',
	'protocol': 'TCP',
	'port': 80,
	'targetPort': 9000
}])

statefulSet = StatefulSet()
statefulSet.metadata().namespace(namespace)
statefulSet.metadata().name('sonarqube').labels({'app': 'sonarqube'})
statefulSet.spec().replicas(1)
statefulSet.spec().serviceName('sonarqube')
statefulSet.spec().selector({'matchLabels': {'app': 'sonarqube'}})
statefulSet.spec().template().metadata().labels({'app': 'sonarqube'})

statefulSet.spec().template().spec().containers(
).name('postgresql').image('postgres:latest').ports([{
	'containerPort': 5432
}]).env([
		{'name': 'TZ', 'value': 'Asia/Shanghai'},
		{'name': 'LANG', 'value': 'en_US.UTF-8'},
		{'name': 'POSTGRES_USER', 'value': 'sonar'},
		{'name': 'POSTGRES_PASSWORD', 'value': 'sonar'}
]).volumeMounts([
	{
		'name': 'postgresql',
		'mountPath': '/var/lib/postgresql'
	},
	{
		'name': 'postgresql',
		'mountPath': '/var/lib/postgresql/data',
		'subPath' : 'data'
	},
])

statefulSet.spec().template().spec().containers(
).name('sonarqube').image('sonarqube:community').ports([{
	'containerPort': 9000
}]).env([
		{'name': 'TZ', 'value': 'Asia/Shanghai'},
		{'name': 'LANG', 'value': 'en_US.UTF-8'},
		{'name': 'SONAR_JDBC_URL', 'value': 'jdbc:postgresql://localhost:5432/sonar'},
		{'name': 'SONAR_JDBC_USERNAME', 'value': 'sonar'},
		{'name': 'SONAR_JDBC_PASSWORD', 'value': 'sonar'}
]).resources().livenessProbe().readinessProbe().volumeMounts([
	{
		'name': 'sonarqube',
		'mountPath': '/opt/sonarqube/data',
		'subPath' : 'data'
	},
	{
		'name': 'sonarqube',
		'mountPath': '/opt/sonarqube/extensions',
		'subPath' : 'extensions'
	},
]).securityContext({'privileged': True})

statefulSet.spec().template().spec().volumes([
	{
	'name': 'sonarqube',
	'persistentVolumeClaim': {
		'claimName': 'sonarqube'
	}
},
	{
	'name': 'postgresql',
	'persistentVolumeClaim': {
		'claimName': 'postgresql'
	}
}
])
statefulSet.spec().volumeClaimTemplates([{
	'metadata':{'name': 'sonarqube'},
	'spec':{
		'accessModes': [ "ReadWriteOnce" ],
		'storageClassName': "local-path",
		'resources':{'requests':{'storage': '2Gi'}}
	}
},{
	'metadata':{'name': 'postgresql'},
	'spec':{
		'accessModes': [ "ReadWriteOnce" ],
		'storageClassName': "local-path",
		'resources':{'requests':{'storage': '2Gi'}}
	}
}
])


ingress = Ingress()
ingress.apiVersion('networking.k8s.io/v1')
ingress.metadata().name('sonarqube')
ingress.metadata().namespace(namespace)
ingress.spec().rules([
{
	'host': 'sonarqube.netkiller.cn',
	'http':{
		'paths': [{
			'pathType': Define.Ingress.pathType.Prefix,
			'path': '/', 
			'backend':{
				'service':{
					'name':'sonarqube', 
					'port':{'number': 80}
				}
			}}]}
}
])

compose = Compose('development')
compose.add(service)
compose.add(statefulSet)
compose.add(ingress)

kubeconfig = '/Users/neo/workspace/kubernetes/office.yaml'
# kubeconfig = os.path.expanduser('~/workspace/ops/k3s.yaml')

kubernetes = Kubernetes(kubeconfig)
kubernetes.compose(compose)
kubernetes.main()			
			
			</pre>
			<p>连接 sonarqube，注意在容器内部访问 sonarqube 的地址是 sonar.host.url=http://sonarqube.default.svc.cluster.local，如果是外部连接才需要走 ingress sonar.host.url=http://sonarqube.netkiller.cn，还要注意一点 kubernetes service 端口是80 不是 9000</p>
			<pre class="screen">
			
sonarqube-check:
	stage: test
	image: registry.netkiller.cn/share/maven:3.8.6-openjdk-11
	variables:
		# SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"  # Defines the location of the analysis task cache
		GIT_DEPTH: "0"  # Tells git to fetch all the branches of the project, required by the analysis task
	cache:
		key: "${CI_JOB_NAME}"
		paths:
		- .sonar/cache
	# before_script:
		# - cat ${MODULE}/pom.xml
	script:
		- mvn -T 1C clean verify sonar:sonar -Dsonar.projectKey=end-fscs -Dsonar.host.url=http://sonarqube.default.svc.cluster.local -Dsonar.login=sqp_d1edb4be69ecc1b3b0ef66f06c4e395822a16a58  
	only:
		- office
		- dev
		- test
	tags:
		- kubernetes
	allow_failure: true
		  
			
			</pre>
			<p>还有一点需要注意，必须使用 openjdk-11，SonarQube 不支持 Java 1.8</p>
		</div>
		<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="idm405913991728"></a>13.1.2. Docker</h3></div></div></div>
			
			<pre class="screen">
			
docker volume create --name sonarqube_data
docker volume create --name sonarqube_logs
docker volume create --name sonarqube_extensions
			
docker run -d --name sonarqube \
    -p 9000:9000 \
    -e SONAR_JDBC_URL=jdbc:postgresql://db.netkiller.cn:5432/sonar \
    -e SONAR_JDBC_USERNAME=sonar \
    -e SONAR_JDBC_PASSWORD=sonar \
    -v sonarqube_data:/opt/sonarqube/data \
    -v sonarqube_extensions:/opt/sonarqube/extensions \
    -v sonarqube_logs:/opt/sonarqube/logs \
    sonarqube:community			
			
			</pre>
			<p>Docker compose</p>
			<pre class="screen">
			
version: "3"

services:
  sonarqube:
    container_name: sonarqube
    image: sonarqube:community
    restart: always
    depends_on:
      - db
    environment:
      SONAR_JDBC_URL: jdbc:postgresql://db:5432/sonar
      SONAR_JDBC_USERNAME: sonar
      SONAR_JDBC_PASSWORD: sonar
    volumes:
      - sonarqube_data:/opt/sonarqube/data
      - sonarqube_extensions:/opt/sonarqube/extensions
      - sonarqube_logs:/opt/sonarqube/logs
    ports:
      - "9000:9000"
  db:
    container_name: postgresql
    image: postgres:latest
    restart: always
    environment:
      POSTGRES_USER: sonar
      POSTGRES_PASSWORD: sonar
    volumes:
      - postgresql:/var/lib/postgresql
      - postgresql_data:/var/lib/postgresql/data

volumes:
  sonarqube_data:
  sonarqube_extensions:
  sonarqube_logs:
  postgresql:
  postgresql_data:		
			
			</pre>
			<p>/etc/sysctl.conf 增加配置项，否则无法启动 sonarqube，提示 sonarqube | bootstrap check failure [1] of [1]: max virtual memory areas vm.max_map_count [65530] is too low, increase to at least [262144]</p>
			<pre class="screen">
			
vm.max_map_count=655360		
			
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="idm405913983936"></a>13.1.3. netkiller-devops 安装</h3></div></div></div>
			
			<pre class="screen">
			
pip install netkiller-devops			
			
			</pre>
			<p>创建 sonarqube 文件</p>
			<pre class="programlisting">
			
#!/usr/bin/env python3
from netkiller.docker import *

projectVolume = Volumes()
projectVolume.create('sonarqube_data')
projectVolume.create('sonarqube_extensions')
projectVolume.create('sonarqube_logs')
projectVolume.create('postgresql')
projectVolume.create('postgresql_data')
# projectVolume.create('')

sonarqube = Services('sonarqube')
sonarqube.container_name('sonarqube').image('sonarqube:community').restart('always').ports("9000:9000")
sonarqube.environment([
	'SONAR_JDBC_URL=jdbc:postgresql://postgresql:5432/sonar',
	'SONAR_JDBC_USERNAME=sonar',
	'SONAR_JDBC_PASSWORD=sonar'
]).volumes([
	'sonarqube_data:/opt/sonarqube/data',
    'sonarqube_extensions:/opt/sonarqube/extensions',
    'sonarqube_logs:/opt/sonarqube/logs'
]).depends_on('postgresql')
      
postgresql = Services('postgresql')
postgresql.container_name('postgresql').image('postgres:latest').restart('always')
postgresql.environment([
	'POSTGRES_USER=sonar',
    'POSTGRES_PASSWORD=sonar'
]).volumes([
	'postgresql:/var/lib/postgresql',
    'postgresql_data:/var/lib/postgresql/data'
])

project = Composes('project')
project.version('3.9')
project.volumes(projectVolume)
project.services(sonarqube)
project.services(postgresql)

if __name__ == '__main__':
	try:
		docker = Docker()
		docker.environment(project)
		docker.main()
	except KeyboardInterrupt:
		print ("Crtl+C Pressed. Shutting down.")			
			
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="idm405913981808"></a>13.1.4. SonarScanner</h3></div></div></div>
			
			<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm405913981088"></a>13.1.4.1. Docker 安装</h4></div></div></div>
				
				<pre class="screen">
			
docker run \
    --rm \
    -e SONAR_HOST_URL="http://${SONARQUBE_URL}" \
    -e SONAR_LOGIN="myAuthenticationToken" \
    -v "${YOUR_REPO}:/usr/src" \
    sonarsource/sonar-scanner-cli
			
				</pre>
			</div>
			<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm405913979536"></a>13.1.4.2. 本地安装</h4></div></div></div>
				
				<p>SonarQube 必须使用 Java 11</p>
				<pre class="screen">
			
[root@localhost ~]# dnf install java-11-openjdk java-11-openjdk-devel			
			
				</pre>
				<p>安装 SonarScanner</p>
				<pre class="screen">
			
			
			
				</pre>
			</div>
		</div>
	</div>
	
	
</div><div xmlns="" id="SOHUCS"></div><script xmlns="" charset="utf-8" type="text/javascript" src="https://cy-cdn.kuaizhan.com/upload/changyan.js"></script><script xmlns="" type="text/javascript">
window.changyan.api.config({
appid: 'cyvwjQUG3',
conf: 'prod_ef966242df3d8b5acb1e0ee9fc01cafe'
});
</script><script xmlns="" type="text/javascript" id="clustrmaps" src="//cdn.clustrmaps.com/map_v2.js?u=r5HG&amp;d=9mi5r_kkDC8uxG8HuY3p4-2qgeeVypAK9vMD-2P6BYM"></script><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="../jenkins/Jenkinsfile.example.html">上一页</a> </td><td width="20%" align="center"><a accesskey="u" href="../project.html">上一级</a></td><td width="40%" align="right"> <a accesskey="n" href="ch13s02.html">下一页</a></td></tr><tr><td width="40%" align="left" valign="top">12.6. Jenkinsfile Pipeline Example </td><td width="20%" align="center"><a accesskey="h" href="../index.html">起始页</a></td><td width="40%" align="right" valign="top"> 13.2. 配置 </td></tr></table></div><script xmlns="">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-11694057-1', 'auto');
  ga('send', 'pageview');

</script><script xmlns="" async="async">
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?93967759a51cda79e49bf4e34d0b0f2c";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script xmlns="" async="async">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script></body></html>