<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>26.5. manifests</title><link rel="stylesheet" type="text/css" href="../../docbook.css" /><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot" /><meta name="keywords" content="&#10;svn, svnauthz-validate, svnlook,svn-populate-node-origins-index, svnsync, svnadmin, svndumpfilter, svnmucc, svnserve, svnversion&#10;&#9;&#9;&#9;, &#10;git,git-add,git-add--interactive,git-am,git-annotate,git-apply,git-archive,git-bisect,git-bisect--helper,git-blame,git-branch,git-bundle,git-cat-file,git-check-attr,git-checkout,git-checkout-index,git-check-ref-format,git-cherry,git-cherry-pick,git-clean,git-clone,git-commit,git-commit-tree,git-config,git-count-objects,git-daemon,git-describe,git-diff,git-diff-files,git-diff-index,git-difftool,git-difftool--helper,git-diff-tree,git-fast-export,git-fast-import,git-fetch,git-fetch-pack,git-filter-branch,git-fmt-merge-msg,git-for-each-ref,git-format-patch,git-fsck,git-fsck-objects,git-gc,git-get-tar-commit-id,git-grep,git-hash-object,git-help,git-http-backend,git-http-fetch,git-http-push,git-imap-send,git-index-pack,git-init,git-init-db,git-instaweb,git-log,git-lost-found,git-ls-files,git-ls-remote,git-ls-tree,git-mailinfo,git-mailsplit,git-merge,git-merge-base,git-merge-file,git-merge-index,git-merge-octopus,git-merge-one-file,git-merge-ours,git-merge-recursive,git-merge-resolve,git-merge-subtree,git-mergetool,git-mergetool--lib,git-merge-tree,git-mktag,git-mktree,git-mv,git-name-rev,git-notes,git-pack-objects,git-pack-redundant,git-pack-refs,git-parse-remote,git-patch-id,git-peek-remote,git-prune,git-prune-packed,git-pull,git-push,git-quiltimport,git-read-tree,git-rebase,git-rebase--interactive,git-receive-pack,git-reflog,git-relink,git-remote,git-remote-ftp,git-remote-ftps,git-remote-http,git-remote-https,git-remote-testgit,git-repack,git-replace,git-repo-config,git-request-pull,git-rerere,git-reset,git-revert,git-rev-list,git-rev-parse,git-rm,git-send-pack,git-shell,git-shortlog,git-show,git-show-branch,git-show-index,git-show-ref,git-sh-setup,git-stage,git-stash,git-status,git-stripspace,git-submodule,git-symbolic-ref,git-tag,git-tar-tree,git-unpack-file,git-unpack-objects,git-update-index,git-update-ref,git-update-server-info,git-upload-archive,git-upload-pack,git-var,git-verify-pack,git-verify-tag,git-web--browse,git-whatchanged,git-write-tree&#10;&#9;&#9;&#9;" /><link rel="home" href="../../index.html" title="Netkiller DevOps 手札" /><link rel="up" href="index.html" title="第 26 章 Puppet" /><link rel="prev" href="config.html" title="26.4. 配置文件" /><link rel="next" href="modules.html" title="26.6. modules" /></head><body><a xmlns="" href="//www.netkiller.cn/">Home</a> |
		<a xmlns="" href="//netkiller.github.io/">简体中文</a> |
	    <a xmlns="" href="http://netkiller.sourceforge.net/">繁体中文</a> |
	    <a xmlns="" href="/journal/index.html">杂文</a> |
	    <a xmlns="" href="https://github.com/netkiller">Github</a> |
	    <a xmlns="" href="https://zhuanlan.zhihu.com/netkiller">知乎专栏</a> |
   	    <a xmlns="" href="https://edu.51cto.com/lecturer/1703915.html">51CTO学院</a> |
	    <a xmlns="" href="https://edu.csdn.net/lecturer/6423">CSDN程序员研修院</a> |
	    <a xmlns="" href="http://my.oschina.net/neochen/">OSChina 博客</a> |
	    <a xmlns="" href="https://cloud.tencent.com/developer/column/2078">腾讯云社区</a> |
	    <a xmlns="" href="https://yq.aliyun.com/u/netkiller/">阿里云栖社区</a> |
	    <a xmlns="" href="https://www.facebook.com/bg7nyt">Facebook</a> |
	    <a xmlns="" href="http://cn.linkedin.com/in/netkiller/">Linkedin</a> |
	    <a xmlns="" href="https://www.youtube.com/user/bg7nyt/videos">Youtube</a> |
	    <a xmlns="" href="//www.netkiller.cn/home/donations.html">打赏(Donations)</a> |
	    <a xmlns="" href="//www.netkiller.cn/home/about.html">About</a><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">26.5. manifests</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="config.html">上一页</a> </td><th width="60%" align="center">第 26 章 Puppet</th><td width="20%" align="right"> <a accesskey="n" href="modules.html">下一页</a></td></tr></table><hr /></div><table xmlns=""><tr><td><iframe src="//ghbtns.com/github-btn.html?user=netkiller&amp;repo=netkiller.github.io&amp;type=watch&amp;count=true&amp;size=large" height="30" width="170" frameborder="0" scrolling="0" style="width:170px; height: 30px;" allowTransparency="true"></iframe></td><td><iframe src="//ghbtns.com/github-btn.html?user=netkiller&amp;repo=netkiller.github.io&amp;type=fork&amp;count=true&amp;size=large" height="30" width="170" frameborder="0" scrolling="0" style="width:170px; height: 30px;" allowTransparency="true"></iframe></td><td><iframe src="//ghbtns.com/github-btn.html?user=netkiller&amp;type=follow&amp;count=true&amp;size=large" height="30" width="240" frameborder="0" scrolling="0" style="width:240px; height: 30px;" allowTransparency="true"></iframe></td><td></td><td><a href="https://zhuanlan.zhihu.com/netkiller"><img src="/images/logo/zhihu-card-default.svg" height="25" /></a></td><td valign="middle"><a href="https://zhuanlan.zhihu.com/netkiller">知乎专栏</a> ｜ <a href="https://www.zhihu.com/club/1241768772601950208">多维度架构</a></td><td></td><td></td><td></td><td></td></tr></table><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="manifests"></a>26.5. manifests</h2></div></div></div>
		
		<p>http://docs.puppetlabs.com/learning/</p>
		<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="idm369828737824"></a>26.5.1. node</h3></div></div></div>
			
			<p>default 针对所有节点</p>
			<pre class="screen">
node default {
	file {
    	"/tmp/helloworld.txt": content =&gt; "hello, world";
	}
}
			</pre>
			<pre class="screen">
# cat /etc/puppet/manifests/site.pp
node default {
	file {
		"/tmp/puppettest1.txt":
			content =&gt; "hello,first puppet manifest";
	}
}
			</pre>
			<p>指定节点</p>
			<pre class="screen">
# cat /etc/puppet/manifests/test.pp
node www {
    file { "/var/www/index.html":
        source =&gt; "/tmp/something",
        mode   =&gt; 666;
    }
}
			</pre>
			<p>多个节点</p>
			<pre class="screen">
node 'www','images' {
	...
	...
}
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="idm369828733792"></a>26.5.2. group, user 用户组管理</h3></div></div></div>
			
			<p><a class="ulink" href="http://docs.puppetlabs.com/references/latest/type.html#user" target="_top">http://docs.puppetlabs.com/references/latest/type.html#user</a></p>
			<p><a class="ulink" href="http://docs.puppetlabs.com/references/latest/type.html#group" target="_top">http://docs.puppetlabs.com/references/latest/type.html#group</a></p>
			<p>如果没有指定name的话就会建立和资源名一样的用户名/组名，如果指定了name就以name指定的用户名/组名为主</p>
			<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm369828731856"></a>26.5.2.1. group</h4></div></div></div>
				
				<p>用户组的添加</p>
				<pre class="screen">
node 'node1.example.com' {
#为该节点添加一个名字为test的组，并设置组ID为1000，如果不指定name的值，所创建的用户就为web。
	group { "web":
        ensure =&gt; "present",
        gid =&gt; 1000,
        name =&gt; "test";
        }
#为该节点添加一个httpd的组，并且设置ID和web一样
	group { "httpd":
        ensure =&gt; "present",
        gid =&gt; 1000,
        allowdupe =&gt; true;
        }
#为该节点删除一个apache的组。
	group { "apache":
        ensure =&gt; "absent",
        }
}
				</pre>
				<p>用户组的删除</p>
				<pre class="screen">
node 'node1.example.com' {
#为该节点删除一个web的组。
	group { "web":
        ensure =&gt; "absent",
        }
}
				</pre>
			</div>
			<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm369828727776"></a>26.5.2.2. user</h4></div></div></div>
				
				<p>用户的添加</p>
				<pre class="screen">
#创建一个用户并且密码为空
user {"svn":
        ensure =&gt; "present",
        shell =&gt; "/sbin/nologin";
}

#创建一个www用户，设置用户描述为webmaster,shell为bash，
user {"www":
        ensure =&gt; "present",
        comment =&gt; "webmaster user",
        name =&gt; "www",
        shell =&gt; "/sbin/bash";
}

#创建一个gid为80的用户组：
group { "www":
        ensure =&gt; "present",
        gid =&gt; 80,
        }
				</pre>
				<p>用户的删除</p>
				<pre class="screen">
user { "neo":
    ensure =&gt; "absent",
}
				</pre>
				<p>创建用户并指定密码</p>
				<p>生成密码</p>
				<pre class="screen">
# grub-md5-crypt
Password:
Retype password:
$1$ZlJ1u0$tdv/dr8pYuHh.eT47F6b70
				</pre>
				<pre class="screen">
user { "www":
    ensure =&gt; "present",
    uid =&gt; 80,
    gid =&gt; 80,
    home =&gt; "/var/www",
    shell =&gt; "/bin/bash",
    managehome =&gt; true,
 	password =&gt; '$1$ZlJ1u0$tdv/dr8pYuHh.eT47F6b70';
}

file {"/var/www":
        group =&gt; 80,
        owner =&gt; 80,
        mode =&gt; 700,
        ensure =&gt; directory;
}
				</pre>
			</div>
		</div>
		<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="idm369828722768"></a>26.5.3. file</h3></div></div></div>
			
			<pre class="screen">
file { "/var/www/my/file":
    source =&gt; "/path/in/nfs/or/something",
    mode   =&gt; 666;
}
			</pre>

 			<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm369828721584"></a>26.5.3.1. ensure</h4></div></div></div>
 				
				<pre class="screen">
ensure =&gt; absent; 	#absent是检测文件是否存在，如果存在则删除
ensure =&gt; present; 	#present正好相反，如果不存在则创建
ensure =&gt; directory; #创建一个目录的方法
force = &gt; true; 	#删除一个目录必须加上这个参数
source =&gt; "PATH"; 	#指定数据来源
backup =&gt; ".backup_$uptime_seconds"; 覆盖前备份文件
				</pre>
  				<p>创建目录实例</p>
 				<pre class="screen">
file { "/tmp/cache":
  owner =&gt; "www",
  group =&gt; "www",
  mode =&gt; 700,
  ensure =&gt; directory;
}
 				</pre>
 			</div>
			<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm369828718896"></a>26.5.3.2. source</h4></div></div></div>
				
				<p>source 表示 agent节点上的目录</p>
				<pre class="screen">
node www {
    file { "/var/www":
        owner =&gt; "nginx",
        group =&gt; "nginx",
        mode =&gt; 700,
        ensure =&gt; directory;
    }

    file { "/var/www/index.html":
        source =&gt; "/tmp/something",
        mode   =&gt; 666;
    }
}
				</pre>
				<p>从master上获取文件</p>
				<p>fileserver.conf 配置如下</p>
				<pre class="screen">
[files]
path /var/lib/puppet/files
allow *
				</pre>
				<p>site.pp配置如下</p>
				<pre class="screen">
file { "/tmp/test.txt":
        source  =&gt; "puppet://puppet.example.com/files/test.txt",
    }
				</pre>
				<p>此处的files为fileserver.conf中定义模块</p>
			</div>
			<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idm369828714288"></a>26.5.3.3. owner, group, mode</h4></div></div></div>
				
				<pre class="screen">
file
{ "/opt/testfile":
	owner =&gt; "puppet",
	group =&gt; "puppet",
	mode =&gt; 777;
}
				</pre>
			</div>
		</div>
		<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="idm369828712992"></a>26.5.4. package</h3></div></div></div>
			
			<pre class="screen">
present, installed	安装包
absent，pureged		卸载包
			</pre>
			<pre class="screen">
# start
package {
       "dnsmasq":
               ensure =&gt; installed;
       }

file {
       "/etc/resolv.conf":
               require =&gt; Service["dnsmasq"],
               content =&gt; "nameserver 127.0.0.1\n";
       }
service {
       "dnsmasq":
               ensure =&gt; running,
               pattern =&gt; "dnsmasq" ,
               require =&gt; Package["dnsmasq"];
       }
# end
			</pre>
			<pre class="screen">
package {
	"httpd":
		ensure    =&gt; installed;    	安装httpd，或用present也表示安装
	["vim","vsftpd"]:
		ensure=&gt;absent;  			删除vim 和vsftpd软件，使用pureged表示彻底删除软件
}
			</pre>

			<pre class="screen">
$package_list = [ "screen", "strace", "sudo" ]
package { $package_list: ensure =&gt; "installed" }
			</pre>
			<pre class="screen">
package { "lamp":
	ensure =&gt; present,
	provider =&gt; rpm,
	source =&gt; "http://192.168.0.1/lamp.rpm";
}
			</pre>
		</div>

		<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="idm369828709200"></a>26.5.5. service</h3></div></div></div>
			
			<pre class="screen">
service { 'sshd':
      ensure     =&gt; running,
      enable     =&gt; true,
      hasrestart =&gt; true,
      hasstatus  =&gt; true,
      subscribe  =&gt; File['/etc/ssh/sshd_config'],
}
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="idm369828707776"></a>26.5.6. exec</h3></div></div></div>
			
			<pre class="screen">
exec { "creates file":
	cwd =&gt; "/tmp",  														#指定命令执行的目录。如果目录不存在，则命令执行失败。
	command =&gt; "/bin/echo helloworld &gt; /tmp/hello.txt",
	user =&gt; "root",
	path =&gt; "/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin";	#命令执行的搜索路径。如果path没有被定义，命令需要使用绝对路径。
}
			</pre>
			<pre class="screen">
exec { “/srv/puppet/shell/test.sh”:
    cwd =&gt; “/srv/puppet”,
    timeout =&gt; 7200,
    logoutput =&gt; on_failure,
    user =&gt; root,
    path =&gt; ["/sbin", "/usr/sbin", "/usr/local/sbin", "/usr/local/bin", "/usr/bin", "/bin", "/usr/local/java/jre/bin"],
    require =&gt; File["/srv/puppet/shell/test.sh"]
}
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="idm369828705344"></a>26.5.7. cron</h3></div></div></div>
			
			<pre class="screen">
cron{ ntpdate:
      command =&gt; "/usr/sbin/ntpdate 172.16.0.1",
      user =&gt; root,
      minute =&gt;'*/5',
      require =&gt; Package["crontabs"];
}
			</pre>
			<pre class="screen">
file { "/etc/cron.hourly/backup":
	mode =&gt; 755,
	owner =&gt; root,
	group =&gt; root,
	require =&gt; Package[mysql],
	content =&gt; template("db/backup.erb");
}
			</pre>
		</div>
	</div><div xmlns="" id="SOHUCS"></div><script xmlns="" charset="utf-8" type="text/javascript" src="https://cy-cdn.kuaizhan.com/upload/changyan.js"></script><script xmlns="" type="text/javascript">
window.changyan.api.config({
appid: 'cyvwjQUG3',
conf: 'prod_ef966242df3d8b5acb1e0ee9fc01cafe'
});
</script><script xmlns="" type="text/javascript" id="clustrmaps" src="//cdn.clustrmaps.com/map_v2.js?u=r5HG&amp;d=9mi5r_kkDC8uxG8HuY3p4-2qgeeVypAK9vMD-2P6BYM"></script><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="config.html">上一页</a> </td><td width="20%" align="center"><a accesskey="u" href="index.html">上一级</a></td><td width="40%" align="right"> <a accesskey="n" href="modules.html">下一页</a></td></tr><tr><td width="40%" align="left" valign="top">26.4. 配置文件 </td><td width="20%" align="center"><a accesskey="h" href="../../index.html">起始页</a></td><td width="40%" align="right" valign="top"> 26.6. modules</td></tr></table></div><script xmlns="">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-11694057-1', 'auto');
  ga('send', 'pageview');

</script><script xmlns="" async="async">
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?93967759a51cda79e49bf4e34d0b0f2c";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script xmlns="" async="async">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script></body></html>