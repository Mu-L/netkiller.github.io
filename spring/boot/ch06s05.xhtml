<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"><head><title>日志报警</title><link rel="stylesheet" type="text/css" href="../docbook.css"/><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot"/><meta name="keywords" content="Spring, Spring Boot, Spring Cloud, Spring Eureka, Spring Config"/><link rel="prev" href="ch06s04.xhtml" title="Log4j2 + Gelf + Logstash"/><link rel="next" href="ch06s06.xhtml" title="Spring boot with ELK(Elasticsearch + Logstash + Kibana)"/></head><body><header><div class="navheader"><table style="width: 100%; "><tr><th style="text-align: center; " colspan="3">日志报警</th></tr><tr><td style="width: 20%; text-align: left; "><a accesskey="p" href="ch06s04.xhtml">上一页</a> </td><th style="width: 60%; text-align: center; ">第 6 章 Spring boot with Logging</th><td style="width: 20%; text-align: right; "> <a accesskey="n" href="ch06s06.xhtml">下一页</a></td></tr></table><hr/></div></header><section class="section" id="logging.dingtalk"><div class="titlepage"><div><div><h3 class="title">日志报警</h3></div></div></div><section class="section" id="id821"><div class="titlepage"><div><div><h4 class="title">Logstash 配置</h4></div></div></div><p>将 ERROR 和 WARN 级别的日志发送到钉钉群</p><pre class="screen">
			 
[root@netkiller ~]# cat /etc/logstash/conf.d/file.conf 
input {
	tcp {
	port =&gt; 4567 
	codec =&gt; json_lines
	}
	gelf {
	port =&gt; 12201
	use_udp =&gt; true
	#use_tcp =&gt; true
	}
}

filter {
	ruby {
		code =&gt; "event.set('datetime', event.get('@timestamp').time.localtime.strftime('%Y-%m-%d %H:%M:%S'))"
	}
}

output {

	file {
		path =&gt; "/opt/log/%{marker}.%{+yyyy}-%{+MM}-%{+dd}.log"
		codec =&gt; line { format =&gt; "[%{datetime}] %{level} %{message}"}
	}
	
	file {
		path =&gt; "/opt/log/origin.%{+yyyy}-%{+MM}-%{+dd}.log.gz"
		codec =&gt; json_lines
		gzip =&gt; true
	}
	if "ERROR" in [level] or "WARN" in [level] {
		http {
			url =&gt; "https://oapi.dingtalk.com/robot/send?access_token=56c27cb734a56cf549f6977ecc2761c4a16473db02d9d2881d008f9a239ba3e0"
			http_method =&gt; "post"
			content_type =&gt; "application/json; charset=utf-8"
			format =&gt; "message"
			message =&gt; '{"msgtype":"text","text":{"content":"Monitor: %{host}  - %{message}"}}'
		}
	}
}			
			
			</pre></section><section class="section" id="id822"><div class="titlepage"><div><div><h4 class="title">监控 SpringBootApplication 的启动和退出</h4></div></div></div><pre class="screen">
			 
neo@MacBook-Pro-M2 ~ % cat workspace/bottleneck/src/main/java/cn/netkiller/Application.java 
package cn.netkiller;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.slf4j.MarkerFactory;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;

import jakarta.annotation.PostConstruct;
import jakarta.annotation.PreDestroy;

@EnableDiscoveryClient
@SpringBootApplication
public class Application {
	private static final Logger logger = LoggerFactory.getLogger(Application.class);

	@PostConstruct
	public void init() {
		System.out.printf("==================== init ====================");
		logger.warn(MarkerFactory.getMarker("finance"), "XXX 系统启动");
	}

	@PreDestroy
	public void destroy() {
		System.out.printf("==================== destroy ====================");
		logger.error(MarkerFactory.getMarker("finance"), "XXX 系统销毁");
	}

	public static void main(String[] args) {
		System.out.println("Netkiller bottleneck tool!");
		SpringApplication.run(Application.class, args);
	}
}
			
			
			</pre><p>@PostConstruct 可以监控 启动情况</p><p>@PreDestroy 可以监控 退出情况</p></section></section><footer><div class="navfooter"><hr/><table style="width: 100%; "><tr><td style="width: 40%; text-align: left; "><a accesskey="p" href="ch06s04.xhtml">上一页</a> </td><td style="width: 20%; text-align: center; "><a accesskey="u" href="ch06.xhtml">上一级</a></td><td style="width: 40%; text-align: right; "> <a accesskey="n" href="ch06s06.xhtml">下一页</a></td></tr><tr><td style="width: 40%; text-align: left; vertical-align: top; ">Log4j2 + Gelf + Logstash </td><td style="width: 20%; text-align: center; "><a accesskey="h" href="../index.xhtml">起始页</a></td><td style="width: 40%; text-align: right; vertical-align: top; "> Spring boot with ELK(Elasticsearch + Logstash + Kibana)</td></tr></table></div></footer></body></html>